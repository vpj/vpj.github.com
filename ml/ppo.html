<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <title>Proximal Policy Optimization - PPO in PyTorch</title>
    <link href="http://fonts.googleapis.com/css?family=Raleway:400,100,200,300,500,600,700,800,900"
          rel="stylesheet"
          type="text/css"/>
    <link rel="stylesheet" href="lab/pylit.css">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-44255805-1', 'auto');
    ga('send', 'pageview');
  </script>
</head>
<body>
<div id='container'>
    <div id="background"></div>
    <div class='section'>
        <div class='docs'><h1>Proximal Policy Optimization - PPO in PyTorch</h1>
            </div></div>
    <div class='section' id='section-0'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-0'>#</a>
                </div>
                <p>This is a minimalistic implementation of <a href="https://arxiv.org/abs/1707.06347">Proximal Policy Optimization - PPO</a>
 clipped version for Atari Breakout game on OpenAI Gym.
This has less than 250 lines of code.
It runs the game environments on multiple processes to sample efficiently.
Advantages are calculated using <a href="https://arxiv.org/abs/1506.02438">Generalized Advantage Estimation</a>.</p>
<p><strong>The code for this tutorial is available at
<a href="https://github.com/lab-ml/rl_samples">Github labml/rl_samples</a>.</strong>
And the web version of the tutorial is available
<a href="http://blog.varunajayasiri.com/ml/ppo_pytorch.html">on my blog</a>.</p>
<p>If someone reading this has any questions or comments
 please find me on Twitter, <strong><a href="https://twitter.com/vpj">@vpj</a></strong>.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">multiprocessing.connection</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">labml</span> <span class="kn">import</span> <span class="n">monit</span><span class="p">,</span> <span class="n">tracker</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">experiment</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="nn">torch.distributions</span> <span class="kn">import</span> <span class="n">Categorical</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>

<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:1&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-1'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-1'>#</a>
                </div>
                <h2><a name="game-environment"></a>Game environment</h2>
<p>This is a wrapper for OpenAI gym game environment.
We do a few things here:</p>
<ol>
<li>Apply the same action on four frames and get the last frame</li>
<li>Convert observation frames to gray and scale it to (84, 84)</li>
<li>Stack four frames of the last four actions</li>
<li>Add episode information (total reward for the entire episode) for monitoring</li>
<li>Restrict an episode to a single life (game has 5 lives, we reset after every single life)</li>
</ol>
<h4>Observation format</h4>
<p>Observation is tensor of size (4, 84, 84). It is four frames
(images of the game screen) stacked on first axis.
i.e, each channel is a frame.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="k">class</span> <span class="nc">Game</span><span class="p">:</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-2'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-2'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-3'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-3'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-4'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-4'>#</a>
                </div>
                <p>create environment</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;BreakoutNoFrameskip-v4&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-5'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-5'>#</a>
                </div>
                <p>tensor for a stack of 4 frames</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">obs_4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">84</span><span class="p">))</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-6'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-6'>#</a>
                </div>
                <p>keep track of the episode rewards</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-7'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-7'>#</a>
                </div>
                <p>and number of lives left</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">lives</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-8'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-8'>#</a>
                </div>
                <h3>Step</h3>
<p>Executes <code>action</code> for 4 time steps and
 returns a tuple of (observation, reward, done, episode_info).</p>
<ul>
<li><code>observation</code>: stacked 4 frames (this frame and frames for last 3 actions)</li>
<li><code>reward</code>: total reward while the action was executed</li>
<li><code>done</code>: whether the episode finished (a life lost)</li>
<li><code>episode_info</code>: episode information if completed</li>
</ul>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-9'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-9'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">reward</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">None</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-10'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-10'>#</a>
                </div>
                <p>run for 4 steps</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-11'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-11'>#</a>
                </div>
                <p>execute the action in the OpenAI Gym environment</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="n">obs</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

            <span class="n">reward</span> <span class="o">+=</span> <span class="n">r</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-12'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-12'>#</a>
                </div>
                <p>get number of lives left</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="n">lives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">unwrapped</span><span class="o">.</span><span class="n">ale</span><span class="o">.</span><span class="n">lives</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-13'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-13'>#</a>
                </div>
                <p>reset if a life is lost</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="k">if</span> <span class="n">lives</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lives</span><span class="p">:</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-14'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-14'>#</a>
                </div>
                <p>Transform the last observation to (84, 84)</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_obs</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-15'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-15'>#</a>
                </div>
                <p>maintain rewards for each step</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reward</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">done</span><span class="p">:</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-16'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-16'>#</a>
                </div>
                <p>if finished, set episode information if episode is over, and reset</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="n">episode_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rewards</span><span class="p">),</span> <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rewards</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">episode_info</span> <span class="o">=</span> <span class="kc">None</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-17'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-17'>#</a>
                </div>
                <p>get the max of last two frames
obs = self.obs_2_max.max(axis=0)</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-18'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-18'>#</a>
                </div>
                <p>push it to the stack of 4 frames</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">obs_4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_4</span><span class="p">,</span> <span class="n">shift</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs_4</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_4</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">episode_info</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-19'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-19'>#</a>
                </div>
                <h3>Reset environment</h3>
<p>Clean up episode info and 4 frame stack</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-20'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-20'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-21'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-21'>#</a>
                </div>
                <p>reset OpenAI Gym environment</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-22'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-22'>#</a>
                </div>
                <p>reset caches</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_obs</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs_4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">unwrapped</span><span class="o">.</span><span class="n">ale</span><span class="o">.</span><span class="n">lives</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_4</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-23'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-23'>#</a>
                </div>
                <h4>Process game frames</h4>
<p>Convert game frames to gray and rescale to 84x84</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_process_obs</span><span class="p">(</span><span class="n">obs</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-24'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-24'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">obs</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2GRAY</span><span class="p">)</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">84</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obs</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-25'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-25'>#</a>
                </div>
                <h2>Worker Process</h2>
<p>Each worker process runs this method</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="k">def</span> <span class="nf">worker_process</span><span class="p">(</span><span class="n">remote</span><span class="p">:</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-26'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-26'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-27'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-27'>#</a>
                </div>
                <p>create game</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="n">game</span> <span class="o">=</span> <span class="n">Game</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-28'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-28'>#</a>
                </div>
                <p>wait for instructions from the connection and execute them</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">remote</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;step&quot;</span><span class="p">:</span>
            <span class="n">remote</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;reset&quot;</span><span class="p">:</span>
            <span class="n">remote</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">reset</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">&quot;close&quot;</span><span class="p">:</span>
            <span class="n">remote</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-29'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-29'>#</a>
                </div>
                <p>Creates a new worker and runs it in a separate process.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="k">class</span> <span class="nc">Worker</span><span class="p">:</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-30'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-30'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-31'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-31'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">child</span><span class="p">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pipe</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker_process</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">seed</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-32'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-32'>#</a>
                </div>
                <h2>Model</h2>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-33'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-33'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-34'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-34'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-35'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-35'>#</a>
                </div>
                <p>The first convolution layer takes a
84x84 frame and produces a 20x20 frame</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-36'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-36'>#</a>
                </div>
                <p>The second convolution layer takes a
20x20 frame and produces a 9x9 frame</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-37'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-37'>#</a>
                </div>
                <p>The third convolution layer takes a
9x9 frame and produces a 7x7 frame</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-38'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-38'>#</a>
                </div>
                <p>A fully connected layer takes the flattened
frame from third convolution layer, and outputs
512 features</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">lin</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">7</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">64</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-39'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-39'>#</a>
                </div>
                <p>A fully connected layer to get logits for $\pi$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">pi_logits</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-40'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-40'>#</a>
                </div>
                <p>A fully connected layer to get value function</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-41'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-41'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">obs</span><span class="p">))</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">64</span><span class="p">))</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lin</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>

        <span class="n">pi</span> <span class="o">=</span> <span class="n">Categorical</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pi_logits</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pi</span><span class="p">,</span> <span class="n">value</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-42'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-42'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="k">def</span> <span class="nf">obs_to_torch</span><span class="p">(</span><span class="n">obs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-43'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-43'>#</a>
                </div>
                <p>scale to <code>[0, 1]</code></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-44'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-44'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="k">class</span> <span class="nc">Main</span><span class="p">:</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-45'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-45'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-46'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-46'>#</a>
                </div>
                <h4>Configurations</h4>
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-47'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-47'>#</a>
                </div>
                <p>$\gamma$ and $\lambda$ for advantage calculation</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.99</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lamda</span> <span class="o">=</span> <span class="mf">0.95</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-48'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-48'>#</a>
                </div>
                <p>number of updates</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">updates</span> <span class="o">=</span> <span class="mi">10000</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-49'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-49'>#</a>
                </div>
                <p>number of epochs to train the model with sampled data</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">4</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-50'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-50'>#</a>
                </div>
                <p>number of worker processes</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span> <span class="o">=</span> <span class="mi">8</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-51'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-51'>#</a>
                </div>
                <p>number of steps to run on each process for a single update</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">worker_steps</span> <span class="o">=</span> <span class="mi">128</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-52'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-52'>#</a>
                </div>
                <p>number of mini batches</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">n_mini_batch</span> <span class="o">=</span> <span class="mi">4</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-53'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-53'>#</a>
                </div>
                <p>total number of samples for a single update</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_steps</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-54'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-54'>#</a>
                </div>
                <p>size of a mini batch</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_mini_batch</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_mini_batch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-55'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-55'>#</a>
                </div>
                <h4>Initialize</h4>
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-56'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-56'>#</a>
                </div>
                <p>create workers</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">workers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Worker</span><span class="p">(</span><span class="mi">47</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span><span class="p">)]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-57'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-57'>#</a>
                </div>
                <p>initialize tensors for observations</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">84</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-58'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-58'>#</a>
                </div>
                <p>model for sampling</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-59'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-59'>#</a>
                </div>
                <p>optimizer</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">2.5e-4</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-60'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-60'>#</a>
                </div>
                <h3>Sample data with current policy</h3>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">List</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-61'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-61'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">rewards</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_steps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_steps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_steps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_steps</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">84</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">log_pis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_steps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_steps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-62'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-62'>#</a>
                </div>
                <p>sample <code>worker_steps</code> from each worker</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_steps</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-63'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-63'>#</a>
                </div>
                <p><code>self.obs</code> keeps track of the last observation from each worker,
 which is the input for the model to sample the next action</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>                <span class="n">obs</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-64'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-64'>#</a>
                </div>
                <p>sample actions from $\pi_{\theta_{OLD}}$ for each worker;
 this returns arrays of size <code>n_workers</code></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>                <span class="n">pi</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">obs_to_torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">))</span>
                <span class="n">values</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">pi</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
                <span class="n">actions</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">log_pis</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">pi</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-65'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-65'>#</a>
                </div>
                <p>run sampled actions on each worker</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">):</span>
                <span class="n">worker</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="n">actions</span><span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">t</span><span class="p">]))</span>

            <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-66'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-66'>#</a>
                </div>
                <p>get results after executing the actions</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>                <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">rewards</span><span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="n">done</span><span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="n">info</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-67'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-67'>#</a>
                </div>
                <p>collect episode info, which is available if an episode finished;
 this includes total reward and length of the episode -
 look at <code>Game</code> to see how it works.
We also add a game frame to it for monitoring.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>                <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                    <span class="n">tracker</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;reward&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">])</span>
                    <span class="n">tracker</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-68'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-68'>#</a>
                </div>
                <p>calculate advantages</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">advantages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_advantages</span><span class="p">(</span><span class="n">done</span><span class="p">,</span> <span class="n">rewards</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;obs&#39;</span><span class="p">:</span> <span class="n">obs</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="n">actions</span><span class="p">,</span>
            <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">,</span>
            <span class="s1">&#39;log_pis&#39;</span><span class="p">:</span> <span class="n">log_pis</span><span class="p">,</span>
            <span class="s1">&#39;advantages&#39;</span><span class="p">:</span> <span class="n">advantages</span>
        <span class="p">}</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-69'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-69'>#</a>
                </div>
                <p>samples are currently in [workers, time] table,
 we should flatten it</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">samples_flat</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;obs&#39;</span><span class="p">:</span>
                <span class="n">samples_flat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs_to_torch</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">samples_flat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">samples_flat</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-70'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-70'>#</a>
                </div>
                <h3>Calculate advantages</h3>
<p>
<script type="math/tex; mode=display">\begin{align}
\hat{A_t^{(1)}} &= r_t + \gamma V(s_{t+1}) - V(s)
\\
\hat{A_t^{(2)}} &= r_t + \gamma r_{t+1} +\gamma^2 V(s_{t+2}) - V(s)
\\
...
\\
\hat{A_t^{(\infty)}} &= r_t + \gamma r_{t+1} +\gamma^2 r_{t+1} + ... - V(s)
\end{align}</script>
</p>
<p>$\hat{A_t^{(1)}}$ is high bias, low variance whilst
$\hat{A_t^{(\infty)}}$ is unbiased, high variance.</p>
<p>We take a weighted average of $\hat{A_t^{(k)}}$ to balance bias and variance.
This is called Generalized Advantage Estimation.
<script type="math/tex; mode=display">\hat{A_t} = \hat{A_t^{GAE}} = \sum_k w_k \hat{A_t^{(k)}}</script>
We set $w_k = \lambda^{k-1}$, this gives clean calculation for
$\hat{A_t}$</p>
<p>
<script type="math/tex; mode=display">\begin{align}
\delta_t &= r_t + \gamma V(s_{t+1}) - V(s_t)$
\\
\hat{A_t} &= \delta_t + \gamma \lambda \delta_{t+1} + ... +
                     (\gamma \lambda)^{T - t + 1} \delta_{T - 1}$
\\
&= \delta_t + \gamma \lambda \hat{A_{t+1}}
\end{align}</script>
</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_calc_advantages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">done</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">rewards</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-71'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-71'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-72'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-72'>#</a>
                </div>
                <p>advantages table</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">advantages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_steps</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">last_advantage</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-73'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-73'>#</a>
                </div>
                <p>$V(s_{t+1})$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">_</span><span class="p">,</span> <span class="n">last_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">obs_to_torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">))</span>
        <span class="n">last_value</span> <span class="o">=</span> <span class="n">last_value</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_steps</span><span class="p">)):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-74'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-74'>#</a>
                </div>
                <p>mask if episode completed after step $t$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="n">mask</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">done</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span>
            <span class="n">last_value</span> <span class="o">=</span> <span class="n">last_value</span> <span class="o">*</span> <span class="n">mask</span>
            <span class="n">last_advantage</span> <span class="o">=</span> <span class="n">last_advantage</span> <span class="o">*</span> <span class="n">mask</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-75'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-75'>#</a>
                </div>
                <p>$\delta_t$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="n">delta</span> <span class="o">=</span> <span class="n">rewards</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">last_value</span> <span class="o">-</span> <span class="n">values</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-76'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-76'>#</a>
                </div>
                <p>$\hat{A_t} = \delta_t + \gamma \lambda \hat{A_{t+1}}$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="n">last_advantage</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamda</span> <span class="o">*</span> <span class="n">last_advantage</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-77'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-77'>#</a>
                </div>
                <p>note that we are collecting in reverse order.
<em>My initial code was appending to a list and
  I forgot to reverse it later.
It took me around 4 to 5 hours to find the bug.
The performance of the model was improving
 slightly during initial runs,
 probably because the samples are similar.</em></p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="n">advantages</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_advantage</span>

            <span class="n">last_value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">advantages</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-78'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-78'>#</a>
                </div>
                <h3>Train the model based on samples</h3>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">clip_range</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-79'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-79'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-80'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-80'>#</a>
                </div>
                <p>It learns faster with a higher number of epochs,
 but becomes a little unstable; that is,
 the average episode reward does not monotonically increase
 over time.
May be reducing the clipping range might solve it.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-81'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-81'>#</a>
                </div>
                <p>shuffle for each epoch</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="n">indexes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-82'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-82'>#</a>
                </div>
                <p>for each mini batch</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-83'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-83'>#</a>
                </div>
                <p>get mini batch</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>                <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span>
                <span class="n">mini_batch_indexes</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[</span><span class="n">start</span><span class="p">:</span> <span class="n">end</span><span class="p">]</span>
                <span class="n">mini_batch</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">samples</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">mini_batch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">mini_batch_indexes</span><span class="p">]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-84'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-84'>#</a>
                </div>
                <p>train</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_loss</span><span class="p">(</span><span class="n">clip_range</span><span class="o">=</span><span class="n">clip_range</span><span class="p">,</span>
                                       <span class="n">samples</span><span class="o">=</span><span class="n">mini_batch</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-85'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-85'>#</a>
                </div>
                <p>compute gradients</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>                <span class="k">for</span> <span class="n">pg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span>
                    <span class="n">pg</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learning_rate</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-86'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-86'>#</a>
                </div>
                <h4>Normalize advantage function</h4>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_normalize</span><span class="p">(</span><span class="n">adv</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-87'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-87'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="k">return</span> <span class="p">(</span><span class="n">adv</span> <span class="o">-</span> <span class="n">adv</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">adv</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-88'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-88'>#</a>
                </div>
                <h2>PPO Loss</h2>
<p>We want to maximize policy reward
 <script type="math/tex; mode=display">\max_\theta J(\pi_\theta) =
   \mathop{\mathbb{E}}_{\tau \sim \pi_\theta}\Biggl[\sum_{t=0}^\infty \gamma^t r_t \Biggr]</script>
 where $r$ is the reward, $\pi$ is the policy, $\tau$ is a trajectory sampled from policy,
 and $\gamma$ is the discount factor between $[0, 1]$.</p>
<p>
<script type="math/tex; mode=display">\begin{align}
\mathbb{E}_{\tau \sim \pi_\theta} \Biggl[
 \sum_{t=0}^\infty \gamma^t A^{\pi_{OLD}}(s_t, a_t)
\Biggr] &=
\\
\mathbb{E}_{\tau \sim \pi_\theta} \Biggl[
  \sum_{t=0}^\infty \gamma^t \Bigl(
   Q^{\pi_{OLD}}(s_t, a_t) - V^{\pi_{OLD}}(s_t)
  \Bigr)
 \Biggr] &=
\\
\mathbb{E}_{\tau \sim \pi_\theta} \Biggl[
  \sum_{t=0}^\infty \gamma^t \Bigl(
   r_t + V^{\pi_{OLD}}(s_{t+1}) - V^{\pi_{OLD}}(s_t)
  \Bigr)
 \Biggr] &=
\\
\mathbb{E}_{\tau \sim \pi_\theta} \Biggl[
  \sum_{t=0}^\infty \gamma^t \Bigl(
   r_t
  \Bigr)
 \Biggr]
 - \mathbb{E}_{\tau \sim \pi_\theta}
    \Biggl[V^{\pi_{OLD}}(s_0)\Biggr] &=
J(\pi_\theta) - J(\pi_{\theta_{OLD}})
\end{align}</script>
</p>
<p>So,
 <script type="math/tex; mode=display">\max_\theta J(\pi_\theta) =
   \max_\theta \mathbb{E}_{\tau \sim \pi_\theta} \Biggl[
      \sum_{t=0}^\infty \gamma^t A^{\pi_{OLD}}(s_t, a_t)
   \Biggr]</script>
</p>
<p>Define discounted-future state distribution,
 <script type="math/tex; mode=display">d^\pi(s) = (1 - \gamma) \sum_{t=0}^\infty \gamma^t P(s_t = s | \pi)</script>
</p>
<p>Then,
<script type="math/tex; mode=display">\begin{align}
J(\pi_\theta) - J(\pi_{\theta_{OLD}})
&= \mathbb{E}_{\tau \sim \pi_\theta} \Biggl[
 \sum_{t=0}^\infty \gamma^t A^{\pi_{OLD}}(s_t, a_t)
\Biggr]
\\
&= \frac{1}{1 - \gamma}
 \mathbb{E}_{s \sim d^{\pi_\theta}, a \sim \pi_\theta} \Bigl[
  A^{\pi_{OLD}}(s, a)
 \Bigr]
\end{align}</script>
</p>
<p>Importance sampling $a$ from $\pi_{\theta_{OLD}}$,</p>
<p>
<script type="math/tex; mode=display">\begin{align}
J(\pi_\theta) - J(\pi_{\theta_{OLD}})
&= \frac{1}{1 - \gamma}
 \mathbb{E}_{s \sim d^{\pi_\theta}, a \sim \pi_\theta} \Bigl[
  A^{\pi_{OLD}}(s, a)
 \Bigr]
\\
&= \frac{1}{1 - \gamma}
 \mathbb{E}_{s \sim d^{\pi_\theta}, a \sim \pi_{\theta_{OLD}}} \Biggl[
  \frac{\pi_\theta(a|s)}{\pi_{\theta_{OLD}}(a|s)} A^{\pi_{OLD}}(s, a)
 \Biggr]
\end{align}</script>
</p>
<p>Then we assume $d^\pi_\theta(s)$ and  $d^\pi_{\theta_{OLD}}(s)$ are similar.
The error we introduce to $J(\pi_\theta) - J(\pi_{\theta_{OLD}})$
 by this assumtion is bound by the KL divergence between
 $\pi_\theta$ and $\pi_{\theta_{OLD}}$.
<a href="https://arxiv.org/abs/1705.10528">Constrained Policy Optimization</a>
 shows the proof of this. I haven&rsquo;t read it.</p>
<p>
<script type="math/tex; mode=display">\begin{align}
J(\pi_\theta) - J(\pi_{\theta_{OLD}})
&= \frac{1}{1 - \gamma}
 \mathop{\mathbb{E}}_{s \sim d^{\pi_\theta} \atop a \sim \pi_{\theta_{OLD}}} \Biggl[
  \frac{\pi_\theta(a|s)}{\pi_{\theta_{OLD}}(a|s)} A^{\pi_{OLD}}(s, a)
 \Biggr]
\\
&\approx \frac{1}{1 - \gamma}
 \mathop{\mathbb{E}}_{\color{orange}{s \sim d^{\pi_{\theta_{OLD}}}}
 \atop a \sim \pi_{\theta_{OLD}}} \Biggl[
  \frac{\pi_\theta(a|s)}{\pi_{\theta_{OLD}}(a|s)} A^{\pi_{OLD}}(s, a)
 \Biggr]
\\
&= \frac{1}{1 - \gamma} \mathcal{L}^{CPI}
\end{align}</script>
</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_calc_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">clip_range</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-89'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-89'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-90'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-90'>#</a>
                </div>
                <p>$R_t$ returns sampled from $\pi_{\theta_{OLD}}$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">sampled_return</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;advantages&#39;</span><span class="p">]</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-91'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-91'>#</a>
                </div>
                <p>$\bar{A_t} = \frac{\hat{A_t} - \mu(\hat{A_t})}{\sigma(\hat{A_t})}$,
where $\hat{A_t}$ is advantages sampled from $\pi_{\theta_{OLD}}$.
Refer to sampling function in <a href="#main">Main class</a> below
 for the calculation of $\hat{A}_t$.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">sampled_normalized_advantage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;advantages&#39;</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-92'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-92'>#</a>
                </div>
                <p>Sampled observations are fed into the model to get $\pi_\theta(a_t|s_t)$ and $V^{\pi_\theta}(s_t)$;
 we are treating observations as state</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">pi</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-93'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-93'>#</a>
                </div>
                <h4>Policy</h4>
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-94'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-94'>#</a>
                </div>
                <p>$-\log \pi_\theta (a_t|s_t)$, $a_t$ are actions sampled from $\pi_{\theta_{OLD}}$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">log_pi</span> <span class="o">=</span> <span class="n">pi</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-95'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-95'>#</a>
                </div>
                <p>ratio $r_t(\theta) = \frac{\pi_\theta (a_t|s_t)}{\pi_{\theta_{OLD}} (a_t|s_t)}$;
<em>this is different from rewards</em> $r_t$.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">ratio</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_pi</span> <span class="o">-</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;log_pis&#39;</span><span class="p">])</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-96'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-96'>#</a>
                </div>
                <p>
<script type="math/tex; mode=display">\begin{align}
\mathcal{L}^{CLIP}(\theta) =
 \mathbb{E}_{a_t, s_t \sim \pi_{\theta{OLD}}} \biggl[
   min \Bigl(r_t(\theta) \bar{A_t},
             clip \bigl(
              r_t(\theta), 1 - \epsilon, 1 + \epsilon
             \bigr) \bar{A_t}
   \Bigr)
 \biggr]
\end{align}</script>
</p>
<p>The ratio is clipped to be close to 1.
We take the minimum so that the gradient will only pull
$\pi_\theta$ towards $\pi_{\theta_{OLD}}$ if the ratio is
not between $1 - \epsilon$ and $1 + \epsilon$.
This keeps the KL divergence between $\pi_\theta$
 and $\pi_{\theta_{OLD}}$ constrained.
Large deviation can cause performance collapse;
 where the policy performance drops and doesn&rsquo;t recover because
 we are sampling from a bad policy.</p>
<p>Using the normalized advantage
 $\bar{A_t} = \frac{\hat{A_t} - \mu(\hat{A_t})}{\sigma(\hat{A_t})}$
 introduces a bias to the policy gradient estimator,
 but it reduces variance a lot.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">clipped_ratio</span> <span class="o">=</span> <span class="n">ratio</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">clip_range</span><span class="p">,</span>
                                    <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">clip_range</span><span class="p">)</span>
        <span class="n">policy_reward</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">sampled_normalized_advantage</span><span class="p">,</span>
                                  <span class="n">clipped_ratio</span> <span class="o">*</span> <span class="n">sampled_normalized_advantage</span><span class="p">)</span>
        <span class="n">policy_reward</span> <span class="o">=</span> <span class="n">policy_reward</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-97'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-97'>#</a>
                </div>
                <h4>Entropy Bonus</h4>
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-98'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-98'>#</a>
                </div>
                <p>$\mathcal{L}^{EB}(\theta) =
 \mathbb{E}\Bigl[ S\bigl[\pi_\theta\bigr] (s_t) \Bigr]$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">entropy_bonus</span> <span class="o">=</span> <span class="n">pi</span><span class="o">.</span><span class="n">entropy</span><span class="p">()</span>
        <span class="n">entropy_bonus</span> <span class="o">=</span> <span class="n">entropy_bonus</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-99'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-99'>#</a>
                </div>
                <h4>Value</h4>
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-100'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-100'>#</a>
                </div>
                <p>
<script type="math/tex; mode=display">\begin{align}
V^{\pi_\theta}_{CLIP}(s_t)
 &= clip\Bigl(V^{\pi_\theta}(s_t) - \hat{V_t}, -\epsilon, +\epsilon\Bigr)
\\
\mathcal{L}^{VF}(\theta)
 &= \frac{1}{2} \mathbb{E} \biggl[
  max\Bigl(\bigl(V^{\pi_\theta}(s_t) - R_t\bigr)^2,
      \bigl(V^{\pi_\theta}_{CLIP}(s_t) - R_t\bigr)^2\Bigr)
 \biggr]
\end{align}</script>
</p>
<p>Clipping makes sure the value function $V_\theta$ doesn&rsquo;t deviate
 significantly from $V_{\theta_{OLD}}$.</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">clipped_value</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=-</span><span class="n">clip_range</span><span class="p">,</span>
                                                                              <span class="nb">max</span><span class="o">=</span><span class="n">clip_range</span><span class="p">)</span>
        <span class="n">vf_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">value</span> <span class="o">-</span> <span class="n">sampled_return</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">clipped_value</span> <span class="o">-</span> <span class="n">sampled_return</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">vf_loss</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">vf_loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-101'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-101'>#</a>
                </div>
                <p>$\mathcal{L}^{CLIP+VF+EB} (\theta) =
 \mathcal{L}^{CLIP} (\theta) -
 c_1 \mathcal{L}^{VF} (\theta) + c_2 \mathcal{L}^{EB}(\theta)$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-102'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-102'>#</a>
                </div>
                <p>we want to maximize $\mathcal{L}^{CLIP+VF+EB}(\theta)$
so we take the negative of it as the loss</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">policy_reward</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">vf_loss</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">entropy_bonus</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-103'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-103'>#</a>
                </div>
                <p>for monitoring</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">approx_kl_divergence</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">((</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;log_pis&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_pi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">clip_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">ratio</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">clip_range</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">tracker</span><span class="o">.</span><span class="n">add</span><span class="p">({</span><span class="s1">&#39;policy_reward&#39;</span><span class="p">:</span> <span class="n">policy_reward</span><span class="p">,</span>
                     <span class="s1">&#39;vf_loss&#39;</span><span class="p">:</span> <span class="n">vf_loss</span><span class="p">,</span>
                     <span class="s1">&#39;entropy_bonus&#39;</span><span class="p">:</span> <span class="n">entropy_bonus</span><span class="p">,</span>
                     <span class="s1">&#39;kl_div&#39;</span><span class="p">:</span> <span class="n">approx_kl_divergence</span><span class="p">,</span>
                     <span class="s1">&#39;clip_fraction&#39;</span><span class="p">:</span> <span class="n">clip_fraction</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">loss</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-104'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-104'>#</a>
                </div>
                <h3>Run training loop</h3>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">run_training_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-105'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-105'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre></pre></div>
            </div>
        </div>
    <div class='section' id='section-106'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-106'>#</a>
                </div>
                <p>last 100 episode information</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="n">tracker</span><span class="o">.</span><span class="n">set_queue</span><span class="p">(</span><span class="s1">&#39;reward&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">set_queue</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">update</span> <span class="ow">in</span> <span class="n">monit</span><span class="o">.</span><span class="n">loop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">updates</span><span class="p">):</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">update</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">updates</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-107'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-107'>#</a>
                </div>
                <p>decreasing <code>learning_rate</code> and <code>clip_range</code> $\epsilon$</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">2.5e-4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">progress</span><span class="p">)</span>
            <span class="n">clip_range</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">progress</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-108'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-108'>#</a>
                </div>
                <p>sample with current policy</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-109'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-109'>#</a>
                </div>
                <p>train the model</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">clip_range</span><span class="p">)</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-110'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-110'>#</a>
                </div>
                <p>write summary info to the writer, and log to the screen</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>            <span class="n">tracker</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">update</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1_000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">()</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-111'>
        <div class='docs doc-strings'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-111'>#</a>
                </div>
                <h3>Destroy</h3>
<p>Stop the workers</p>
            </div>
            <div class='code'>
                <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-112'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-112'>#</a>
                </div>
                
            </div>
            <div class='code'>
                <div class="highlight"><pre>        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span></pre></div>
            </div>
        </div>
    <div class='section' id='section-113'>
            <div class='docs'>
                <div class='octowrap'>
                    <a class='octothorpe' href='#section-113'>#</a>
                </div>
                <h2>Run it</h2>
            </div>
            <div class='code'>
                <div class="highlight"><pre><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">experiment</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Main</span><span class="p">()</span>
    <span class="n">experiment</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">run_training_loop</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

</pre></div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML">
    </script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            displayMath: [ ['$$','$$'] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": { fonts: ["TeX"] }
    });

    </script>

</body>
