<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>Deep Q Learning</title>
<link href="http://fonts.googleapis.com/css?family=Raleway:400,100,200,300,500,600,700,800,900" rel="stylesheet" type="text/css"/>
  <link rel="stylesheet" href="pycco.css">
 <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-44255805-1', 'auto');
    ga('send', 'pageview');
  </script>

</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>Deep Q Learning</h1></div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>
<script type="math/tex">
   \def\hl1#1{{\color{orange}{#1}}}
   \def\blue#1{{\color{cyan}{#1}}}
   \def\green#1{{\color{yellowgreen}{#1}}}
</script>
</p>
<p>This is a Deep Q Learning implementation with:
<em> Double Q Network
</em> Dueling Network
* Prioritized Replay</p>
<p>It is based on <a href="https://github.com/openai/baselines">OpenAI Baselines</a> implementation.
I have taken some inspiration from
 <a href="https://github.com/berkeleydeeprlcourse/homework">Berkley Deep RL Course</a> too.</p>
<p>It&rsquo;s hardcoded for Atari Breakout, and tested with TensorFlow 1.7</p>
<p>There are two imports:</p>
<ul>
<li><a href="util.html">util.py</a></li>
<li><a href="worker.html">worker.py</a></li>
</ul>
<p>I terminate episodes after one life is lost.
So the episode reward is total reward for a single life.</p>
<p>If someone reading this has any questions or comments
 please find me on Twitter,
 <strong><a href="https://twitter.com/vpj">@vpj</a></strong>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <h3>Imports</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span><span class="p">,</span> <span class="n">PurePath</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">util</span> <span class="kn">import</span> <span class="n">Orthogonal</span><span class="p">,</span> <span class="n">huber_loss</span><span class="p">,</span> <span class="n">PiecewiseSchedule</span>
<span class="kn">from</span> <span class="nn">worker</span> <span class="kn">import</span> <span class="n">Worker</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>I was using a computer with two GPUs and
 I wanted TensorFlow to use only one of them.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <h2><a name="model"></a>Neural Network Model for $Q$ Values</h2>
<h4>Dueling Network ⚔️</h4>
<p>We are using a <a href="https://arxiv.org/abs/1511.06581">dueling network</a>
 to calculate Q-values.
Intuition behind dueling network architure is that in most states
 the action doesn&rsquo;t matter,
and in some states the action is significant. Dueling network allows
 this to be represented very well.</p>
<p>
<script type="math/tex; mode=display">\begin{align}
    Q^\pi(s,a) &= V^\pi(s) + A^\pi(s, a)
    \\
    \mathop{\mathbb{E}}_{a \sim \pi(s)}
     \Big[
      A^\pi(s, a)
     \Big]
    &= 0
\end{align}</script>
</p>
<p>So we create two networks for $V$ and $A$ and get $Q$ from them.
<script type="math/tex; mode=display">
    Q(s, a) = V(s) +
    \Big(
        A(s, a) - \frac{1}{|\mathcal{A}|} \sum_{a' \in \mathcal{A}} A(s, a')
    \Big)
</script>
We share the initial layers of the $V$ and $A$ networks.</p>
<h4>$\epsilon$-greedy Sampling</h4>
<p>When sampling actions we use a $\epsilon$-greedy strategy, where we
take a greedy action with probabiliy $1 - \epsilon$ and
take a random action with probability $\epsilon$.
We refer to $\epsilon$ as <em>exploration</em>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <h3>Initialize</h3>
<p>We need <code>scope</code> because we need multiple copies of variables
 for target network and training network.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reuse</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">scaled_images</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>If scaled input is provided we use that, otherwise we
 process the observation from the game</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">scaled_images</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>observations input <code>(B, 84, 84, 4)</code></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                                      <span class="n">name</span><span class="o">=</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span>
                                      <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">obs_float</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">to_float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;obs_float&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>scale image values to [0, 1] from [0, 255]</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">scaled_images</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">obs_float</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaled_images</span> <span class="o">=</span> <span class="n">scaled_images</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>exploration, $\epsilon$, the probability of making a random action</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">exploration_fraction</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[],</span>
                                                   <span class="n">name</span><span class="o">=</span><span class="s2">&quot;epsilon&quot;</span><span class="p">,</span>
                                                   <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="n">reuse</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>flattened output of the convolution network</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s2">&quot;convolution_network&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">_cnn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaled_images</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>$A(s,a)$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s2">&quot;action_value&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_score</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">_create_action_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>$V(s)$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s2">&quot;state_value&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_score</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">_create_state_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>all trainable variables in this scope.
<em>I previously didn&rsquo;t indicate the scope and it took
all trainable variables.</em></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>$Q(s, a) =V(s) + \Big(A(s, a) - \frac{1}{|\mathcal{A}|} \sum_{a&rsquo; \in \mathcal{A}} A(s, a&rsquo;)\Big)$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">action_score_mean</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_score</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">action_score_centered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_score</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">action_score_mean</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_score</span> <span class="o">+</span> <span class="n">action_score_centered</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>greedy action</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">greedy_action</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>random action</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">random_action</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random_uniform</span><span class="p">([</span><span class="n">batch_size</span><span class="p">],</span> <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>choose random action with probability $\epsilon$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">random_uniform</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random_uniform</span><span class="p">([</span><span class="n">batch_size</span><span class="p">],</span>
                                           <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                           <span class="n">maxval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                           <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">is_choose_random</span> <span class="o">=</span> <span class="n">random_uniform</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploration_fraction</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>$\epsilon$-greedy action</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_choose_random</span><span class="p">,</span> <span class="n">random_action</span><span class="p">,</span> <span class="n">greedy_action</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <h4>Convolutional Neural Network</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_cnn</span><span class="p">(</span><span class="n">scaled_images</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>three convolution layers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">h1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">scaled_images</span><span class="p">,</span>
                              <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv1&quot;</span><span class="p">,</span>
                              <span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                              <span class="n">kernel_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                              <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">Orthogonal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
                              <span class="n">strides</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                              <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">,</span>
                              <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">)</span>

        <span class="n">h2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span>
                              <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv2&quot;</span><span class="p">,</span>
                              <span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                              <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                              <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">Orthogonal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
                              <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                              <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">,</span>
                              <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">)</span>

        <span class="n">h3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">h2</span><span class="p">,</span>
                              <span class="n">name</span><span class="o">=</span><span class="s2">&quot;conv3&quot;</span><span class="p">,</span>
                              <span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                              <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                              <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">Orthogonal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
                              <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">,</span>
                              <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>flatten the output of the convolution network</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">nh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">h3</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]])</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h3</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nh</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">flat</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <h4>$A(s,a)$ head</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_action_score</span><span class="p">(</span><span class="n">flat</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>fully connected layer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
                            <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span>
                            <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">Orthogonal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
                               <span class="n">activation</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                               <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">Orthogonal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s2">&quot;scores&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <h4>$V(s)$ head</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_state_score</span><span class="p">(</span><span class="n">flat</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>fully connected layer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">h</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">flat</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
                            <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span>
                            <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">Orthogonal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">activation</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">Orthogonal</span><span class="p">(),</span>
                                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <h3>Evaluate $Q(s, a)$ for all actions at state <code>obs</code></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">obs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span>
                           <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span> <span class="n">obs</span><span class="p">})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <h3>Sample $\epsilon#-greedy action for <code>obs</code></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">obs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">exploration_fraction</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                           <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">:</span> <span class="n">obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploration_fraction</span><span class="p">:</span> <span class="n">exploration_fraction</span><span class="p">})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <h2>Trainer</h2>
<p>We want to find optimal action-value function.</p>
<p>
<script type="math/tex; mode=display">\begin{align}
    Q^*(s,a) &= \max_\pi \mathbb{E} \Big[
        r_t + \gamma r_{t + 1} + \gamma^2 r_{t + 2} + ... | s_t = s, a_t = a, \pi
    \Big]
\\
    Q^*(s,a) &= \mathop{\mathbb{E}}_{s' \sim \large{\varepsilon}} \Big[
        r + \gamma \max_{a'} Q^* (s', a') | s, a
    \Big]
\end{align}</script>
</p>
<h4>Target network 🎯</h4>
<p>In order to improve stability we use experience replay that randomly sample
from previous experience $U(D)$. We also use a Q network
with a separate set of paramters $\hl1{\theta_i^{-}}$ to calculate the target.
$\hl1{\theta_i^{-}}$ is updated periodically.
This is according to the <a href="https://deepmind.com/research/dqn/">paper by DeepMind</a>.</p>
<p>So the loss function is,
<script type="math/tex; mode=display">
\mathcal{L}_i(\theta_i) = \mathop{\mathbb{E}}_{(s,a,r,s') \sim U(D)}
\bigg[
    \Big(
        r + \gamma \max_{a'} Q(s', a'; \hl1{\theta_i^{-}}) - Q(s,a;\theta_i)
    \Big) ^ 2
\bigg]
</script>
</p>
<h4>Double $Q$-Learning</h4>
<p>The max operator in the above calculation uses same network for both
selecting the best action and for evaluating the value.
That is,
<script type="math/tex; mode=display">
\max_{a'} Q(s', a'; \theta) = \blue{Q}
\Big(
    s', \mathop{\operatorname{argmax}}_{a'}
    \blue{Q}(s', a'; \blue{\theta}); \blue{\theta}
\Big)
</script>
We use <a href="https://arxiv.org/abs/1509.06461">double Q-learning</a>, where
the $\operatorname{argmax}$ is taken from $\theta_i$ and
the value is taken from $\theta_i^{-}$.</p>
<p>And the loss function becomes,
<script type="math/tex; mode=display">\begin{align}
    \mathcal{L}_i(\theta_i) = \mathop{\mathbb{E}}_{(s,a,r,s') \sim U(D)}
    \Bigg[
        \bigg(
            &r + \gamma \blue{Q}
            \Big(
                s',
                \mathop{\operatorname{argmax}}_{a'}
                    \green{Q}(s', a'; \green{\theta_i}); \blue{\theta_i^{-}}
            \Big)
            \\
            - &Q(s,a;\theta_i)
        \bigg) ^ 2
    \Bigg]
\end{align}</script>
</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Trainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <h3>Initialize</h3>
<p><code>double_q_model</code> has same weights as <code>sample_model</code></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">target_model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">double_q_model</span><span class="p">:</span> <span class="n">Model</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>learning rate</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>model for $Q(s, a; \theta_i)$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>model for $Q(s, a; \theta_i^{-})$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="o">=</span> <span class="n">target_model</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>model for $Q(s, a; \theta_i)$.
We need a copy of it because of the TensorFlow graph, but the parameters are the same</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">double_q_model</span> <span class="o">=</span> <span class="n">double_q_model</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>we are treating observations as state
$s$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">sampled_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">obs</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>next state, $s&rsquo;$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">sampled_next_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">obs</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>sampled action $a$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">sampled_action</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">],</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sampled_action&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>sampled rewards $r$ sampled rewards</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">sampled_reward</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">],</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sampled_reward&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>whether the game ended</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">sampled_done</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">],</span>
                                           <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sampled_done&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>weights of the samples</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_weights</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">],</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sample_weights&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>$Q(s, a; \theta_i)$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">q</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampled_action</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                               <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>$\mathop{\operatorname{argmax}}_{a&rsquo;} Q(s&rsquo;, a&rsquo;; \theta_i)$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">best_next_action</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">double_q_model</span><span class="o">.</span><span class="n">q</span><span class="p">,</span>
                                     <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>$Q\Big(s&rsquo;, \mathop{\operatorname{argmax}}_{a&rsquo;} Q(s&rsquo;, a&rsquo;; \theta_i); \theta_i^{-}\Big)$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">best_next_q</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">q</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">best_next_action</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>mask out if game ended</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">best_next_q_masked</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampled_done</span><span class="p">)</span> <span class="o">*</span> <span class="n">best_next_q</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>$r + \gamma Q\Big(s&rsquo;, \mathop{\operatorname{argmax}}_{a&rsquo;} Q(s&rsquo;, a&rsquo;; \theta_i); \theta_i^{-}\Big)$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">q_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampled_reward</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">best_next_q_masked</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>histograms for debugging</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="s1">&#39;q_update&#39;</span><span class="p">,</span> <span class="n">q_update</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>Temporal Difference $\delta$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">td_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">q_update</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>take <a href="https://en.wikipedia.org/wiki/Huber_loss">Huber loss</a> instead of mean squared error</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">error</span> <span class="o">=</span> <span class="n">huber_loss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">td_error</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>weighed error by priorities</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">weighted_error</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_weights</span> <span class="o">*</span> <span class="n">error</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>apply clipped gradients</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">adam</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
        <span class="n">grads</span> <span class="o">=</span> <span class="n">adam</span><span class="o">.</span><span class="n">compute_gradients</span><span class="p">(</span><span class="n">weighted_error</span><span class="p">,</span> <span class="n">var_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grads</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">grads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">clip_by_norm</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">var</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_op</span> <span class="o">=</span> <span class="n">adam</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;apply_gradients&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>update $\theta_i^{-}$ to $\theta_i$ periodically</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">update_target_expr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">var_target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                   <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
            <span class="n">update_target_expr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_target</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_target_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="n">update_target_expr</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>histogram summaries</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">summaries</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">merge_all</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      <h3>Train model with samples</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">samples</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">feed_dict</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sampled_obs</span><span class="p">:</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sampled_next_obs</span><span class="p">:</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;next_obs&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sampled_action</span><span class="p">:</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sampled_reward</span><span class="p">:</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sampled_done</span><span class="p">:</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sample_weights</span><span class="p">:</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">:</span> <span class="n">learning_rate</span><span class="p">}</span>

        <span class="n">evals</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">td_error</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">train_op</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      <p>return all results except <code>train_op</code></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">evals</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <h3>Update $\theta_i^{-}$</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_target_op</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <h3>Generate summary for TensorBoard</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">feed_dict</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sampled_obs</span><span class="p">:</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sampled_next_obs</span><span class="p">:</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;next_obs&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sampled_action</span><span class="p">:</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sampled_reward</span><span class="p">:</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sampled_done</span><span class="p">:</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sample_weights</span><span class="p">:</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]}</span>

        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summaries</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <h2>Buffer for Prioritized Experience Replay</h2>
<p><a href="https://arxiv.org/abs/1511.05952">Prioritized experience replay</a>
 samples important transitions more frequently.
The transitions are prioritized by the Temporal Difference error.</p>
<p>We sample transition $i$ with probability,
<script type="math/tex; mode=display">P(i) = \frac{p_i^\alpha}{\sum_k p_k^\alpha}</script>
where $\alpha$ is a hyper-parameter that determines how much
prioritization is used, with $\alpha = 0$ corresponding to uniform case.</p>
<p>We use proportional prioritization $p_i = |\delta_i| + \epsilon$ where
$\delta_i$ is the temporal difference for transition $i$.</p>
<p>We correct the bias introduced by prioritized replay by
 importance-sampling (IS) weights
<script type="math/tex; mode=display">w_i = \bigg(\frac{1}{N} \frac{1}{P(i)}\bigg)^\beta</script>
that fully compensates for when $\beta = 1$.
We normalize weights by $1/\max_i w_i$ for stability.
Unbiased nature is most important towards the convergence at end of training.
Therefore we increase $\beta$ towards end of training.</p>
<h3>Binary Segment Trees</h3>
<p>We use binary segment trees to efficiently calculate
$\sum_k^i p_k^\alpha$, the cumulative probability,
which is needed to sample.
We also use a binary segment tree to find $\min p_i^\alpha$,
which is needed for $1/\max_i w_i$.
We can also use a min-heap for this.</p>
<p>This is how a binary segment tree works for sum;
it is similar for minimum.
Let $x_i$ be the list of $N$ values we want to represent.
Let $b_{i,j}$ be the $j^{\mathop{th}}$ node of the $i^{\mathop{th}}$ row
 in the binary tree.
That is two children of node $b_{i,j}$ are $b_{i+1,2j}$ and $b_{i+1,2j + 1}$.</p>
<p>The leaf nodes on row $D = \left\lceil {1 + \log_2 N} \right\rceil$
 will have values of $x$.
Every node keeps the sum of the two child nodes.
So the root node keeps the sum of the entire array of values.
The two children of the root node keep
 the sum of the first half of the array and
 the sum of the second half of the array, and so on.</p>
<p>
<script type="math/tex; mode=display">b_{i,j} = \sum_{k = (j -1) * 2^{D - i} + 1}^{j * 2^{D - i}} x_k</script>
</p>
<p>Number of nodes in row $i$,
<script type="math/tex; mode=display">N_i = \left\lceil{\frac{N}{D - i + i}} \right\rceil</script>
This is equal to the sum of nodes in all rows above $i$.
So we can use a single array $a$ to store the tree, where,
<script type="math/tex; mode=display">b_{i,j} = a_{N_1 + j}</script>
</p>
<p>Then child nodes of $a_i$ are $a_{2i}$ and $a_{2i + 1}$.
That is,
<script type="math/tex; mode=display">a_i = a_{2i} + a_{2i + 1}</script>
</p>
<p>This way of maintaining binary trees is very easy to program.
<em>Note that we are indexing from 1</em>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">ReplayBuffer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      <h3>Initialize</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>we use a power of 2 for capacity to make it easy to debug</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      <p>we refill the queue once it reaches capacity</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">next_idx</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      <p>$\alpha$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      <p>maintain segment binary trees to take sum and find minimum over a range</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">priority_sum</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_min</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">)]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      <p>current max priority, $p$, to be assigned to new transitions</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">max_priority</span> <span class="o">=</span> <span class="mf">1.</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      <p>arrays for buffer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;obs&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
            <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="s1">&#39;next_obs&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span>
            <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">capacity</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      <p>size of the buffer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-75'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-75'>#</a>
      </div>
      <h3>Add sample to queue</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_obs</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-76'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-76'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_idx</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-77'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-77'>#</a>
      </div>
      <p>store in the queue</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;next_obs&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_obs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">done</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-78'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-78'>#</a>
      </div>
      <p>increment head of the queue and calculate the size</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">next_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-79'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-79'>#</a>
      </div>
      <p>$p_i^\alpha$, new samples get <code>max_priority</code></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">priority_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_priority</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_priority_min</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">priority_alpha</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_priority_sum</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">priority_alpha</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-80'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-80'>#</a>
      </div>
      <h4>Set priority in binary segment tree for minimum</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_set_priority_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">priority_alpha</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-81'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-81'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-82'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-82'>#</a>
      </div>
      <p>leaf of the binary tree</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">idx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_min</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">priority_alpha</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-83'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-83'>#</a>
      </div>
      <p>update tree, by traversing along ancestors</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">while</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">//=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_min</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priority_min</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span><span class="p">],</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">priority_min</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-84'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-84'>#</a>
      </div>
      <h4>Set priority in binary segment tree for sum</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_set_priority_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">priority</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-85'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-85'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-86'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-86'>#</a>
      </div>
      <p>leaf of the binary tree</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">idx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_sum</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">priority</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-87'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-87'>#</a>
      </div>
      <p>update tree, by traversing along ancestors</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">while</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">//=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_sum</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_sum</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_sum</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-88'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-88'>#</a>
      </div>
      <h4>$\sum_k p_k^\alpha$</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-89'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-89'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_sum</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-90'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-90'>#</a>
      </div>
      <h4>$\min_k p_k^\alpha$</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-91'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-91'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-92'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-92'>#</a>
      </div>
      <h4>Find largest $i$ such that $\sum_{k=1}^{i} p_k^\alpha  \le P$</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">find_prefix_sum_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix_sum</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-93'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-93'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-94'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-94'>#</a>
      </div>
      <p>start from the root</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-95'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-95'>#</a>
      </div>
      <p>if the sum of the left branch is higher than required sum</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_sum</span><span class="p">[</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prefix_sum</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-96'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-96'>#</a>
      </div>
      <p>go to left branch if the tree if the</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span>
            <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-97'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-97'>#</a>
      </div>
      <p>otherwise go to right branch and reduce the sum of left
 branch from required sum</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">prefix_sum</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_sum</span><span class="p">[</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">idx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-98'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-98'>#</a>
      </div>
      <h3>Sample from buffer</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-99'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-99'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">samples</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="s1">&#39;indexes&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-100'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-100'>#</a>
      </div>
      <p>get samples</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum</span><span class="p">()</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_prefix_sum_idx</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-101'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-101'>#</a>
      </div>
      <p>$\min_i P(i) = \frac{\min_i p_i^\alpha}{\sum_k p_k^\alpha}$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">prob_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-102'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-102'>#</a>
      </div>
      <p>$\max_i w_i = \bigg(\frac{1}{N} \frac{1}{\min_i P(i)}\bigg)^\beta$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">max_weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">prob_min</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-103'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-103'>#</a>
      </div>
      <p>$P(i) = \frac{p_i^\alpha}{\sum_k p_k^\alpha}$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_sum</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-104'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-104'>#</a>
      </div>
      <p>$w_i = \bigg(\frac{1}{N} \frac{1}{P(i)}\bigg)^\beta$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">prob</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-105'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-105'>#</a>
      </div>
      <p>normalize by $\frac{1}{\max_i w_i}$,
 which also cancels off the $\frac{1}/{N}$ term</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">/</span> <span class="n">max_weight</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-106'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-106'>#</a>
      </div>
      <p>get samples data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">samples</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">samples</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-107'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-107'>#</a>
      </div>
      <h3>Update priorities</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update_priorities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indexes</span><span class="p">,</span> <span class="n">priorities</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-108'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-108'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">priority</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">priorities</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_priority</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_priority</span><span class="p">,</span> <span class="n">priority</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-109'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-109'>#</a>
      </div>
      <p>$p_i^\alpha$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">priority_alpha</span> <span class="o">=</span> <span class="n">priority</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_priority_min</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">priority_alpha</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_priority_sum</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">priority_alpha</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-110'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-110'>#</a>
      </div>
      <h3>Is the buffer full</h3>
<p>We only start sampling afte the buffer is full.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">is_full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-111'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-111'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-112'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-112'>#</a>
      </div>
      <h2><a name="main"></a>Main class</h2>
<p>This class runs the training loop.
It initializes TensorFlow, handles logging and monitoring,
 and runs workers as multiple processes.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Main</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-113'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-113'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-114'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-114'>#</a>
      </div>
      <h3>Initialize</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-115'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-115'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-116'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-116'>#</a>
      </div>
      <h4>Configurations</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-117'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-117'>#</a>
      </div>
      <p>$\gamma$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">GAMMA</span> <span class="o">=</span> <span class="mf">0.99</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-118'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-118'>#</a>
      </div>
      <p>learning rate</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">1e-4</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-119'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-119'>#</a>
      </div>
      <p>total number of time steps</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">TOTAL_TIME_STEPS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">40e6</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-120'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-120'>#</a>
      </div>
      <p>number of workers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">WORKERS</span> <span class="o">=</span> <span class="mi">8</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-121'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-121'>#</a>
      </div>
      <p>steps sampled on each update</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLE_STEPS</span> <span class="o">=</span> <span class="mi">4</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-122'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-122'>#</a>
      </div>
      <p>number of samples collected per update</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLES_PER_UPDATE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">WORKERS</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLE_STEPS</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-123'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-123'>#</a>
      </div>
      <p>number of training iterations</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">TRAIN_ITERS</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLES_PER_UPDATE</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-124'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-124'>#</a>
      </div>
      <p>number of updates</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">UPDATES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TOTAL_TIME_STEPS</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLES_PER_UPDATE</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-125'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-125'>#</a>
      </div>
      <p>size of mini batch for training</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">MINI_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-126'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-126'>#</a>
      </div>
      <p>exploration as a function of time step</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">EXPLORATION</span> <span class="o">=</span> <span class="n">PiecewiseSchedule</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">1e6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TOTAL_TIME_STEPS</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
            <span class="p">],</span> <span class="n">outside_value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-127'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-127'>#</a>
      </div>
      <p>update target network every 10000 time steps</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_TARGET_NETWORK</span> <span class="o">=</span> <span class="mi">10000</span> <span class="o">//</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TRAIN_ITERS</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-128'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-128'>#</a>
      </div>
      <p>size of the replay buffer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">REPLAY_BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">14</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-129'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-129'>#</a>
      </div>
      <p>$\alpha$ for replay buffer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">PRIORITIZED_REPLAY_ALPHA</span> <span class="o">=</span> <span class="mf">0.6</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-130'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-130'>#</a>
      </div>
      <p>$\beta$ for replay buffer as a function of time steps</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">PRIORITIZED_REPLAY_BETA</span> <span class="o">=</span> <span class="n">PiecewiseSchedule</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">),</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TOTAL_TIME_STEPS</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">],</span> <span class="n">outside_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-131'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-131'>#</a>
      </div>
      <p>initialize TensorFlow session</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">Main</span><span class="o">.</span><span class="n">_init_tf_session</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-132'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-132'>#</a>
      </div>
      <p>create game</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">workers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Worker</span><span class="p">(</span><span class="mi">47</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WORKERS</span><span class="p">)]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-133'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-133'>#</a>
      </div>
      <p>replay buffer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span> <span class="o">=</span> <span class="n">ReplayBuffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REPLAY_BUFFER_SIZE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PRIORITIZED_REPLAY_ALPHA</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-134'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-134'>#</a>
      </div>
      <p>episode information for monitoring</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">episode_reward</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WORKERS</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">episode_length</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WORKERS</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">episode_info</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_episode</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;obs&#39;</span><span class="p">:</span> <span class="bp">None</span>
        <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-135'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-135'>#</a>
      </div>
      <p>model for sampling, $Q(s, a; \theta_i)$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;q_function&quot;</span><span class="p">,</span>
                                  <span class="n">reuse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                  <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">WORKERS</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-136'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-136'>#</a>
      </div>
      <p>model for target, $Q(s, a; \theta_i^{-})$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;target_q_function&quot;</span><span class="p">,</span>
                                  <span class="n">reuse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">MINI_BATCH_SIZE</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-137'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-137'>#</a>
      </div>
      <p>model for training with same parameters, $Q(s, a; \theta_i)$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">train_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;q_function&quot;</span><span class="p">,</span>
                                 <span class="n">reuse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                 <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">MINI_BATCH_SIZE</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-138'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-138'>#</a>
      </div>
      <p>model for double Q-learning with same parameters,
 $Q(s, a; \theta_i)$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">double_q_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;q_function&quot;</span><span class="p">,</span>
                                    <span class="n">reuse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                    <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">MINI_BATCH_SIZE</span><span class="p">,</span>
                                    <span class="n">scaled_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="o">.</span><span class="n">scaled_images</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-139'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-139'>#</a>
      </div>
      <p>trainer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GAMMA</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">train_model</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">target_model</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">double_q_model</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-140'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-140'>#</a>
      </div>
      <p>last observation for each worker</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">WORKERS</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-141'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-141'>#</a>
      </div>
      <p>create TensorFlow session</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_default_session</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-142'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-142'>#</a>
      </div>
      <p>initialize TensorFlow variables</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">init_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">init_op</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-143'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-143'>#</a>
      </div>
      <h3>Sample data from <code>sample_model</code></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exploration</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-144'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-144'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-145'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-145'>#</a>
      </div>
      <p>sample <code>SAMPLE_STEPS</code></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAMPLE_STEPS</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-146'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-146'>#</a>
      </div>
      <p>sample actions</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_model</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">exploration</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-147'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-147'>#</a>
      </div>
      <p>run sampled actions on each worker</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">):</span>
                <span class="n">worker</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="n">actions</span><span class="p">[</span><span class="n">w</span><span class="p">]))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-148'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-148'>#</a>
      </div>
      <p>collect information from each worker</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">worker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-149'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-149'>#</a>
      </div>
      <p>get results after executing the actions</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">next_obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
                <span class="n">next_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">next_obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-150'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-150'>#</a>
      </div>
      <p>add transition to replay buffer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">actions</span><span class="p">[</span><span class="n">w</span><span class="p">],</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_obs</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-151'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-151'>#</a>
      </div>
      <p>update episode information</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="bp">self</span><span class="o">.</span><span class="n">episode_length</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">episode_reward</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reward</span>
                <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_episode</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_reward</span><span class="p">[</span><span class="n">w</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">best_episode</span><span class="p">[</span><span class="s1">&#39;reward&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_reward</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">best_episode</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">episode_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_reward</span><span class="p">[</span><span class="n">w</span><span class="p">],</span>
                        <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_length</span><span class="p">[</span><span class="n">w</span><span class="p">]})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">episode_reward</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">episode_length</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-152'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-152'>#</a>
      </div>
      <p>update current observation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">w</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_obs</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-153'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-153'>#</a>
      </div>
      <h3>Train the model</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-154'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-154'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">td_errors_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TRAIN_ITERS</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-155'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-155'>#</a>
      </div>
      <p>sample from priority replay buffer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MINI_BATCH_SIZE</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-156'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-156'>#</a>
      </div>
      <p>train network</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">q</span><span class="p">,</span> <span class="n">td_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                                              <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
                                              <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LEARNING_RATE</span><span class="p">)</span>
            <span class="n">td_errors_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">td_errors</span><span class="p">)</span>
            <span class="n">q_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-157'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-157'>#</a>
      </div>
      <p>$p_i = |\delta_i| + \epsilon$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">new_priorities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">td_errors</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-158'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-158'>#</a>
      </div>
      <p>update replay buffer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">update_priorities</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">],</span> <span class="n">new_priorities</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-159'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-159'>#</a>
      </div>
      <p>return averages for monitoring</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">q_all</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">q_all</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">td_errors_all</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-160'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-160'>#</a>
      </div>
      <h3>Get histogram summaries</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-161'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-161'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MINI_BATCH_SIZE</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-162'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-162'>#</a>
      </div>
      <p>train network and get $\delta_i$</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                                      <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-163'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-163'>#</a>
      </div>
      <h3>Run training loop</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">run_training_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-164'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-164'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-165'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-165'>#</a>
      </div>
      <p>load saved model</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">_load_model</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-166'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-166'>#</a>
      </div>
      <p>summary writer for TensorBoard</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_summary_writer</span><span class="p">()</span>
        <span class="n">histogram_writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_summary_writer_histogram</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-167'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-167'>#</a>
      </div>
      <p>copy to target network initially</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">update_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">update</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATES</span><span class="p">):</span>
            <span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">time_step</span> <span class="o">=</span> <span class="n">update</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLES_PER_UPDATE</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-168'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-168'>#</a>
      </div>
      <p>$\epsilon$, exploration fraction</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">exploration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXPLORATION</span><span class="p">(</span><span class="n">time_step</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-169'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-169'>#</a>
      </div>
      <p>$\beta$ for priority replay</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PRIORITIZED_REPLAY_BETA</span><span class="p">(</span><span class="n">time_step</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-170'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-170'>#</a>
      </div>
      <p>sample with current policy</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">exploration</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">is_full</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-171'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-171'>#</a>
      </div>
      <p>train the model</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">q</span><span class="p">,</span> <span class="n">q_std</span><span class="p">,</span> <span class="n">td_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-172'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-172'>#</a>
      </div>
      <p>periodically update target network</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="n">update</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_TARGET_NETWORK</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">update_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">td_error</span> <span class="o">=</span> <span class="n">q</span> <span class="o">=</span> <span class="n">q_std</span> <span class="o">=</span> <span class="mf">0.</span>

            <span class="n">time_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-173'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-173'>#</a>
      </div>
      <p>frame rate</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">fps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SAMPLES_PER_UPDATE</span> <span class="o">/</span> <span class="p">(</span><span class="n">time_end</span> <span class="o">-</span> <span class="n">time_start</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-174'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-174'>#</a>
      </div>
      <p>log every 10 updates</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">update</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-175'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-175'>#</a>
      </div>
      <p>mean of last 100 episodes</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">reward_mean</span><span class="p">,</span> <span class="n">length_mean</span><span class="p">,</span> <span class="n">best_obs_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mean_episode_info</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-176'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-176'>#</a>
      </div>
      <p>write summary info to the writer, and log to the screen</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">Main</span><span class="o">.</span><span class="n">_write_summary</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">best_obs_frame</span><span class="p">,</span> <span class="n">time_step</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span>
                                    <span class="nb">float</span><span class="p">(</span><span class="n">reward_mean</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">length_mean</span><span class="p">),</span>
                                    <span class="nb">float</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">q_std</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">td_error</span><span class="p">),</span>
                                    <span class="n">exploration</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">is_full</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-177'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-177'>#</a>
      </div>
      <p>write histogram summaries</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">histogram_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
                    <span class="n">histogram_writer</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span><span class="n">histogram_summary</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="n">time_step</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-178'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-178'>#</a>
      </div>
      <p>save model once in a while</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">is_full</span><span class="p">()</span> <span class="ow">and</span> <span class="n">update</span> <span class="o">%</span> <span class="mi">100000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_model</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-179'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-179'>#</a>
      </div>
      <h4>Initialize TensorFlow session</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_init_tf_session</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-180'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-180'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-181'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-181'>#</a>
      </div>
      <p>let TensorFlow decide where to run operations;
 I think it chooses the GPU for everything if you have one</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">config</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ConfigProto</span><span class="p">(</span><span class="n">allow_soft_placement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                <span class="n">log_device_placement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-182'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-182'>#</a>
      </div>
      <p>grow GPU memory as needed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">config</span><span class="o">.</span><span class="n">gpu_options</span><span class="o">.</span><span class="n">allow_growth</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-183'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-183'>#</a>
      </div>
      <p>set random seeds,
 but it doesn&rsquo;t seem to produce identical results.</p>
<p>One explanation is that there would be floating point errors that get accumulated.
But that is not possible, because, as far as I know, floating point calculations
 are deterministic even if they could be unpredictable (in small scale).
However, there may be certain hardware optimizations that cause them to be random.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-184'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-184'>#</a>
      </div>
      <h4>Get average episode reward and episode length</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_mean_episode_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-185'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-185'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_info</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_info</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best_episode</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-186'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-186'>#</a>
      </div>
      <h4>Create summary writer</h4>
<p>I used TensorBoard for monitoring.
I made copies of programs when I was making changes,
 and logged them to different directories so that I can later see
 how each version worked.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_create_summary_writer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">FileWriter</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-187'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-187'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">log_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">PurePath</span><span class="p">(</span><span class="s2">&quot;log/&quot;</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">DeleteRecursively</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">FileWriter</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-188'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-188'>#</a>
      </div>
      <h4>Create summary writer for histograms</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_create_summary_writer_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">FileWriter</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-189'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-189'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">log_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">PurePath</span><span class="p">(</span><span class="s2">&quot;log/&quot;</span><span class="p">,</span> <span class="s2">&quot;histograms&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">DeleteRecursively</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">FileWriter</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-190'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-190'>#</a>
      </div>
      <h4>Get checkpoint path</h4>
<p>Different paths based on source code file name</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_checkpoint_path</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-191'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-191'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">PurePath</span><span class="p">(</span><span class="s2">&quot;checkpoints/&quot;</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
        <span class="n">model_file</span> <span class="o">=</span> <span class="n">checkpoint_path</span> <span class="o">/</span> <span class="s1">&#39;model&#39;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-192'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-192'>#</a>
      </div>
      <h4>Write summary</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_write_summary</span><span class="p">(</span><span class="n">writer</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">Summary</span><span class="p">,</span>
                       <span class="n">best_obs_frame</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>
                       <span class="n">time_step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                       <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                       <span class="n">reward_mean</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">length_mean</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">q</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">q_std</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">td_error</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">exploration</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-193'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-193'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{:4} {:3} {:.2f} {:.3f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_step</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="n">reward_mean</span><span class="p">,</span> <span class="n">length_mean</span><span class="p">))</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Summary</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-194'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-194'>#</a>
      </div>
      <p>add an image</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">best_obs_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sample_observation</span> <span class="o">=</span> <span class="n">best_obs_frame</span>
            <span class="n">observation_png</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">pyplot</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">observation_png</span><span class="p">,</span> <span class="n">sample_observation</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

            <span class="n">observation_png</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">encoded_image_string</span><span class="o">=</span><span class="n">observation_png</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span>
                                               <span class="n">height</span><span class="o">=</span><span class="mi">84</span><span class="p">,</span>
                                               <span class="n">width</span><span class="o">=</span><span class="mi">84</span><span class="p">)</span>
            <span class="n">summary</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;observation&quot;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">observation_png</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-195'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-195'>#</a>
      </div>
      <p>add scalars</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">summary</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;fps&quot;</span><span class="p">,</span> <span class="n">simple_value</span><span class="o">=</span><span class="n">fps</span><span class="p">)</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="n">simple_value</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;q_std&#39;</span><span class="p">,</span> <span class="n">simple_value</span><span class="o">=</span><span class="n">q_std</span><span class="p">)</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;td_error&#39;</span><span class="p">,</span> <span class="n">simple_value</span><span class="o">=</span><span class="n">td_error</span><span class="p">)</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;reward_mean&quot;</span><span class="p">,</span> <span class="n">simple_value</span><span class="o">=</span><span class="n">reward_mean</span><span class="p">)</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;length_mean&quot;</span><span class="p">,</span> <span class="n">simple_value</span><span class="o">=</span><span class="n">length_mean</span><span class="p">)</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;exploration&quot;</span><span class="p">,</span> <span class="n">simple_value</span><span class="o">=</span><span class="n">exploration</span><span class="p">)</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="n">simple_value</span><span class="o">=</span><span class="n">beta</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-196'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-196'>#</a>
      </div>
      <p>write to file</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">writer</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="n">time_step</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-197'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-197'>#</a>
      </div>
      <h3>Destroy</h3>
<p>Stop the workers</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-198'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-198'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-199'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-199'>#</a>
      </div>
      <h4>Load model</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-200'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-200'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">model_file</span> <span class="o">=</span> <span class="n">Main</span><span class="o">.</span><span class="n">_get_checkpoint_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
            <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Loaded model&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-201'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-201'>#</a>
      </div>
      <h4>Save model</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-202'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-202'>#</a>
      </div>

    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">model_file</span> <span class="o">=</span> <span class="n">Main</span><span class="o">.</span><span class="n">_get_checkpoint_path</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
        <span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Saved model&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-203'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-203'>#</a>
      </div>
      <h2>Run it</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Main</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">run_training_loop</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            displayMath: [ ['$$','$$'] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": { fonts: ["TeX"] }
    });
    </script>

</body>
