<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[vpj's diary]]></title>
  <link href="http://vpj.github.com/atom.xml" rel="self"/>
  <link href="http://vpj.github.com/"/>
  <updated>2013-09-13T15:04:19+05:30</updated>
  <id>http://vpj.github.com/</id>
  <author>
    <name><![CDATA[Varuna Jayasiri]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Moving from Google Appengine to NodeJS on Amazon EC2]]></title>
    <link href="http://vpj.github.com/blog/2013/09/13/moving-from-appengine-to-amazon-with-nodejs/"/>
    <updated>2013-09-13T11:02:00+05:30</updated>
    <id>http://vpj.github.com/blog/2013/09/13/moving-from-appengine-to-amazon-with-nodejs</id>
    <content type="html"><![CDATA[<p><a href="http://nearby.lk">nearby.lk</a> moved their servers from Google Appengine to Amazon EC2 last month, and the backend is now built with nodejs with mongodb as the database.</p>

<p>Most of our backend does a lot of pre-computations and caching which gives slower startup times and faster response times. Our migration decision was based on a number of factors such as ease of development, performance and cost. There were a bunch of disadvantages of using the appengine, a several benefits of using NodeJS and some things we miss after the migration.</p>

<h2>Appengine: the bad</h2>

<h3>Datastore operations are slow</h3>

<p>We didn&#8217;t have many datastore rights. Almost none on most days as we were uploading data in bulks. Still the datastore reads were significantly slow. To improve performance we started keeping most of the data in memory, which worked great until the web traffic and database size was small.</p>

<h3>Too many multiple instances</h3>

<p>Appengine does the load balancing for you. So when it feels like a single server cannot handle the load it creates multiple instances and balances the load. Although this sounds awesome it wasn&#8217;t for us. Since we were doing a lot of pre-computations the newly created instances were busy and it seemed like appengine was creating more and more instances to handle this. The problem was that multiple instances weren&#8217;t actually required to handle the load, but Appengine had a few instances running all the time, which was costing us a lot.</p>

<p>We tried using warmup requests to keep an extra instance running, to solve the slow startup issue, but it was not of much use.</p>

<h3>Request Timeouts</h3>

<p>Startup pre-computations took more than the request time limit. This made us break down the startup process into smaller chunks and run each part on different requests. That is, and instance would only be ready after a couple of requests were sent to it. Breaking the startup process was a horrible experience, and the worst part is that the startup is taking most of it&#8217;s time reading the datastore - the system would startup in a couple of seconds on my computer with appengine development server.</p>

<h3>Memcache</h3>

<p>Memcache helped solve the startup issue a bit, but it had a stupid 1MB size limit per entry which made things really hard for the developers. Large object had to be broken down into pieces smaller than 1MB and if one of them was removed from memcache, everything had to be recomputed.</p>

<h3>Uploading and downloading data</h3>

<p>This was literally a nightmare. bulk data uploads and downloads had to be broken down into tiny chunks because of the request time limits, and there was no way to access the datastore without writing code to do it.</p>

<h3>Search API</h3>

<p>We HAD to use the search API for the last few months because we couldn&#8217;t keep our indexes in memory, because of the startup time (discussed earlier). You might expect the search API to be super awesome because it&#8217;s Google but it was so slow. May be we didn&#8217;t use the proper design, but it was the best we could find with the documentation available.</p>

<h2>NodeJS: the good</h2>

<h3>One language</h3>

<p>Now the server and user interface are both in javascript, which makes it a lot easier for the developers to switch between the two.</p>

<h3>Server-side rendering</h3>

<p>We don&#8217;t have to maintain different code to do server side rendering since we can use the same templates on both the server and client. We could have actually done this even with appengine but most template engines such as handlebars were too simple for our purposes - we wanted templates to do certain computations by themselves. Overall what we now have is so easy to work on.</p>

<h3>Portable</h3>

<p>We can now host our servers anywhere. We are not stuck with any commercial platform, as we were with the app engine, where we had no choice to pay more if they were to change pricing. We are currently hosted on amazon and it is running smoothly. We might switch to a larger server on amazon soon.</p>

<h3>Speed</h3>

<p>The startup time is much faster and requests are handled within a couple of milliseconds. We are using nginx for all static content so nodejs only needs to handle dynamic content.</p>

<h2>What we miss</h2>

<h3>Management Console</h3>

<p>Appengine had a nice management console where we could look at logs, system status etc. Now we have to do it through ssh with unix commands. Although this is not a big issue for the developers, now we can&#8217;t ask someone else to check or restart the servers if needed.</p>

<h3>Ease of deployment</h3>

<p>With appeengine, all you have to do deploy is just to run a command. But now we need to run about 5 commands. OK, this is not something that we really miss.</p>

<h3>Trying out new stuff</h3>

<p>With appengine you can easily create a new account or a new version without interfering with the main system, and do beta testing or A/B testing. Now we have to run two servers on amazon or run two NodeJS instances on the same server to do this.</p>

<p><strong>So far we are so glad that we moved away from appengine and we regret that we didn&#8217;t do it sooner. Development got so much easier and now we are working on stuff that actually adds value to users than hacking the system to work deal with all the constraints such as memcache limits, slow datastore reads, etc. Although we loved Appengine when we started, now it feels like you just got out after being locked inside a tiny cage for an year and a half.</strong></p>

<h2>Found these posts which also discuss problems with Appengine</h2>

<p>I wish I read one of these an year ago.</p>

<ul>
<li><a href="http://www.carlosble.com/2010/11/goodbye-google-app-engine-gae/">Good Bye Google App Engine</a></li>
<li><a href="http://www-cs-students.stanford.edu/~silver/gae.html">The Unofficial Guide to Migrating Off of Google App Engine</a></li>
<li><a href="http://reliablesoftwares.com/blog/2012/02/12/moving-away-from-google-app-engine/">Moving away from Google App Engine</a></li>
<li><a href="http://www.war-worlds.com/blog/2013/06/switched-away-from-app-engine-couldnt-be-happier">Switched away from App Engine, couldn&#8217;t be happier</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Is Benford's Law Summation Test Easier to Comprehend?]]></title>
    <link href="http://vpj.github.com/blog/2013/08/26/benfords-law-summation/"/>
    <updated>2013-08-26T15:03:00+05:30</updated>
    <id>http://vpj.github.com/blog/2013/08/26/benfords-law-summation</id>
    <content type="html"><![CDATA[<p><img src="http://vpj.github.com/images/posts/ftd-mantissa1.png">
At <a href="http://www.forestpin.com">Forestpin</a> we&#8217;ve been analysing financial data from various companies, and Benford&#8217;s Law analysis was one of the techniques used by our software to find irregularities and fraud in financial data.</p>

<p>If you are new to Benford&#8217;s Law, <a href="http://www.datagenetics.com/blog/march52012/index.html">this article</a> gives a nice introduction. And the book <a href="http://amzn.com/1118152859">Benford&#8217;s Law: Applications for Forensic Accounting, Auditing, and Fraud Detection</a> by <a href="http://www.nigrini.com/">Dr. Mark Nigrini</a> is a great resource to learn about Benford&#8217;s Law and it&#8217;s applications in financial data analysis.</p>

<p>However, one of the things that is not much discussed and used in applying Benford&#8217;s law is the <strong>sum invariance</strong>. This characteristic was first observed by Nigrini in 1992.</p>

<p><img class="right" src="http://vpj.github.com/images/posts/ftd-distribution.png" title="First Two Digit Distribution" >
The basic use of Benford&#8217;s law is to take the first digit distribution or first two digit distribution and compare it with the expected logarithmic curve. An example first two digit distribution of invoices at a company in Sri Lanka, is illustrated in the chart above.</p>

<h2>Sum Invariance</h2>

<blockquote><p>The sum of all entries with leading digit d is constant for various d.</p><footer><strong>Mark Nigrini</strong></footer></blockquote>


<p>This states that for each first digit <strong>d</strong>, the the sum of mantissae of all numbers starting from <strong>d</strong> is equal if the dataset conforms to Benford&#8217;s Law. Therefore, by plotting a chart of sum of mantiassae against first digit, the irregularities could be identified. This chart would be simpler and easier to understand since the human eye can compare heights against a constant level effortlessly, whereas you would be comparing heights of bars against a logarithmic curve in a normal first digit chart with frequency.</p>

<h3><a href="http://en.wikipedia.org/wiki/Significand">Mantissa</a></h3>

<p>The mantissa is the significand of a number in scientific notation. For example, the mantissa of <strong>437,000</strong> = 4.37 * 10<sup>5</sup> is <strong>4.37</strong>. That is, the mantissae of 5123, 51.23 and 5123,000 are all equal to 5.123.</p>

<p><img src="http://vpj.github.com/images/posts/ftd-mantissa2.png" title="First Two Digit Distribution and Sum of Mantissa" >
The above chart shows the first two digit distribution (bars on top) and first two digit summation of mantissae (bars on bottom), and you can observe that the summation chart gives a visualization that is easier to comprehend.</p>

<p>Sometimes the summation is used without calculating the mantissa (just calculating the total of values), but in that case the chart could get largly influenced by a few large values, and therefore not recommended. The chart below shows the summation by first two digits instead of the summation of mantissae, for the same data set.
<img src="http://vpj.github.com/images/posts/ftd-sum.png" title="First Two Digit Distribution and Summation" ></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Designing with data]]></title>
    <link href="http://vpj.github.com/blog/2013/02/15/designing-with-data/"/>
    <updated>2013-02-15T15:03:00+05:30</updated>
    <id>http://vpj.github.com/blog/2013/02/15/designing-with-data</id>
    <content type="html"><![CDATA[<p><img class="right" src="http://vpj.github.com/images/posts/charts1.png">
I&#8217;ve been working with charts and graphs lately. Had to read a lot about visualizing data.</p>

<p>Studies of <a href="http://en.wikipedia.org/wiki/Edward_Tufte">Edward Tufte</a> is quite valuable to anyone working in presentation of informational graphics. One of the most useful concepts was the data-to-ink ratio.</p>

<blockquote><p>A large share of ink on a graphic should present data-information, the ink changing as the data change. Data-ink is the non-erasable core of a graphic, the non-redundant ink arranged in response to variation in the numbers represented.</p><footer><strong>Tufte</strong> <cite>1983</cite></footer></blockquote>


<p><img class="left" src="http://vpj.github.com/images/posts/charts2.png">
Tufte is also the inventor of <a href="http://en.wikipedia.org/wiki/Sparkline">sparklines</a>. I also came across the book <a href="http://www.amazon.com/Practical-Guide-Designing-Data/dp/0956174086">A Practical Guide to Designing with Data</a> by Brian Suda, which was quite useful. It covers the fundamentals of presentation of graphics, common mistakes and various chart types.</p>

<p><img src="http://vpj.github.com/images/posts/charts3.png"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A few months with Coffeescript]]></title>
    <link href="http://vpj.github.com/blog/2013/02/01/a-few-months-with-coffeescript/"/>
    <updated>2013-02-01T21:42:00+05:30</updated>
    <id>http://vpj.github.com/blog/2013/02/01/a-few-months-with-coffeescript</id>
    <content type="html"><![CDATA[<p>We moved to <a href="http://coffeescript.org">coffeescript</a> about 3 months back and
Rewrote all the javascript code in coffescript in active projects.
So far things have been very smooth and we are really happy about the move.</p>

<p><span class='pullquote-right' data-pullquote='easy to learn.'>
Coffeescript is well documented and was quite easy to learn.
It only took a few hours to skim through the documentation and start coding.
Some features of coffeescript was not used at first because of our previous coding patterns.
</span></p>

<p><span class='pullquote-right' data-pullquote='more readable'>
Coffeescript is definitely more readable than javascript. Almost all operators are replaced with words.
Although this increases the length of the code, it becomes much easier to read.
</span></p>

<p>For example, <code>if, then, else</code> is used instead of conditional statements <code>?:</code>.</p>

<figure class='code'><figcaption><span>Conditional statement  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">workingHours = </span><span class="k">if</span> <span class="nx">sunday</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">8</span>
</span></code></pre></td></tr></table></div></figure>




<!--
Coffescript doesn't use semicolan and block expressions are delimeted by indentation.
Using `@property` instead of `this.property` improves readability while reducing the number of keystrokes.
-->


<p><span class='pullquote-right' data-pullquote='fewer lines code'>
Code written is coffeescript consists of fewer lines code, and sometimes fewer character in each line.
No curly brackets <code>{, }</code>, simpler function declarations, no variable declarations, etc.
are a few reasons for this. I believe coffeescript reduced the number of lines of our code by 15% to 40%.
</span></p>

<p>Also, Coffeescript has some cool features such as existence operator,
default values for function arguments, looping through arrays and objects, array slicing,
destructuring assignments, string interpolation, etc. to solve some of
the frequently occurring difficulties in javascript.</p>

<p>For instance, with string interpolation, instead of having to code
<code>"&lt;h1&gt;" + heading + "&lt;/h1&gt;&lt;p&gt;" + description + "&lt;/p&gt;</code>,
you could just write <code>"&lt;h1&gt;#{heading}&lt;/h1&gt;&lt;p&gt;#{description}&lt;/p&gt;"</code>.</p>

<h2>One language to rule them all</h2>

<p>We are using <a href="https://github.com/gradus/coffeecup">coffeecup</a> instead of HTML. So this takes of the need to maintain templates separately,
with different template engines for backend and frontend. Coffeecup templates are stored
in separate coffeescript files which are used by both the browser code (frontend)
and node js (backend) - we need backend rendering for indexing bots. And you can avoid repetitive
HTML sections by implementing helpers which can be reused.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[nearby.lk Technology Stack]]></title>
    <link href="http://vpj.github.com/blog/2012/09/02/nearby-dot-lk-technology-stack/"/>
    <updated>2012-09-02T11:02:00+05:30</updated>
    <id>http://vpj.github.com/blog/2012/09/02/nearby-dot-lk-technology-stack</id>
    <content type="html"><![CDATA[<p><a href="http://nearby.lk">nearby.lk</a> is business search engine, currently operating only within Sri Lanka.
It has been growing rapidly in-terms of visitors, business listings as well as features and performance of the system, since the launch in February 2012.</p>

<h2>Server</h2>

<p><a href="http://nearby.lk">nearby.lk</a> runs on <strong>Google App Engine (GAE)</strong>. It was pretty easy to get things started on GAE - no need to setup servers, databases, etc. This was the main reason for picking GAE at first. We wanted something up and running as soon as possible. However, sometimes you feel like you dont have enough customizability.</p>

<p>App Engine gives a lot of services such as Google authentication, datastore, memcache, load balancing, image manipulation, a search API, email, relatime channels, xmpp, backends, etc. GAE documentation is also pretty good.</p>

<p>We started using Google authentication and Facebook authentication and later decided to drop google authentication as not many users were using that. We continue to use google authentication for admin section.</p>

<p>Load balancing seems to be a bit over doing, which causes new instances to be created unecessarily sometimes. In our app, this actually causes some low response times, becuase our program has a slow startup. Startup times were reduced significantly by caching all precomputations in memcache, which is common to all instances.</p>

<p>Images API was quite handy for image resizing. We also used search API for some parts of the search since recently.</p>

<p>GAE backends are quite useful for apps like ours where there is a lot of centralised processing (seaching). We will probably use it in the near future.</p>

<h2>Client</h2>

<p>We use <strong>jQuery</strong> for DOM manipulation, <strong>backbone.js</strong> for model-view architecture, and <strong>underscore.js</strong> for rendering with templates.</p>

<p>Backbone.js helps a lot to keep the javascript clean and structured. We also use backbone.js router for ajax navigation, which is pretty neat since it falls back to hash links if history API is not available.</p>

<p>Templating with underscore.js was quite handy, but we faced a small problem as backend rendering was done with django templates - we had to maintain two sets of templates. We are planning to use mustache templates, which is supported by underscore.js and has python implementations.</p>

<p><strong>Twitter Bootstrap</strong>, default theme with a bunch of customizations, is used in the web version and <strong>jQuery Mobile</strong> is used for mobile version of the app. We launched the mobile version recently and it still has some small glitches with the jQuery Mobile implementation. We used responsive features of Bootstrap with some tweaks because the mobile specific version was introduced.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Passing file descriptors between processes using sendmsg() and recvmsg()]]></title>
    <link href="http://vpj.github.com/blog/2011/01/07/passing-file-descriptors-between-processes-using-sendmsg-and-recvmsg/"/>
    <updated>2011-01-07T10:53:00+05:30</updated>
    <id>http://vpj.github.com/blog/2011/01/07/passing-file-descriptors-between-processes-using-sendmsg-and-recvmsg</id>
    <content type="html"><![CDATA[<p>Using this technique you can pass file descriptors between processes using <code>sendmsg()</code> and <code>recvmsg()</code> functions using UNIX Domain Protocol. Any descriptor can be passed using this method not just a file descriptor.</p>

<p>This is quite useful when you want to balance load in a multi-core system. Other way of passing file descriptors is by forking the process, but in this case you can pass file descriptors between different processes at anytime.</p>

<h2>Creating the UNIX Domain Protocol server</h2>

<p><code>SOCKET_PATH</code> was set to <code>/tmp/unix_socket</code></p>

<figure class='code'><figcaption><span>Create Server  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">int</span> <span class="n">create_server</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'> <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'> <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="k">if</span> <span class="p">((</span><span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_LOCAL</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to create server socket&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'> <span class="n">addr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_LOCAL</span><span class="p">;</span>
</span><span class='line'> <span class="n">unlink</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">);</span>
</span><span class='line'> <span class="n">strcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">SOCKET_PATH</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span>
</span><span class='line'>                              <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to bind server socket&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">MAX_PENDING</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to listen on server socket&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="n">setnonblocking</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="cm">/* Add handler to handle events on fd */</span>
</span><span class='line'>
</span><span class='line'> <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I used epoll for handling events, so adding a handler was something like this.</p>

<figure class='code'><figcaption><span>Add Handlers  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">hash_set</span><span class="p">(</span><span class="n">ioloop</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">e</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'><span class="n">e</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="n">ioloop</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'> <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to insert handler to epoll&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Connections to the server should be accepted with accept() similar to TCP sockets.</p>

<h2>Connecting to the server</h2>

<figure class='code'><figcaption><span>Connecting to the server  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">int</span> <span class="n">connect_server</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'> <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'> <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="k">if</span> <span class="p">((</span><span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_LOCAL</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to create client socket&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'> <span class="n">addr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_LOCAL</span><span class="p">;</span>
</span><span class='line'> <span class="n">strcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">SOCKET_PATH</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span>
</span><span class='line'>             <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span>
</span><span class='line'>             <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to connect to server&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="n">setnonblocking</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="cm">/* Add handler to handle events */</span>
</span><span class='line'>
</span><span class='line'> <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I was adding <code>EPOLLOUT</code> listener to the socket whenever there were file descriptors to be passed to the other process.</p>

<h2>Receiving a file descriptor</h2>

<figure class='code'><figcaption><span>Receiving a file descriptor  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="n">recv_file_descriptor</span><span class="p">(</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">socket</span><span class="p">)</span> <span class="cm">/* Socket from which the file descriptor is read */</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="kt">int</span> <span class="n">sent_fd</span><span class="p">;</span>
</span><span class='line'> <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">message</span><span class="p">;</span>
</span><span class='line'> <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'> <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">control_message</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'> <span class="kt">char</span> <span class="n">ctrl_buf</span><span class="p">[</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))];</span>
</span><span class='line'> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'> <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msghdr</span><span class="p">));</span>
</span><span class='line'> <span class="n">memset</span><span class="p">(</span><span class="n">ctrl_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMSG_SPACE</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'> <span class="cm">/* For the dummy data */</span>
</span><span class='line'> <span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'> <span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="n">message</span><span class="p">.</span><span class="n">msg_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'> <span class="n">message</span><span class="p">.</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'> <span class="n">message</span><span class="p">.</span><span class="n">msg_control</span> <span class="o">=</span> <span class="n">ctrl_buf</span><span class="p">;</span>
</span><span class='line'> <span class="n">message</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="n">CMSG_SPACE</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span><span class='line'> <span class="n">message</span><span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="n">iov</span><span class="p">;</span>
</span><span class='line'> <span class="n">message</span><span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="k">if</span><span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">recvmsg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="cm">/* Iterate through header to find if there is a file descriptor */</span>
</span><span class='line'> <span class="k">for</span><span class="p">(</span><span class="n">control_message</span> <span class="o">=</span> <span class="n">CMSG_FIRSTHDR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">);</span>
</span><span class='line'>     <span class="n">control_message</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>     <span class="n">control_message</span> <span class="o">=</span> <span class="n">CMSG_NXTHDR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">,</span>
</span><span class='line'>                                   <span class="n">control_message</span><span class="p">))</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">control_message</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">==</span> <span class="n">SOL_SOCKET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>      <span class="p">(</span><span class="n">control_message</span><span class="o">-&gt;</span><span class="n">cmsg_type</span> <span class="o">==</span> <span class="n">SCM_RIGHTS</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">CMSG_DATA</span><span class="p">(</span><span class="n">control_message</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Sending a file descriptor</h2>

<figure class='code'><figcaption><span>Sending a file descriptor  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="n">send_file_descriptor</span><span class="p">(</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">socket</span><span class="p">,</span> <span class="cm">/* Socket through which the file descriptor is passed */</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">fd_to_send</span><span class="p">)</span> <span class="cm">/* File descriptor to be passed, could be another socket */</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">message</span><span class="p">;</span>
</span><span class='line'> <span class="k">struct</span> <span class="n">iovec</span> <span class="n">iov</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'> <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">control_message</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'> <span class="kt">char</span> <span class="n">ctrl_buf</span><span class="p">[</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))];</span>
</span><span class='line'> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'> <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msghdr</span><span class="p">));</span>
</span><span class='line'> <span class="n">memset</span><span class="p">(</span><span class="n">ctrl_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CMSG_SPACE</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'> <span class="cm">/* We are passing at least one byte of data so that recvmsg() will not return 0 */</span>
</span><span class='line'> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
</span><span class='line'> <span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'> <span class="n">iov</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="n">message</span><span class="p">.</span><span class="n">msg_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'> <span class="n">message</span><span class="p">.</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'> <span class="n">message</span><span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="n">iov</span><span class="p">;</span>
</span><span class='line'> <span class="n">message</span><span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'> <span class="n">message</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span>  <span class="n">CMSG_SPACE</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span><span class='line'> <span class="n">message</span><span class="p">.</span><span class="n">msg_control</span> <span class="o">=</span> <span class="n">ctrl_buf</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="n">control_message</span> <span class="o">=</span> <span class="n">CMSG_FIRSTHDR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">);</span>
</span><span class='line'> <span class="n">control_message</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">=</span> <span class="n">SOL_SOCKET</span><span class="p">;</span>
</span><span class='line'> <span class="n">control_message</span><span class="o">-&gt;</span><span class="n">cmsg_type</span> <span class="o">=</span> <span class="n">SCM_RIGHTS</span><span class="p">;</span>
</span><span class='line'> <span class="n">control_message</span><span class="o">-&gt;</span><span class="n">cmsg_len</span> <span class="o">=</span> <span class="n">CMSG_LEN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">CMSG_DATA</span><span class="p">(</span><span class="n">control_message</span><span class="p">))</span> <span class="o">=</span> <span class="n">fd_to_send</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="k">return</span> <span class="n">sendmsg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[TCP echo server example in C++ using epoll]]></title>
    <link href="http://vpj.github.com/blog/2011/01/02/tcp-echo-server-example-in-c-plus-plus-using-epoll/"/>
    <updated>2011-01-02T10:39:00+05:30</updated>
    <id>http://vpj.github.com/blog/2011/01/02/tcp-echo-server-example-in-c-plus-plus-using-epoll</id>
    <content type="html"><![CDATA[<p>This example is a simple server which accepts connections and echos whatever data sent to the server. This example also demonstrates the use of <strong>epoll</strong>, which is efficient than <strong>poll</strong>.
In epoll unlike poll all events that need to be monitored are not passed everytime the wait call is made. Epoll uses event registration where events to be watched can be added, modified or removed. This makes it efficient when there are a large number of events to be watched.</p>

<h2>IOLoop</h2>

<p>In this example the class IOLoop will deal with epoll interface and it will invoke relevant handlers based on events occurred.</p>

<figure class='code'><figcaption><span>IOLoop  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">IOLoop</span> <span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'> <span class="k">static</span> <span class="n">IOLoop</span> <span class="o">*</span> <span class="n">getInstance</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'> <span class="n">IOLoop</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="o">-&gt;</span><span class="n">epfd</span> <span class="o">=</span> <span class="n">epoll_create</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">EPOLL_EVENTS</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">epfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to create epoll&quot;</span><span class="p">);</span>
</span><span class='line'>   <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">void</span> <span class="n">start</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">nfds</span> <span class="o">=</span> <span class="n">epoll_wait</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">MAX_EVENTS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="cm">/* Timeout */</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nfds</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
</span><span class='line'>    <span class="n">Handler</span> <span class="o">*</span><span class="n">h</span> <span class="o">=</span> <span class="n">handlers</span><span class="p">[</span><span class="n">fd</span><span class="p">];</span>
</span><span class='line'>    <span class="n">h</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">void</span> <span class="n">addHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">Handler</span> <span class="o">*</span><span class="n">handler</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">events</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">handlers</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
</span><span class='line'>  <span class="n">epoll_event</span> <span class="n">e</span><span class="p">;</span>
</span><span class='line'>  <span class="n">e</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>  <span class="n">e</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">events</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to insert handler to epoll&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">void</span> <span class="n">modifyHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">events</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">void</span> <span class="n">removeHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Handlers used in this example are ServerHandler and EchoHandler which derive from class Handler. Handlers have a member function handle which handles the event occurred.</p>

<h2>ServerHandler</h2>

<p>ServerHandler will create a server socket and handle in coming connections</p>

<figure class='code'><figcaption><span>ServerHandler  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">ServerHandler</span> <span class="o">:</span> <span class="n">Handler</span> <span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'> <span class="n">ServerHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">((</span><span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to create server socket&quot;</span><span class="p">);</span>
</span><span class='line'>   <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'>  <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
</span><span class='line'>  <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
</span><span class='line'>                               <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to bind server socket&quot;</span><span class="p">);</span>
</span><span class='line'>   <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">MAX_PENDING</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to listen on server socket&quot;</span><span class="p">);</span>
</span><span class='line'>   <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">setnonblocking</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">IOLoop</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">EPOLLIN</span><span class="p">);</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="k">virtual</span> <span class="kt">int</span> <span class="n">handle</span><span class="p">(</span><span class="n">epoll_event</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">sockaddr_in</span> <span class="n">client_addr</span><span class="p">;</span>
</span><span class='line'>  <span class="n">socklen_t</span> <span class="n">ca_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">int</span> <span class="n">client</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span>
</span><span class='line'>                  <span class="o">&amp;</span><span class="n">ca_len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">client</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Error accepting connection&quot;</span><span class="p">);</span>
</span><span class='line'>   <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Client connected: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">client_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="k">new</span> <span class="n">EchoHandler</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Set Non-blocking</h2>

<p>Function setnonblocking sets the file descriptor setting to non-clocking.</p>

<figure class='code'><figcaption><span>Set Non-blocking  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>EchoHandler:handle</h2>

<p>EchoHandler will write whatever it reads from the socket</p>

<figure class='code'><figcaption><span>Handler  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">virtual</span> <span class="kt">int</span> <span class="n">handle</span><span class="p">(</span><span class="n">epoll_event</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'> <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLHUP</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">IOLoop</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLERR</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLOUT</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">received</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Writing: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="k">if</span> <span class="p">(</span><span class="n">send</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">received</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">received</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Error writing to socket&quot;</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">IOLoop</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">modifyHandler</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">EPOLLIN</span><span class="p">);</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">((</span><span class="n">received</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Error reading from socket&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">received</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">buffer</span><span class="p">[</span><span class="n">received</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Reading: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">buffer</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">received</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">IOLoop</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">modifyHandler</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">EPOLLOUT</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">IOLoop</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To test this you can use the client implemented in this site: . You can test out this server with multiple clients connecting at the same time to see how it works.</p>

<p>Error checking in this code is minimal so it will probably fail unexpectedly in certain scenarios which I have not come across yet. And please leave a comment if you do find any errors or if there are things that could be improved.</p>
]]></content>
  </entry>
  
</feed>
