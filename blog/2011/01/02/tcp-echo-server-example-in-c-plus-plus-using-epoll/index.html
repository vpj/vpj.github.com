
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>TCP echo server example in C++ using epoll - My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="This example is a simple server which accepts connections and echos whatever data sent to the server. This example also demonstrates the use of epoll &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://vpj.github.com/blog/2011/01/02/tcp-echo-server-example-in-c-plus-plus-using-epoll/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:vpj.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">TCP Echo Server Example in C++ Using Epoll</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-02T10:39:00+05:30" pubdate data-updated="true">Jan 2<span>nd</span>, 2011</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This example is a simple server which accepts connections and echos whatever data sent to the server. This example also demonstrates the use of <strong>epoll</strong>, which is efficient than <strong>poll</strong>.
In epoll unlike poll all events that need to be monitored are not passed everytime the wait call is made. Epoll uses event registration where events to be watched can be added, modified or removed. This makes it efficient when there are a large number of events to be watched.</p>

<h1>IOLoop</h1>

<p>In this example the class IOLoop will deal with epoll interface and it will invoke relevant handlers based on events occurred.</p>

<pre><code>#!cpp
class IOLoop {
...
 static IOLoop * getInstance();

 IOLoop() {
  this-&amp;gt;epfd = epoll_create(this-&amp;gt;EPOLL_EVENTS);

  if(this-&amp;gt;epfd &amp;lt; 0) {
   log_error("Failed to create epoll");
   exit(1);
  }
...
 }

 void start() {
  for(;;) {
   int nfds = epoll_wait(this-&amp;gt;epfd, this-&amp;gt;events, this-&amp;gt;MAX_EVENTS, -1 /* Timeout */);

   for(int i = 0; i &amp;lt; nfds; ++i) {
    int fd = this-&amp;gt;events[i].data.fd;
    Handler *h = handlers[fd];
    h-&amp;gt;handle(this-&amp;gt;events[i]);
   }
  }
 }

 void addHandler(int fd, Handler *handler, unsigned int events) {
  handlers[fd] = handler;
  epoll_event e;
  e.data.fd = fd;
  e.events = events;

  if(epoll_ctl(this-&amp;gt;epfd, EPOLL_CTL_ADD, fd, &amp;amp;e) &amp;lt; 0) {
   log_error("Failed to insert handler to epoll");
  }
 }

 void modifyHandler(int fd, unsigned int events);

 void removeHandler(int fd);
};
</code></pre>

<p>Handlers used in this example are ServerHandler and EchoHandler which derive from class Handler. Handlers have a member function handle which handles the event occurred.</p>

<h2>ServerHandler</h2>

<p>ServerHandler will create a server socket and handle in coming connections</p>

<figure class='code'><figcaption><span>ServerHandler ++ </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">class</span> <span class="n">ServerHandler</span> <span class="o">:</span> <span class="n">Handler</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">ServerHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">((</span><span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to create server socket&quot;</span><span class="p">);</span>
</span><span class='line'>       <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'>      <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
</span><span class='line'>      <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">addr</span><span class="p">,</span>
</span><span class='line'>                                   <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to bind server socket&quot;</span><span class="p">);</span>
</span><span class='line'>       <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">MAX_PENDING</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Failed to listen on server socket&quot;</span><span class="p">);</span>
</span><span class='line'>       <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">setnonblocking</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">IOLoop</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">EPOLLIN</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">virtual</span> <span class="kt">int</span> <span class="n">handle</span><span class="p">(</span><span class="n">epoll_event</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">sockaddr_in</span> <span class="n">client_addr</span><span class="p">;</span>
</span><span class='line'>      <span class="n">socklen_t</span> <span class="n">ca_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="kt">int</span> <span class="n">client</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">client_addr</span><span class="p">,</span>
</span><span class='line'>                      <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">ca_len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">client</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;Error accepting connection&quot;</span><span class="p">);</span>
</span><span class='line'>       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">cout</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="s">&quot;Client connected: &quot;</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">client_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">endl</span><span class="p">;</span>
</span><span class='line'>      <span class="n">new</span> <span class="nf">EchoHandler</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>setnonblocking</h2>

<p>Function setnonblocking sets the file descriptor setting to non-clocking.</p>

<pre><code>#!cpp
flags = fcntl(fd, F_GETFL, 0);
fcntl(fd, F_SETFL, flags | O_NONBLOCK);
</code></pre>

<h2>EchoHandler:handle</h2>

<p>EchoHandler will write whatever it reads from the socket</p>

<pre><code>#!cpp
virtual int handle(epoll_event e) {
 if(e.events &amp;amp; EPOLLHUP) {
  IOLoop::getInstance()-&amp;gt;removeHandler(fd);
  return -1;
 }

 if(e.events &amp;amp; EPOLLERR) {
  return -1;
 }

 if(e.events &amp;amp; EPOLLOUT) {
  if(received &amp;gt; 0) {
   cout &amp;lt;&amp;lt; "Writing: " &amp;lt;&amp;lt; buffer &amp;lt;&amp;lt; endl;
   if (send(fd, buffer, received, 0) != received) {
    log_error("Error writing to socket");
   }
  }

  IOLoop::getInstance()-&amp;gt;modifyHandler(fd, EPOLLIN);
 }

 if(e.events &amp;amp; EPOLLIN) {
  if ((received = recv(fd, buffer, BUFFER_SIZE, 0)) &amp;lt; 0) {
   log_error("Error reading from socket");
  } else if(received &amp;gt; 0) {
   buffer[received] = 0;
   cout &amp;lt;&amp;lt; "Reading: " &amp;lt;&amp;lt; buffer &amp;lt;&amp;lt; endl;
  }

  if(received &amp;gt; 0) {
   IOLoop::getInstance()-&amp;gt;modifyHandler(fd, EPOLLOUT);
  } else {
   IOLoop::getInstance()-&amp;gt;removeHandler(fd);
  }
 }

 return 0;
}
</code></pre>

<p>To test this you can use the client implemented in this site: . You can test out this server with multiple clients connecting at the same time to see how it works.</p>

<p>Error checking in this code is minimal so it will probably fail unexpectedly in certain scenarios which I have not come across yet. And please leave a comment if you do find any errors or if there are things that could be improved.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Your Name</span></span>

      








  


<time datetime="2011-01-02T10:39:00+05:30" pubdate data-updated="true">Jan 2<span>nd</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/c-/'>c++</a>, <a class='category' href='/blog/categories/epoll/'>epoll</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/tcp/'>tcp</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://vpj.github.com/blog/2011/01/02/tcp-echo-server-example-in-c-plus-plus-using-epoll/" data-via="" data-counturl="http://vpj.github.com/blog/2011/01/02/tcp-echo-server-example-in-c-plus-plus-using-epoll/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/01/02/tcp-echo-server-example-in-c-plus-plus-using-epoll/">TCP echo server example in C++ using epoll</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
