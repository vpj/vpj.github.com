<!DOCTYPE html><html>
 <head>
  <meta charset="utf-8">
  </meta>
  <title>
   Varuna Jayasiri
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </meta>
  <meta name="apple-mobile-web-app-capable" content="yes">
  </meta>
  <link href="http://fonts.googleapis.com/css?family=Raleway:400,100,200,300,500,600,700,800,900" rel="stylesheet" type="text/css">
  </link>
  <link href="lib/skeleton/css/skeleton.css" rel="stylesheet">
  </link>
  <link href="lib/highlightjs/styles/default.css" rel="stylesheet">
  </link>
  <link href="css/style.css" rel="stylesheet">
  </link>
  <link href="css/paginate.css" rel="stylesheet">
  </link>
  <link href="blog.css" rel="stylesheet">
  </link>
  <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-37809145-1', 'auto');
ga('send', 'pageview');
  </script>
 </head>
 <body>
  <div class="container wallapatta-container ">
   <div class="header ">
    <h1>
     <a href="index.html">
      VARUNA JAYASIRI
     </a>
    </h1>
    <a class="button " href="https://www.twitter.com/vpj">
     @vpj
    </a>
   </div>
   <div class="wallapatta ">
    <h1 class="title ">
     <a href="node_shm.html">
      Shared memory with Node.js
     </a>
    </h1>
    <h3 class="date ">
     May 13, 2015
    </h3>
    <div class="row ">
     <div class="wallapatta-main nine columns ">
      <div id="wallapatta_0" class="article"><div id="wallapatta_1" class="section"><div class="content"><p id="wallapatta_2" class="paragraph"><span id="wallapatta_92" class="text">This is more like a tutorial on writing a simple node.js add-on to share memory among node.js processes.</span></p></div></div><div id="wallapatta_3" class="section"><div class="content"><p id="wallapatta_4" class="paragraph"><span id="wallapatta_93" class="text">One of the limitations of node.js/io.js is that they are single threaded. Only way to use multiple cores in the processor is to run multiple processes</span><sup id="wallapatta_94" class="superScript"><span id="wallapatta_95" class="text">1</span></sup><span id="wallapatta_96" class="text">. But then you are working on different memory spaces. So it doesn't help if you want multiple processes working on  the same memory block. This is required in memory intensive tasks that cannot be efficiently sharded.</span></p></div></div><div id="wallapatta_8" class="section"><div class="content"><p id="wallapatta_9" class="paragraph"><span id="wallapatta_102" class="text">All the source code is available in </span><a id="wallapatta_103" class="link" href="https://github.com/vpj/node_shm">Github</a><span id="wallapatta_104" class="text">.</span></p></div></div><div id="wallapatta_10" class="section"><h1 class="heading"><span id="wallapatta_11" class="block"><span id="wallapatta_105" class="text">Node addon</span></span></h1><div class="content"><div id="wallapatta_12" class="section"><div class="content"><p id="wallapatta_13" class="paragraph"><span id="wallapatta_106" class="text">You need </span><code id="wallapatta_107" class="code"><span id="wallapatta_108" class="text">node-gyp</span></code><span id="wallapatta_109" class="text"> installed to build the node module.</span></p></div></div><pre id="wallapatta_14" class="codeBlock"><code class="nohighlight">npm install node-gyp -g</code></pre><div id="wallapatta_15" class="section"><div class="content"><p id="wallapatta_16" class="paragraph"><span id="wallapatta_110" class="text">I think the node.js version matters as the addon api has changed. I was working on node </span><em id="wallapatta_111" class="italics"><span id="wallapatta_112" class="text">0.12.2</span></em><span id="wallapatta_113" class="text">, when I tested this out.</span></p></div></div><div id="wallapatta_17" class="section"><div class="content"><p id="wallapatta_18" class="paragraph"><code id="wallapatta_114" class="code"><span id="wallapatta_115" class="text">binding.gyp</span></code><span id="wallapatta_116" class="text"> is required by node-gyp to build the addon.</span></p></div></div><div id="wallapatta_19" class="section"><div class="content"><p id="wallapatta_20" class="paragraph"><span id="wallapatta_117" class="text">Then comes </span><code id="wallapatta_118" class="code"><span id="wallapatta_119" class="text">shm_addon.cpp</span></code><span id="wallapatta_120" class="text">. This is a very basic addon that has one export </span><code id="wallapatta_121" class="code"><span id="wallapatta_122" class="text">createSHM</span></code><span id="wallapatta_123" class="text">, which creates a shared memory block of 800,000 bytes (attaches if exists) with read &amp; write permission to all users</span><sup id="wallapatta_124" class="superScript"><span id="wallapatta_125" class="text">2</span></sup><span id="wallapatta_126" class="text">.</span></p></div></div><div id="wallapatta_24" class="section"><div class="content"><p id="wallapatta_25" class="paragraph"><span id="wallapatta_140" class="text">Shared memory is allocated with </span><code id="wallapatta_141" class="code"><span id="wallapatta_142" class="text">shmget</span></code><span id="wallapatta_143" class="text"> and attached to the address space of the process with </span><code id="wallapatta_144" class="code"><span id="wallapatta_145" class="text">shmat</span></code><span id="wallapatta_146" class="text">.</span></p></div></div><pre id="wallapatta_26" class="codeBlock"><code class="cpp">shmid = shmget( key, MEM, IPC_CREAT | <span class="hljs-number">0666</span> );
data = (<span class="hljs-keyword">char</span> *)shmat( shmid, NULL, <span class="hljs-number">0</span> );</code></pre><div id="wallapatta_27" class="section"><div class="content"><p id="wallapatta_28" class="paragraph"><span id="wallapatta_147" class="text">It keeps a pointer to the memory block and returns it if </span><code id="wallapatta_148" class="code"><span id="wallapatta_149" class="text">createSHM</span></code><span id="wallapatta_150" class="text"> is called twice by the same node.js program</span><sup id="wallapatta_151" class="superScript"><span id="wallapatta_152" class="text">3</span></sup><span id="wallapatta_153" class="text">. </span><code id="wallapatta_154" class="code"><span id="wallapatta_155" class="text">createSHM</span></code><span id="wallapatta_156" class="text"> returns an </span><code id="wallapatta_157" class="code"><span id="wallapatta_158" class="text">ArrayBuffer</span></code><span id="wallapatta_159" class="text">, initialized with the pointer to the shared memory.</span></p></div></div><pre id="wallapatta_32" class="codeBlock"><code class="cpp">Local&lt;ArrayBuffer&gt; buffer = ArrayBuffer::New(isolate, (<span class="hljs-keyword">void</span> *)data, MEM);</code></pre><div id="wallapatta_33" class="section"><div class="content"><p id="wallapatta_34" class="paragraph"><span id="wallapatta_174" class="text">The node module </span><code id="wallapatta_175" class="code"><span id="wallapatta_176" class="text">shm_addon</span></code><span id="wallapatta_177" class="text"> is built with node-gyp with following commands.</span></p></div></div><pre id="wallapatta_35" class="codeBlock"><code class="nohighlight">node-gyp configure
node-gyp build</code></pre><div id="wallapatta_36" class="section"><div class="content"><p id="wallapatta_37" class="paragraph"><span id="wallapatta_178" class="text">The node addon will be created in </span><code id="wallapatta_179" class="code"><span id="wallapatta_180" class="text">build/Release/shm_addon.node</span></code><span id="wallapatta_181" class="text">.</span></p></div></div></div></div><div id="wallapatta_38" class="section"><h1 class="heading"><span id="wallapatta_39" class="block"><span id="wallapatta_182" class="text">Parent and child programs</span></span></h1><div class="content"><div id="wallapatta_40" class="section"><div class="content"><p id="wallapatta_41" class="paragraph"><span id="wallapatta_183" class="text">This is a simple counting problem to illustrate how shared memory can be used. We will populate the array of 200,000 32-bit integers with the sequence </span><code id="wallapatta_184" class="code"><span id="wallapatta_185" class="text">0,1,2,...998,999,0,1,2,..998,999,0,1,2,...</span></code><span id="wallapatta_186" class="text">. So there are 200 positions with each integer between 0 and 999. Each of the child programs (workers) will count the number of occurrences of each integer between 0 and 999 by inefficiently traversing the array a 1,000 times.</span></p></div></div><div id="wallapatta_45" class="section"><div class="content"><p id="wallapatta_46" class="paragraph"><code id="wallapatta_190" class="code"><span id="wallapatta_191" class="text">spawn.coffee</span></code><span id="wallapatta_192" class="text"> is the parent program that starts the child processes. </span><code id="wallapatta_193" class="code"><span id="wallapatta_194" class="text">child.coffee</span></code><span id="wallapatta_195" class="text"> is the child program.</span></p></div></div><div id="wallapatta_47" class="section"><div class="content"><p id="wallapatta_48" class="paragraph"><span id="wallapatta_196" class="text">Shared memory is attached by parent program and child program by calling the node addon.</span></p></div></div><pre id="wallapatta_49" class="codeBlock"><code class="coffee">shm = <span class="hljs-built_in">require</span> <span class="hljs-string">'./build/Release/shm_addon'</span>
a = <span class="hljs-keyword">new</span> Int32Array shm.createSHM()</code></pre><div id="wallapatta_50" class="section"><div class="content"><p id="wallapatta_51" class="paragraph"><span id="wallapatta_197" class="text">We are calculating the time taken for the child processes to count. Time it takes for processes to get spawn and exit is excluded. Therefore the child processes start counting when they receive something in the </span><em id="wallapatta_198" class="italics"><span id="wallapatta_199" class="text">standard input</span></em><span id="wallapatta_200" class="text">. Number of child processes can be set with </span><code id="wallapatta_201" class="code"><span id="wallapatta_202" class="text">CHILDREN</span></code><span id="wallapatta_203" class="text">.</span></p></div></div><pre id="wallapatta_52" class="codeBlock"><code class="coffee">process.stdin.<span class="hljs-literal">on</span> <span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-params">(msg)</span> -&gt;</span>
start()</code></pre><div id="wallapatta_53" class="section"><div class="content"><p id="wallapatta_54" class="paragraph"><span id="wallapatta_204" class="text">Running </span><code id="wallapatta_205" class="code"><span id="wallapatta_206" class="text">coffee spawn.coffee</span></code><span id="wallapatta_207" class="text"> will start processes and do the counting and show the time it took to complete.</span></p></div></div><div id="wallapatta_55" class="section"><div class="content"><p id="wallapatta_56" class="paragraph"><span id="wallapatta_208" class="text">You can take a look at shared memory allocated by running command </span><code id="wallapatta_209" class="code"><span id="wallapatta_210" class="text">ipcs</span></code><span id="wallapatta_211" class="text">.</span></p></div></div><pre id="wallapatta_57" class="codeBlock"><code class="nohighlight">IPC status from &lt;running system&gt; as of Tue Apr 14 13:58:16 IST 2015
T     ID     KEY        MODE       OWNER    GROUP
Shared Memory:
m  65536 0x000019a5 --rw-rw-rw- varunajayasiri    staff
m  65537 0x000019a4 --rw-rw-rw- varunajayasiri    staff
m  65538 0x000019a2 --rw-rw-rw- varunajayasiri    staff</code></pre></div></div><div id="wallapatta_58" class="section"><h1 class="heading"><span id="wallapatta_59" class="block"><span id="wallapatta_212" class="text">Results</span></span></h1><div class="content"><div id="wallapatta_60" class="section"><div class="content"><p id="wallapatta_61" class="paragraph"><code id="wallapatta_213" class="code"><span id="wallapatta_214" class="text">bench.coffee</span></code><span id="wallapatta_215" class="text"> was used to find the time a single process takes to count.</span></p></div></div><div id="wallapatta_62" class="section"><div class="content"><p id="wallapatta_63" class="paragraph"><a id="wallapatta_216" class="link" href="https://twitter.com/chethiyaa">@chethiyaa</a><span id="wallapatta_217" class="text"> did some testing on a </span><strong id="wallapatta_218" class="bold"><span id="wallapatta_219" class="text">quad core i7</span></strong><span id="wallapatta_220" class="text">.</span></p></div></div><table id="wallapatta_64" class="table"><thead><tr><th colspan="1"><span id="wallapatta_65" class="block"><span id="wallapatta_221" class="text"># children</span></span></th><th colspan="1"><span id="wallapatta_66" class="block"><span id="wallapatta_222" class="text">single process (ms)</span></span></th><th colspan="2"><span id="wallapatta_67" class="block"><span id="wallapatta_223" class="text">multi process (ms)</span></span></th></tr></thead><tbody><tr><td colspan="1"><span id="wallapatta_68" class="block"><span id="wallapatta_224" class="text">1</span></span></td><td colspan="1"><span id="wallapatta_69" class="block"><span id="wallapatta_225" class="text">398</span></span></td><td colspan="2"><span id="wallapatta_70" class="block"><span id="wallapatta_226" class="text">430</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_71" class="block"><span id="wallapatta_227" class="text">2</span></span></td><td colspan="1"><span id="wallapatta_72" class="block"><span id="wallapatta_228" class="text">782</span></span></td><td colspan="2"><span id="wallapatta_73" class="block"><span id="wallapatta_229" class="text">394</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_74" class="block"><span id="wallapatta_230" class="text">4</span></span></td><td colspan="1"><span id="wallapatta_75" class="block"><span id="wallapatta_231" class="text">1626</span></span></td><td colspan="2"><span id="wallapatta_76" class="block"><span id="wallapatta_232" class="text">415</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_77" class="block"><span id="wallapatta_233" class="text">8</span></span></td><td colspan="1"><span id="wallapatta_78" class="block"><span id="wallapatta_234" class="text">3300</span></span></td><td colspan="2"><span id="wallapatta_79" class="block"><span id="wallapatta_235" class="text">799</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_80" class="block"><span id="wallapatta_236" class="text">16</span></span></td><td colspan="1"><span id="wallapatta_81" class="block"><span id="wallapatta_237" class="text">6285</span></span></td><td colspan="2"><span id="wallapatta_82" class="block"><span id="wallapatta_238" class="text">1594</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_83" class="block"><span id="wallapatta_239" class="text">32</span></span></td><td colspan="1"><span id="wallapatta_84" class="block"></span></td><td colspan="2"><span id="wallapatta_85" class="block"><span id="wallapatta_240" class="text">3183</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_86" class="block"><span id="wallapatta_241" class="text">64</span></span></td><td colspan="1"><span id="wallapatta_87" class="block"></span></td><td colspan="2"><span id="wallapatta_88" class="block"><span id="wallapatta_242" class="text">6372</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_89" class="block"><span id="wallapatta_243" class="text">128</span></span></td><td colspan="1"><span id="wallapatta_90" class="block"></span></td><td colspan="2"><span id="wallapatta_91" class="block"><span id="wallapatta_244" class="text">13049</span></span></td></tr></tbody></table></div></div></div>
     </div>
     <div class="wallapatta-sidebar three columns ">
      <div id="wallapatta_5" class="sidenote"><div id="wallapatta_6" class="section"><div class="content"><p id="wallapatta_7" class="paragraph"><sup id="wallapatta_97" class="superScript"><span id="wallapatta_98" class="text">1</span></sup><span id="wallapatta_99" class="text"> Node modules like </span><a id="wallapatta_100" class="link" href="http://adambom.github.io/parallel.js/">parallel.js</a><span id="wallapatta_101" class="text"> fork new processes when on node  and use web workers on browser.</span></p></div></div></div><div id="wallapatta_21" class="sidenote"><div id="wallapatta_22" class="section"><div class="content"><p id="wallapatta_23" class="paragraph"><sup id="wallapatta_127" class="superScript"><span id="wallapatta_128" class="text">2</span></sup><span id="wallapatta_129" class="text"> </span><code id="wallapatta_130" class="code"><span id="wallapatta_131" class="text">shmget</span></code><span id="wallapatta_132" class="text"> (</span><a id="wallapatta_133" class="link" href="http://man7.org/linux/man-pages/man2/shmget.2.html">documentation</a><span id="wallapatta_134" class="text">) allocates shared memory and </span><code id="wallapatta_135" class="code"><span id="wallapatta_136" class="text">shmat</span></code><span id="wallapatta_137" class="text"> (</span><a id="wallapatta_138" class="link" href="http://man7.org/linux/man-pages/man2/shmat.2.html">documentation</a><span id="wallapatta_139" class="text">) attaches the shared memory block.</span></p></div></div></div><div id="wallapatta_29" class="sidenote"><div id="wallapatta_30" class="section"><div class="content"><p id="wallapatta_31" class="paragraph"><sup id="wallapatta_160" class="superScript"><span id="wallapatta_161" class="text">3</span></sup><span id="wallapatta_162" class="text"> Since the </span><code id="wallapatta_163" class="code"><span id="wallapatta_164" class="text">ArrayBuffer</span></code><span id="wallapatta_165" class="text"> is constructed with a memory pointer, it will be </span><code id="wallapatta_166" class="code"><span id="wallapatta_167" class="text">external</span></code><span id="wallapatta_168" class="text">. That is the memory will not be garbage collected and the addon will have to free the memory. Here's the </span><strong id="wallapatta_169" class="bold"><span id="wallapatta_170" class="text">v8</span></strong><span id="wallapatta_171" class="text"> documentation to </span><a id="wallapatta_172" class="link" href="http://bespin.cz/~ondras/html/classv8_1_1ArrayBuffer.html">ArrayBuffer</a><span id="wallapatta_173" class="text">.</span></p></div></div></div><div id="wallapatta_42" class="sidenote"><div id="wallapatta_43" class="section"><div class="content"><p id="wallapatta_44" class="paragraph"><span id="wallapatta_187" class="text">Shared memory limits are quite small by default. So trying to allocate a lot of shared memory will give errors. This </span><a id="wallapatta_188" class="link" href="http://seriousbirder.com/blogs/linux-understanding-shmmax-and-shmall-settings/">article</a><span id="wallapatta_189" class="text"> gives details on changing and viewing these settings.</span></p></div></div></div>
     </div>
     <div style="display:none;">
      <div class='wallapatta-code'>
This is more like a tutorial on writing a simple node.js add-on to share memory among node.js processes.

One of the limitations of node.js/io.js is that they are single threaded. Only way to use multiple cores in the processor is to run multiple processes^^1^^. But then you are working on different memory spaces. So it doesn't help if you want multiple processes working on  the same memory block. This is required in memory intensive tasks that cannot be efficiently sharded.

>>>
 ^^1^^ Node modules like <<http://adambom.github.io/parallel.js/(parallel.js)>> fork new processes when on node  and use web workers on browser.

All the source code is available in <<https://github.com/vpj/node_shm(Github)>>.

#Node addon

 You need ``node-gyp`` installed to build the node module.

 ```
  npm install node-gyp -g

 I think the node.js version matters as the addon api has changed. I was working on node --0.12.2--, when I tested this out.

 ``binding.gyp`` is required by node-gyp to build the addon.

 Then comes ``shm_addon.cpp``. This is a very basic addon that has one export ``createSHM``, which creates a shared memory block of 800,000 bytes (attaches if exists) with read & write permission to all users^^2^^.

 >>>
  ^^2^^ ``shmget`` (<<http://man7.org/linux/man-pages/man2/shmget.2.html(documentation)>>) allocates shared memory and ``shmat`` (<<http://man7.org/linux/man-pages/man2/shmat.2.html(documentation)>>) attaches the shared memory block.


 Shared memory is allocated with ``shmget`` and attached to the address space of the process with ``shmat``.

 ```cpp
  shmid = shmget( key, MEM, IPC_CREAT | 0666 );
  data = (char *)shmat( shmid, NULL, 0 );

 It keeps a pointer to the memory block and returns it if ``createSHM`` is called twice by the same node.js program^^3^^. ``createSHM`` returns an ``ArrayBuffer``, initialized with the pointer to the shared memory.

 >>>
  ^^3^^ Since the ``ArrayBuffer`` is constructed with a memory pointer, it will be ``external``. That is the memory will not be garbage collected and the addon will have to free the memory. Here's the **v8** documentation to <<http://bespin.cz/~ondras/html/classv8_1_1ArrayBuffer.html(ArrayBuffer)>>.

 ```cpp
  Local<ArrayBuffer> buffer = ArrayBuffer::New(isolate, (void *)data, MEM);

 The node module ``shm_addon`` is built with node-gyp with following commands.

 ```
  node-gyp configure
  node-gyp build

 The node addon will be created in ``build/Release/shm_addon.node``.

#Parent and child programs

 This is a simple counting problem to illustrate how shared memory can be used. We will populate the array of 200,000 32-bit integers with the sequence
 ``0,1,2,...998,999,0,1,2,..998,999,0,1,2,...``. So there are 200 positions with each integer between 0 and 999. Each of the child programs (workers) will count the number of occurrences of each integer between 0 and 999 by inefficiently traversing the array a 1,000 times.

 >>>
  Shared memory limits are quite small by default. So trying to allocate a lot of shared memory will give errors. This <<http://seriousbirder.com/blogs/linux-understanding-shmmax-and-shmall-settings/(article)>> gives details on changing and viewing these settings.


 ``spawn.coffee`` is the parent program that starts the child processes. ``child.coffee`` is the child program.

 Shared memory is attached by parent program and child program by calling the node addon.

 ```coffee
  shm = require './build/Release/shm_addon'
  a = new Int32Array shm.createSHM()

 We are calculating the time taken for the child processes to count. Time it takes for processes to get spawn and exit is excluded. Therefore the child processes start counting when they receive something in the --standard input--. Number of child processes can be set with ``CHILDREN``.

 ```coffee
  process.stdin.on 'data', (msg) ->
  start()

 Running ``coffee spawn.coffee`` will start processes and do the counting and show the time it took to complete.

 You can take a look at shared memory allocated by running command ``ipcs``.

 ```
  IPC status from <running system> as of Tue Apr 14 13:58:16 IST 2015
  T     ID     KEY        MODE       OWNER    GROUP
  Shared Memory:
  m  65536 0x000019a5 --rw-rw-rw- varunajayasiri    staff
  m  65537 0x000019a4 --rw-rw-rw- varunajayasiri    staff
  m  65538 0x000019a2 --rw-rw-rw- varunajayasiri    staff

#Results

 ``bench.coffee`` was used to find the time a single process takes to count.

 <<https://twitter.com/chethiyaa(@chethiyaa)>> did some testing on a **quad core i7**.


 |||
  | # children | single process (ms) | multi process (ms) |
  ===
  | 1 | 398 | 430 |
  | 2 | 782 | 394 |
  | 4 | 1626 | 415 |
  | 8 | 3300 | 799 |
  | 16 | 6285 | 1594 |
  | 32 | | 3183 |
  | 64 | | 6372 |
  | 128	 | | 13049 |

</div>
     </div>
    </div>
   </div>
   <div class="wallapatta ">
    <h1 class="title ">
     <a href="dark_light.html">
      Black or White
     </a>
    </h1>
    <h3 class="date ">
     July 27, 2014
    </h3>
    <div class="row ">
     <div class="wallapatta-main nine columns ">
      <div id="wallapatta_10000" class="article"><div id="wallapatta_10001" class="section"><div class="content"><p id="wallapatta_10002" class="paragraph"><span id="wallapatta_10046" class="text">Which background is better? Most text editors and document readers have light backgrounds. But there's a lot of programmers who use dark backgrounds. And there are a some analytics and dashboard applications with dark backgrounds.</span></p></div></div><div id="wallapatta_10003" class="image-container"><img class="image" src="img/dark.png" alt="img/dark.png"></div><div id="wallapatta_10004" class="section"><div class="content"><p id="wallapatta_10005" class="paragraph"><span id="wallapatta_10047" class="text">Stephan Few has criticized using dark backgrounds for dashboards in his book </span><a id="wallapatta_10048" class="link" href="http://www.amazon.com/Information-Dashboard-Design-At-Glance/dp/1938377001">Information Dashboard Design</a><span id="wallapatta_10049" class="text">, citing an image of </span><a id="wallapatta_10050" class="link" href="http://roambi.com">Roambi</a><span id="wallapatta_10051" class="text">. By the way, Roambi later moved to a white background and then brought back the option of dark backgrounds.</span></p></div></div><div id="wallapatta_10006" class="special"><div id="wallapatta_10007" class="section"><div class="content"><p id="wallapatta_10008" class="paragraph"><span id="wallapatta_10052" class="text">Have you noticed that many business intelligence (BI) software companies have introduced black screens as the standard for mobile devices? Is this because mobile devices work better with black screens? If you look for the research, as I have, it isn’t likely that you’ll find any.</span></p></div></div><div id="wallapatta_10009" class="section"><div class="content"><p id="wallapatta_10010" class="paragraph"><span id="wallapatta_10053" class="text">No one seems to question the efficacy of light backgrounds for reading text. Why the difference? Text and graphics both involve objects that are constructed of lines and filled in areas of color. Do they differ in a way that demands a different background color? I don’t think so.</span></p></div></div></div><div id="wallapatta_10014" class="section"><div class="content"><p id="wallapatta_10015" class="paragraph"><span id="wallapatta_10056" class="text">In the above article he discusses arguments by vendors who use dark backgrounds. Most of the arguments he has considered are technical (battery saving, sunlight reflection) and doesn't discuss which is better if technology wasn't a constraint. I feel the discussion is biased towards light backgrounds.</span></p></div></div><div id="wallapatta_10016" class="section"><div class="content"><p id="wallapatta_10017" class="paragraph"><span id="wallapatta_10057" class="text">The article is based on the idea that because white backgrounds are used in editors and readers for a long time, it is better to stick to it until there is solid evidence that dark backgrounds are better.</span></p></div></div><div id="wallapatta_10018" class="section"><div class="content"><p id="wallapatta_10019" class="paragraph"><span id="wallapatta_10058" class="text">Editing and reading software use white backgrounds to mimic paper. Paper is whitish and has been there for centuries. However that was probably because of technological limitations on paper and ink colors. It was not a decision based evidence that white backgrounds are perceptually better.</span></p></div></div><div id="wallapatta_10020" class="section"><div class="content"><p id="wallapatta_10021" class="paragraph"><span id="wallapatta_10059" class="text">Edward Tufte has brought it up in one of his discussions.</span></p></div></div><div id="wallapatta_10022" class="special"><div id="wallapatta_10023" class="section"><div class="content"><p id="wallapatta_10024" class="paragraph"><span id="wallapatta_10060" class="text">The usual metaphor for screens (projection and computer) these days seems to be black type on a white background, that is, a paper metaphor. This sometimes results in video glare, with lots of rays coming from the background. Sometimes the old fashioned computer screen seems less tiring, showing lit-up text on a dead backround.</span></p></div></div></div><div id="wallapatta_10028" class="section"><div class="content"><p id="wallapatta_10029" class="paragraph"><span id="wallapatta_10063" class="text">Then he continues to discuss why his website has a light background.</span></p></div></div><div id="wallapatta_10030" class="special"><div id="wallapatta_10031" class="section"><div class="content"><p id="wallapatta_10032" class="paragraph"><span id="wallapatta_10064" class="text">But my metaphor here is paper, like a book. If reproduced on a dark background, my images (which are generally very light in value) would come blaring and glaring out of the dark surround.</span></p></div></div><div id="wallapatta_10033" class="section"><div class="content"><p id="wallapatta_10034" class="paragraph"><span id="wallapatta_10065" class="text">Light backgrounds produce video glare. So turn the screen brightness at night and after working many hours at the computer. It is often useful to dull down the electric-blue white of the computer screen with a soft background tone, as done here.</span></p></div></div></div><div id="wallapatta_10038" class="section"><div class="content"><p id="wallapatta_10039" class="paragraph"><span id="wallapatta_10068" class="text">I feel what needs to be considered is how people use your application. If they switch between your application and other applications with light backgrounds (e.g. websites, editors, physical paper), then you should consider a light background. It won't happen the other way around often since majority of software uses light backgrounds, with the exception of photo editors.</span></p></div></div><div id="wallapatta_10040" class="section"><div class="content"><p id="wallapatta_10041" class="paragraph"><span id="wallapatta_10069" class="text">If the software is used in isolation, dark or light wouldn't make a big difference. Then the factors such as device, power consumption, coolness (aesthetics) and glare can be considered.</span></p></div></div><div id="wallapatta_10042" class="image-container"><img class="image" src="img/light.png" alt="img/light.png"></div></div>
     </div>
     <div class="wallapatta-sidebar three columns ">
      <div id="wallapatta_10011" class="sidenote"><div id="wallapatta_10012" class="section"><div class="content"><p id="wallapatta_10013" class="paragraph"><strong id="wallapatta_10054" class="bold"><a id="wallapatta_10055" class="link" href="http://www.perceptualedge.com/blog/?p=1445">Stephan Few</a></strong></p></div></div></div><div id="wallapatta_10025" class="sidenote"><div id="wallapatta_10026" class="section"><div class="content"><p id="wallapatta_10027" class="paragraph"><strong id="wallapatta_10061" class="bold"><a id="wallapatta_10062" class="link" href="http://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=000082">Edward Tufte</a></strong></p></div></div></div><div id="wallapatta_10035" class="sidenote"><div id="wallapatta_10036" class="section"><div class="content"><p id="wallapatta_10037" class="paragraph"><strong id="wallapatta_10066" class="bold"><a id="wallapatta_10067" class="link" href="http://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=0000M0">Edward Tufte</a></strong></p></div></div></div><div id="wallapatta_10043" class="sidenote"><div id="wallapatta_10044" class="section"><div class="content"><p id="wallapatta_10045" class="paragraph"><span id="wallapatta_10070" class="text">There dark and light screenshots are still WIP. We were trying different backgrounds to see which is better. When placed inside this blog, the screenshot with light background looks a lot better because of the surrounding.*</span></p></div></div></div>
     </div>
     <div style="display:none;">
      <div class='wallapatta-code'>Which background is better? Most text editors and document readers have light backgrounds. But there's a lot of programmers who use dark backgrounds. And there are a some analytics and dashboard applications with dark backgrounds.

!img/dark.png

Stephan Few has criticized using dark backgrounds for dashboards in his book <<http://www.amazon.com/Information-Dashboard-Design-At-Glance/dp/1938377001(Information Dashboard Design)>>, citing an image of <<http://roambi.com(Roambi)>>. By the way, Roambi later moved to a white background and then brought back the option of dark backgrounds.

+++
 Have you noticed that many business intelligence (BI) software companies have introduced black screens as the standard for mobile devices? Is this because mobile devices work better with black screens? If you look for the research, as I have, it isn’t likely that you’ll find any.

 No one seems to question the efficacy of light backgrounds for reading text. Why the difference? Text and graphics both involve objects that are constructed of lines and filled in areas of color. Do they differ in a way that demands a different background color? I don’t think so.

>>>
 **<<http://www.perceptualedge.com/blog/?p=1445(Stephan Few)>>

In the above article he discusses arguments by vendors who use dark backgrounds. Most of the arguments he has considered are technical (battery saving, sunlight reflection) and doesn't discuss which is better if technology wasn't a constraint. I feel the discussion is biased towards light backgrounds.

The article is based on the idea that because white backgrounds are used in editors and readers for a long time, it is better to stick to it until there is solid evidence that dark backgrounds are better.

Editing and reading software use white backgrounds to mimic paper. Paper is whitish and has been there for centuries. However that was probably because of technological limitations on paper and ink colors. It was not a decision based evidence that white backgrounds are perceptually better.

Edward Tufte has brought it up in one of his discussions.

+++
 The usual metaphor for screens (projection and computer) these days seems to be black type on a white background, that is, a paper metaphor. This sometimes results in video glare, with lots of rays coming from the background. Sometimes the old fashioned computer screen seems less tiring, showing lit-up text on a dead backround.

>>>
 **<<http://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=000082(Edward Tufte)>>

Then he continues to discuss why his website has a light background.

+++
 But my metaphor here is paper, like a book. If reproduced on a dark background, my images (which are generally very light in value) would come blaring and glaring out of the dark surround.

 Light backgrounds produce video glare. So turn the screen brightness at night and after working many hours at the computer. It is often useful to dull down the electric-blue white of the computer screen with a soft background tone, as done here.

>>>
 **<<http://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=0000M0(Edward Tufte)>>

I feel what needs to be considered is how people use your application. If they switch between your application and other applications with light backgrounds (e.g. websites, editors, physical paper), then you should consider a light background. It won't happen the other way around often since majority of software uses light backgrounds, with the exception of photo editors.

If the software is used in isolation, dark or light wouldn't make a big difference. Then the factors such as device, power consumption, coolness (aesthetics) and glare can be considered.

!img/light.png

>>>
 There dark and light screenshots are still WIP. We were trying different backgrounds to see which is better. When placed inside this blog, the screenshot with light background looks a lot better because of the surrounding.*</div>
     </div>
    </div>
   </div>
   <div class="wallapatta ">
    <h1 class="title ">
     <a href="weya.html">
      Weya.coffee
     </a>
    </h1>
    <h3 class="date ">
     March 19, 2014
    </h3>
    <div class="row ">
     <div class="wallapatta-main nine columns ">
      <div id="wallapatta_20000" class="article"><div id="wallapatta_20001" class="section"><div class="content"><p id="wallapatta_20002" class="paragraph"><span id="wallapatta_20038" class="text">Weya.coffee is a lightweight library with no dependencies to generate DOM elements. We developed it to replace </span><a id="wallapatta_20039" class="link" href="https://github.com/gradus/coffeecup">Coffeecup</a><span id="wallapatta_20040" class="text"> as a client side template engine. Because of its simplicity and performance, we are also using Weya to replace DOM manipulation of </span><a id="wallapatta_20041" class="link" href="http://d3js.org/">d3.js</a><span id="wallapatta_20042" class="text"> in data visualizations.</span></p></div></div><div id="wallapatta_20009" class="section"><div class="content"><p id="wallapatta_20010" class="paragraph"><span id="wallapatta_20045" class="text">Here's a small example to show the usage.</span></p></div></div><pre id="wallapatta_20011" class="codeBlock"><code class="coffee">userElems = []
Weya container, <span class="hljs-function">-&gt;</span>
 <span class="hljs-property">@div</span> <span class="hljs-string">".users"</span>, <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">for</span> user, i <span class="hljs-keyword">in</span> users
   userDiv = <span class="hljs-property">@div</span> <span class="hljs-string">'.user'</span>, <span class="hljs-attribute">on</span>: {<span class="hljs-attribute">click</span>: editUser}, <span class="hljs-function">-&gt;</span>
    name = <span class="hljs-property">@span</span> <span class="hljs-string">".name"</span>, user.name
    <span class="hljs-property">@span</span> <span class="hljs-string">".phone"</span>, user.phone
    <span class="hljs-keyword">if</span> v.image?
     <span class="hljs-property">@img</span> <span class="hljs-attribute">src</span>: user.image

   userDiv.userId = i
   userElems.push <span class="hljs-attribute">user</span>: user, <span class="hljs-attribute">name</span>: name</code></pre><div id="wallapatta_20012" class="section"><div class="content"><p id="wallapatta_20013" class="paragraph"><span id="wallapatta_20046" class="text">The above code creates a list of users. It binds the data to the dom element </span><code id="wallapatta_20047" class="code"><span id="wallapatta_20048" class="text">userDiv.userId = i</span></code><span id="wallapatta_20049" class="text"> and also keeps track of all the DOM elements in </span><code id="wallapatta_20050" class="code"><span id="wallapatta_20051" class="text">userElems</span></code><span id="wallapatta_20052" class="text">. This is important if you want to manipulate the DOM without reloading the entire user list, for example if a name of a user changes you could change it with </span><code id="wallapatta_20053" class="code"><span id="wallapatta_20054" class="text">userElems[changedUserId].name.textContent = changedUserName</span></code><span id="wallapatta_20055" class="text">.</span></p></div></div><div id="wallapatta_20014" class="section"><h1 class="heading"><span id="wallapatta_20015" class="block"><span id="wallapatta_20056" class="text">Is it a template engine?</span></span></h1><div class="content"><div id="wallapatta_20016" class="section"><div class="content"><p id="wallapatta_20017" class="paragraph"><span id="wallapatta_20057" class="text">Weya is quite similar to Coffeecup in terms of the syntax. But it's much faster, so it won't fail if you have lots of elements.</span></p></div></div><div id="wallapatta_20021" class="section"><div class="content"><p id="wallapatta_20022" class="paragraph"><span id="wallapatta_20059" class="text">Also, Weya lets you register event handlers. I feel this is much cleaner than registering events later with CSS selectors, and it's easier to maintain the code since events are register within the DOM creation code.</span></p></div></div></div></div><div id="wallapatta_20023" class="section"><h1 class="heading"><span id="wallapatta_20024" class="block"><span id="wallapatta_20060" class="text">Can it replace d3.js?</span></span></h1><div class="content"><div id="wallapatta_20025" class="section"><div class="content"><p id="wallapatta_20026" class="paragraph"><span id="wallapatta_20061" class="text">We use weya to replace most all the d3.js DOM manipulation.</span></p></div></div><div id="wallapatta_20027" class="section"><div class="content"><p id="wallapatta_20028" class="paragraph"><span id="wallapatta_20062" class="text">Code with Weya is simpler, shorter and nicely intended. Here's the code that draws bar chart in	</span><a id="wallapatta_20063" class="link" href="http://bl.ocks.org/vpj/9636655">this example</a><span id="wallapatta_20064" class="text">.</span></p></div></div><pre id="wallapatta_20029" class="codeBlock"><code class="coffee">Weya svg, <span class="hljs-function">-&gt;</span>
 <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> data
  <span class="hljs-property">@g</span> <span class="hljs-string">".g"</span>, <span class="hljs-attribute">transform</span>: <span class="hljs-string">"translate(<span class="hljs-subst">#{x0 d.State}</span>,0)"</span>, <span class="hljs-function">-&gt;</span>
   <span class="hljs-keyword">for</span> age <span class="hljs-keyword">in</span> d.ages
    <span class="hljs-property">@rect</span>
     <span class="hljs-attribute">width</span>: x1.rangeBand()
     <span class="hljs-attribute">x</span>: x1 age.name
     <span class="hljs-attribute">y</span>: y age.value
     <span class="hljs-attribute">height</span>: height - y age.value
     <span class="hljs-attribute">fill</span>: color age.name

 <span class="hljs-keyword">for</span> d, i <span class="hljs-keyword">in</span> ageNames.slice().reverse()
  <span class="hljs-property">@g</span> <span class="hljs-string">".legend"</span>, <span class="hljs-attribute">transform</span>: <span class="hljs-string">"translate(0,<span class="hljs-subst">#{i * <span class="hljs-number">20</span>}</span>)"</span>, <span class="hljs-function">-&gt;</span>
   <span class="hljs-property">@rect</span> <span class="hljs-attribute">x</span>: width - <span class="hljs-number">18</span>, <span class="hljs-attribute">width</span>: <span class="hljs-number">18</span>, <span class="hljs-attribute">height</span>: <span class="hljs-number">18</span>, <span class="hljs-attribute">fill</span>: color d
   <span class="hljs-property">@text</span>
    <span class="hljs-attribute">x</span>: width - <span class="hljs-number">24</span>, <span class="hljs-attribute">y</span>: <span class="hljs-number">9</span>, <span class="hljs-attribute">dy</span>: <span class="hljs-string">".35em"</span>
    <span class="hljs-attribute">style</span>: {<span class="hljs-string">'text-anchor'</span>: <span class="hljs-string">"end"</span>}, <span class="hljs-attribute">text</span>: d</code></pre><div id="wallapatta_20030" class="section"><div class="content"><p id="wallapatta_20031" class="paragraph"><span id="wallapatta_20065" class="text">Here's the code that does the </span><a id="wallapatta_20066" class="link" href="http://bl.ocks.org/mbostock/388705">same with d3.js</a><span id="wallapatta_20067" class="text">.</span></p></div></div><pre id="wallapatta_20032" class="codeBlock"><code class="javascript"><span class="hljs-keyword">var</span> state = svg.selectAll(<span class="hljs-string">".state"</span>)
    .data(data)
  .enter().append(<span class="hljs-string">"g"</span>)
    .attr(<span class="hljs-string">"class"</span>, <span class="hljs-string">"g"</span>)
    .attr(<span class="hljs-string">"transform"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"translate("</span> + x0(d.State) + <span class="hljs-string">",0)"</span>; });

state.selectAll(<span class="hljs-string">"rect"</span>)
    .data(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d.ages; })
  .enter().append(<span class="hljs-string">"rect"</span>)
    .attr(<span class="hljs-string">"width"</span>, x1.rangeBand())
    .attr(<span class="hljs-string">"x"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> x1(d.name); })
    .attr(<span class="hljs-string">"y"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> y(d.value); })
    .attr(<span class="hljs-string">"height"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> height - y(d.value); })
    .style(<span class="hljs-string">"fill"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> color(d.name); });

<span class="hljs-keyword">var</span> legend = svg.selectAll(<span class="hljs-string">".legend"</span>)
    .data(ageNames.slice().reverse())
  .enter().append(<span class="hljs-string">"g"</span>)
    .attr(<span class="hljs-string">"class"</span>, <span class="hljs-string">"legend"</span>)
    .attr(<span class="hljs-string">"transform"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d, i)</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"translate(0,"</span> + i * <span class="hljs-number">20</span> + <span class="hljs-string">")"</span>; });

legend.append(<span class="hljs-string">"rect"</span>)
    .attr(<span class="hljs-string">"x"</span>, width - <span class="hljs-number">18</span>)
    .attr(<span class="hljs-string">"width"</span>, <span class="hljs-number">18</span>)
    .attr(<span class="hljs-string">"height"</span>, <span class="hljs-number">18</span>)
    .style(<span class="hljs-string">"fill"</span>, color);

legend.append(<span class="hljs-string">"text"</span>)
    .attr(<span class="hljs-string">"x"</span>, width - <span class="hljs-number">24</span>)
    .attr(<span class="hljs-string">"y"</span>, <span class="hljs-number">9</span>)
    .attr(<span class="hljs-string">"dy"</span>, <span class="hljs-string">".35em"</span>)
    .style(<span class="hljs-string">"text-anchor"</span>, <span class="hljs-string">"end"</span>)
    .text(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> </span>{ <span class="hljs-keyword">return</span> d; });</code></pre><div id="wallapatta_20033" class="section"><div class="content"><p id="wallapatta_20034" class="paragraph"><span id="wallapatta_20068" class="text">Another problem we solved with Weya is that d3.js draws all the elements that are represented by the data at once. And with Weya we can draw progressively - this is quite useful when you have a lot of data and you don't won't the interface to go unresponsive until everything is drawn. Here's a small example to show the point.</span></p></div></div><pre id="wallapatta_20035" class="codeBlock"><code class="coffee">i = <span class="hljs-number">0</span>
data = ...
<span class="hljs-function">
<span class="hljs-title">draw</span> = -&gt;</span>
 <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> i <span class="hljs-keyword">is</span> data.length

 d = data[i]
 Weya container, <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@div</span> <span class="hljs-string">'.user'</span>, <span class="hljs-function">-&gt;</span>
   ...

 i++
 requestAnimationFrame draw

draw()</code></pre><div id="wallapatta_20036" class="section"><div class="content"><p id="wallapatta_20037" class="paragraph"><span id="wallapatta_20069" class="text">The disadvantage of Weya over d3.js is that it doesn't bind data to DOM elements like d3.js does. So you can't use </span><code id="wallapatta_20070" class="code"><span id="wallapatta_20071" class="text">enter()</span></code><span id="wallapatta_20072" class="text">, </span><code id="wallapatta_20073" class="code"><span id="wallapatta_20074" class="text">exit()</span></code><span id="wallapatta_20075" class="text"> and updates when data changes. But most users rarely need these features. We use Weya with our own data bindings with DOM elements (as in the first example with </span><code id="wallapatta_20076" class="code"><span id="wallapatta_20077" class="text">userElems</span></code><span id="wallapatta_20078" class="text">), and we find it simpler than </span><code id="wallapatta_20079" class="code"><span id="wallapatta_20080" class="text">enter()</span></code><span id="wallapatta_20081" class="text"> and </span><code id="wallapatta_20082" class="code"><span id="wallapatta_20083" class="text">exit()</span></code><span id="wallapatta_20084" class="text">.</span></p></div></div></div></div></div>
     </div>
     <div class="wallapatta-sidebar three columns ">
      <div id="wallapatta_20003" class="sidenote"><div id="wallapatta_20004" class="html"><iframe src="https://ghbtns.com/github-btn.html?user=vpj&amp;repo=weya&amp;type=star&amp;count=true&amp;size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
</div><div id="wallapatta_20005" class="section"><div class="content"><p id="wallapatta_20006" class="paragraph"><a id="wallapatta_20043" class="link" href="http://jsperf.com/weya-jquery-d3-coffeecup">Performance comparison among d3, coffeecup and weya</a></p></div></div><div id="wallapatta_20007" class="section"><div class="content"><p id="wallapatta_20008" class="paragraph"><a id="wallapatta_20044" class="link" href="http://bl.ocks.org/vpj/9636655">Bar chart example</a></p></div></div></div><div id="wallapatta_20018" class="sidenote"><div id="wallapatta_20019" class="section"><div class="content"><p id="wallapatta_20020" class="paragraph"><a id="wallapatta_20058" class="link" href="http://jsperf.com/weya-jquery-d3-coffeecup">Performance comparison among d3, coffeecup and weya</a></p></div></div></div>
     </div>
     <div style="display:none;">
      <div class='wallapatta-code'>Weya.coffee is a lightweight library with no dependencies to generate DOM elements. We developed it to replace <<https://github.com/gradus/coffeecup(Coffeecup)>> as a client side template engine. Because of its simplicity and performance, we are also using Weya to replace DOM manipulation of <<http://d3js.org/(d3.js)>> in data visualizations.

>>>
 <<<
  <iframe src="https://ghbtns.com/github-btn.html?user=vpj&repo=weya&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>

 <<http://jsperf.com/weya-jquery-d3-coffeecup(Performance comparison among d3, coffeecup and weya)>>

 <<http://bl.ocks.org/vpj/9636655(Bar chart example)>>

Here's a small example to show the usage.

```coffee
 userElems = []
 Weya container, ->
  @div ".users", ->
   for user, i in users
    userDiv = @div '.user', on: {click: editUser}, ->
     name = @span ".name", user.name
     @span ".phone", user.phone
     if v.image?
      @img src: user.image

    userDiv.userId = i
    userElems.push user: user, name: name

The above code creates a list of users. It binds the data to the dom element ``userDiv.userId = i`` and also keeps track of all the DOM elements in ``userElems``. This is important if you want to manipulate the DOM without reloading the entire user list, for example if a name of a user changes you could change it with ``userElems[changedUserId].name.textContent = changedUserName``.

#Is it a template engine?

 Weya is quite similar to Coffeecup in terms of the syntax. But it's much faster, so it won't fail if you have lots of elements.

 >>>
  <<http://jsperf.com/weya-jquery-d3-coffeecup(Performance comparison among d3, coffeecup and weya)>>


 Also, Weya lets you register event handlers. I feel this is much cleaner than registering events later with CSS selectors, and it's easier to maintain the code since events are register within the DOM creation code.

#Can it replace d3.js?

 We use weya to replace most all the d3.js DOM manipulation.

 Code with Weya is simpler, shorter and nicely intended. Here's the code that draws bar chart in	<<http://bl.ocks.org/vpj/9636655(this example)>>.

 ```coffee
  Weya svg, ->
   for d in data
    @g ".g", transform: "translate(#{x0 d.State},0)", ->
     for age in d.ages
      @rect
       width: x1.rangeBand()
       x: x1 age.name
       y: y age.value
       height: height - y age.value
       fill: color age.name

   for d, i in ageNames.slice().reverse()
    @g ".legend", transform: "translate(0,#{i * 20})", ->
     @rect x: width - 18, width: 18, height: 18, fill: color d
     @text
      x: width - 24, y: 9, dy: ".35em"
      style: {'text-anchor': "end"}, text: d

 Here's the code that does the <<http://bl.ocks.org/mbostock/388705(same with d3.js)>>.

 ```javascript
  var state = svg.selectAll(".state")
      .data(data)
    .enter().append("g")
      .attr("class", "g")
      .attr("transform", function(d) { return "translate(" + x0(d.State) + ",0)"; });

  state.selectAll("rect")
      .data(function(d) { return d.ages; })
    .enter().append("rect")
      .attr("width", x1.rangeBand())
      .attr("x", function(d) { return x1(d.name); })
      .attr("y", function(d) { return y(d.value); })
      .attr("height", function(d) { return height - y(d.value); })
      .style("fill", function(d) { return color(d.name); });

  var legend = svg.selectAll(".legend")
      .data(ageNames.slice().reverse())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend.append("rect")
      .attr("x", width - 18)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", color);

  legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });


 Another problem we solved with Weya is that d3.js draws all the elements that are represented by the data at once. And with Weya we can draw progressively - this is quite useful when you have a lot of data and you don't won't the interface to go unresponsive until everything is drawn. Here's a small example to show the point.

 ```coffee
  i = 0
  data = ...

  draw = ->
   return if i is data.length

   d = data[i]
   Weya container, ->
    @div '.user', ->
     ...

   i++
   requestAnimationFrame draw

  draw()

 The disadvantage of Weya over d3.js is that it doesn't bind data to DOM elements like d3.js does. So you can't use ``enter()``, ``exit()`` and updates when data changes. But most users rarely need these features. We use Weya with our own data bindings with DOM elements (as in the first example with ``userElems``), and we find it simpler than ``enter()`` and ``exit()``.
</div>
     </div>
    </div>
   </div>
  </div>
  <script src="lib/highlightjs/highlight.pack.js">
  </script>
  <script src="lib/weya/weya.js">
  </script>
  <script src="lib/weya/base.js">
  </script>
  <script src="lib/mod/mod.js">
  </script>
  <script src="js/static.js?v=9">
  </script>
  <script src="js/parser.js?v=9">
  </script>
  <script src="js/reader.js?v=9">
  </script>
  <script src="js/nodes.js?v=9">
  </script>
  <script src="js/render.js?v=9">
  </script>
 </body>
</html>
