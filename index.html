<!DOCTYPE html><html>
 <head>
  <meta charset="utf-8">
  </meta>
  <title>
   Varuna Jayasiri
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </meta>
  <meta name="apple-mobile-web-app-capable" content="yes">
  </meta>
  <link href="http://fonts.googleapis.com/css?family=Raleway:400,100,200,300,500,600,700,800,900" rel="stylesheet" type="text/css">
  </link>
  <link href="lib/skeleton/css/skeleton.css" rel="stylesheet">
  </link>
  <link href="lib/highlightjs/styles/default.css" rel="stylesheet">
  </link>
  <link href="css/style.css" rel="stylesheet">
  </link>
  <link href="css/paginate.css" rel="stylesheet">
  </link>
  <link href="blog.css" rel="stylesheet">
  </link>
  <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-44255805-1', 'auto');
ga('send', 'pageview');
  </script>
 </head>
 <body>
  <div class="container wallapatta-container ">
   <div class="header ">
    <h1>
     <a href="index.html">
      VARUNA JAYASIRI
     </a>
    </h1>
    <a class="button " href="https://www.twitter.com/vpj">
     @vpj
    </a>
   </div>
   <div class="wallapatta ">
    <h1 class="title ">
     <a href="wallapatta_scripts.html">
      Wallapatta Update
     </a>
    </h1>
    <h3 class="date ">
     December 01, 2015
    </h3>
    <div class="post-paginated ">
     <div class="wallapatta-main nine columns ">
      <div id="wallapatta_0" class="article"><div id="wallapatta_1" class="section"><div class="content"><p id="wallapatta_2" class="paragraph"><span id="wallapatta_25" class="text">Wallapatta got some new features.</span></p></div></div><div id="wallapatta_3" class="section"><div class="content"><p id="wallapatta_4" class="paragraph"><span id="wallapatta_26" class="text">First is full width blocks. These span into the sidenote area. These are ideal for large images and quotes.</span></p></div></div><div id="wallapatta_5" class="full"><div id="wallapatta_7" class="image-container"><img class="image" src="https://static.pexels.com/photos/6547/sky-night-space-galaxy-large.jpeg" alt="https://static.pexels.com/photos/6547/sky-night-space-galaxy-large.jpeg"></div></div><div id="wallapatta_8" class="section"><div class="content"><p id="wallapatta_9" class="paragraph"><span id="wallapatta_27" class="text">Next is javascript, coffeescript or weya template blocks. These can have code that generates html.</span></p></div></div><div id="wallapatta_10" class="section"><div class="content"><p id="wallapatta_11" class="paragraph"><span id="wallapatta_28" class="text">Heres a coffeescript block.</span></p><pre id="wallapatta_12" class="codeBlock"><code class="coffeescript">&lt;&lt;&lt;coffee
 <span class="hljs-string">"7 * 100 = &lt;strong&gt;<span class="hljs-subst">#{<span class="hljs-number">7</span> * <span class="hljs-number">100</span>}</span>&lt;/strong&gt;"</span></code></pre></div></div><div id="wallapatta_15" class="section"><div class="content"><p id="wallapatta_16" class="paragraph"><span id="wallapatta_29" class="text">Here's a weya block that generates the </span><a id="wallapatta_30" class="link" href="http://www.forestpin.com">Forestpin</a><span id="wallapatta_31" class="text"> logo in an SVG.</span></p><pre id="wallapatta_20" class="codeBlock"><code class="coffeescript">&lt;&lt;&lt;weya
 G = <span class="hljs-number">1.618</span>
 H = <span class="hljs-number">13</span>
 order = [<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>]
 heights = (H * Math.pow G, i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> order)
 <span class="hljs-property">@svg</span> <span class="hljs-attribute">width</span>: <span class="hljs-number">250</span>, <span class="hljs-attribute">height</span>: <span class="hljs-number">250</span>, <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@g</span> <span class="hljs-attribute">transform</span>: <span class="hljs-string">"translate(2, 154)"</span>, <span class="hljs-function">-&gt;</span>
   <span class="hljs-keyword">for</span> h, i <span class="hljs-keyword">in</span> heights
    <span class="hljs-property">@g</span> <span class="hljs-string">".bar"</span>, <span class="hljs-attribute">transform</span>: <span class="hljs-string">"translate(<span class="hljs-subst">#{i * <span class="hljs-number">50</span>}</span>, 0)"</span>, <span class="hljs-function">-&gt;</span>
     <span class="hljs-property">@rect</span> <span class="hljs-attribute">y</span>: -h * G, <span class="hljs-attribute">width</span>: <span class="hljs-number">46</span>, <span class="hljs-attribute">height</span>: h * G, <span class="hljs-attribute">fill</span>: <span class="hljs-string">'#4a4a4a'</span>
     <span class="hljs-property">@rect</span> <span class="hljs-attribute">width</span>: <span class="hljs-number">30.67</span>, <span class="hljs-attribute">height</span>: h,<span class="hljs-attribute">fill</span>: <span class="hljs-string">'#98ff98'</span>
     <span class="hljs-property">@rect</span> <span class="hljs-attribute">x</span>: <span class="hljs-number">30.67</span>, <span class="hljs-attribute">width</span>: <span class="hljs-number">15.33</span>, <span class="hljs-attribute">height</span>: h, <span class="hljs-attribute">fill</span>: <span class="hljs-string">'#8bea8b'</span></code></pre><div id="wallapatta_24" class="html"><svg width="250" height="250">
 <g transform="translate(2, 154)">
  <g class="bar " transform="translate(0, 0)">
   <rect y="-55.06541341600001" width="46" height="55.06541341600001" fill="#4a4a4a">
   </rect>
   <rect width="30.67" height="34.03301200000001" fill="#98ff98">
   </rect>
   <rect x="30.67" width="15.33" height="34.03301200000001" fill="#8bea8b">
   </rect>
  </g>
  <g class="bar " transform="translate(50, 0)">
   <rect y="-144.15706735166842" width="46" height="144.15706735166842" fill="#4a4a4a">
   </rect>
   <rect width="30.67" height="89.09583890708802" fill="#98ff98">
   </rect>
   <rect x="30.67" width="15.33" height="89.09583890708802" fill="#8bea8b">
   </rect>
  </g>
  <g class="bar " transform="translate(100, 0)">
   <rect y="-34.03301200000001" width="46" height="34.03301200000001" fill="#4a4a4a">
   </rect>
   <rect width="30.67" height="21.034000000000002" fill="#98ff98">
   </rect>
   <rect x="30.67" width="15.33" height="21.034000000000002" fill="#8bea8b">
   </rect>
  </g>
  <g class="bar " transform="translate(150, 0)">
   <rect y="-21.034000000000002" width="46" height="21.034000000000002" fill="#4a4a4a">
   </rect>
   <rect width="30.67" height="13" fill="#98ff98">
   </rect>
   <rect x="30.67" width="15.33" height="13" fill="#8bea8b">
   </rect>
  </g>
  <g class="bar " transform="translate(200, 0)">
   <rect y="-89.09583890708802" width="46" height="89.09583890708802" fill="#4a4a4a">
   </rect>
   <rect width="30.67" height="55.06541341600001" fill="#98ff98">
   </rect>
   <rect x="30.67" width="15.33" height="55.06541341600001" fill="#8bea8b">
   </rect>
  </g>
 </g>
</svg>
</div></div></div></div>
     </div>
     <div class="wallapatta-sidebar three columns ">
      <div id="wallapatta_6" class="sidenote"></div><div id="wallapatta_13" class="sidenote"><div id="wallapatta_14" class="html">7 * 100 = <strong>700</strong></div></div><div id="wallapatta_17" class="sidenote"><div id="wallapatta_18" class="section"><div class="content"><p id="wallapatta_19" class="paragraph"><a id="wallapatta_32" class="link" href="https://github.com/vpj/weya">Weya on Github</a></p></div></div></div><div id="wallapatta_21" class="sidenote"><div id="wallapatta_22" class="section"><div class="content"><p id="wallapatta_23" class="paragraph"><span id="wallapatta_33" class="text">It generates the </span><a id="wallapatta_34" class="link" href="https://www.forestpin.com">Forestpin</a><span id="wallapatta_35" class="text"> Logo</span></p></div></div></div>
     </div>
     <div style="display:none;">
      <div class='wallapatta-code'>Wallapatta got some new features.

First is full width blocks. These span into the sidenote area.
These are ideal for large images and quotes.

&lt;!&gt;
 !https://static.pexels.com/photos/6547/sky-night-space-galaxy-large.jpeg

Next is javascript, coffeescript or weya template blocks.
These can have code that generates html.

Heres a coffeescript block.

 ```coffeescript
  &lt;&lt;&lt;coffee
   "7 * 100 = &lt;strong&gt;#{7 * 100}&lt;/strong&gt;"

 &gt;&gt;&gt;
  &lt;&lt;&lt;coffee
   "7 * 100 = &lt;strong&gt;#{7 * 100}&lt;/strong&gt;"

Here's a weya block that generates the &lt;&lt;http://www.forestpin.com(Forestpin)&gt;&gt; logo in an SVG.

 &gt;&gt;&gt;
  &lt;&lt;https://github.com/vpj/weya(Weya on Github)&gt;&gt;

 ```coffeescript
  &lt;&lt;&lt;weya
   G = 1.618
   H = 13
   order = [2, 4, 1, 0, 3]
   heights = (H * Math.pow G, i for i in order)
   @svg width: 250, height: 250, -&gt;
    @g transform: "translate(2, 154)", -&gt;
     for h, i in heights
      @g ".bar", transform: "translate(#{i * 50}, 0)", -&gt;
       @rect y: -h * G, width: 46, height: h * G, fill: '#4a4a4a'
       @rect width: 30.67, height: h,fill: '#98ff98'
       @rect x: 30.67, width: 15.33, height: h, fill: '#8bea8b'

 &gt;&gt;&gt;
  It generates the &lt;&lt;https://www.forestpin.com(Forestpin)&gt;&gt; Logo

 &lt;&lt;&lt;weya
  G = 1.618
  H = 13
  order = [2, 4, 1, 0, 3]
  heights = (H * Math.pow G, i for i in order)
  @svg width: 250, height: 250, -&gt;
   @g transform: "translate(2, 154)", -&gt;
    for h, i in heights
     @g ".bar", transform: "translate(#{i * 50}, 0)", -&gt;
      @rect y: -h * G, width: 46, height: h * G, fill: '#4a4a4a'
      @rect width: 30.67, height: h,fill: '#98ff98'
      @rect x: 30.67, width: 15.33, height: h, fill: '#8bea8b'
</div>
     </div>
     <div class="overlay ">
      
     </div>
    </div>
   </div>
   <div class="wallapatta ">
    <h1 class="title ">
     <a href="string_slice.html">
      Parent in (sliced string)
     </a>
    </h1>
    <h3 class="date ">
     November 23, 2015
    </h3>
    <div class="post-paginated ">
     <div class="wallapatta-main nine columns ">
      <div id="wallapatta_10000" class="article"><div id="wallapatta_10001" class="full"><div id="wallapatta_10003" class="image-container"><img class="image" src="img/sliced_string.png" alt="img/sliced_string.png"></div></div><div id="wallapatta_10004" class="section"><div class="content"><p id="wallapatta_10005" class="paragraph"><span id="wallapatta_10034" class="text">In Google Chrome </span><sup id="wallapatta_10035" class="superScript"><span id="wallapatta_10036" class="text">1</span></sup><span id="wallapatta_10037" class="text"> when you take substrings of a larger string, the larger string is not garbage collected even if it is no longer referenced. The problem seems to be because the substring keeps a reference to the parent string.</span></p></div></div><div id="wallapatta_10009" class="section"><h2 class="heading"><span id="wallapatta_10010" class="block"><a id="wallapatta_10043" class="link" href="<http://vpj.github.io/bench/string_slice.html">Demo</a></span></h2><div class="content"><div id="wallapatta_10011" class="section"><div class="content"><p id="wallapatta_10012" class="paragraph"><span id="wallapatta_10044" class="text">The demo iteratively,</span></p><ol id="wallapatta_10013" class="list"><li id="wallapatta_10014" class="list-item"><span id="wallapatta_10015" class="block"><span id="wallapatta_10045" class="text">creates a random large string (~10M in length)</span></span></li><li id="wallapatta_10016" class="list-item"><span id="wallapatta_10017" class="block"><span id="wallapatta_10046" class="text">take a few substrings (each of about 50 characters)</span></span></li><li id="wallapatta_10018" class="list-item"><span id="wallapatta_10019" class="block"><span id="wallapatta_10047" class="text">push the substrings to a global array (the only thing permanently referenced)</span></span></li><li id="wallapatta_10020" class="list-item"><span id="wallapatta_10021" class="block"><span id="wallapatta_10048" class="text">remove references to the large string</span></span></li></ol></div></div><div id="wallapatta_10022" class="section"><div class="content"><p id="wallapatta_10023" class="paragraph"><span id="wallapatta_10049" class="text">You would assume that larger strings will get garbage collected. And would expect the program to run without a problem for many many iterations - until the memory taken up by the smaller strings hits the limit.</span></p></div></div><div id="wallapatta_10024" class="section"><div class="content"><p id="wallapatta_10025" class="paragraph"><span id="wallapatta_10050" class="text">Unfortunately in Google Chrome it doesn't work like that. The small substrings keep a reference to the parent and therefore it crashes after a few iterations. Try </span><a id="wallapatta_10051" class="link" href="http://vpj.github.io/bench/string_slice.html">http://vpj.github.io/bench/string_slice.html</a><span id="wallapatta_10052" class="text"> in Google Chrome.It crashes before 2000 cycles. </span><sup id="wallapatta_10053" class="superScript"><span id="wallapatta_10054" class="text">2</span></sup><span id="wallapatta_10055" class="text"> If you take a heap snapshot on Chrome Inspector, you can see the large strings, referenced as </span><strong id="wallapatta_10056" class="bold"><span id="wallapatta_10057" class="text">parent in (sliced string)</span></strong><span id="wallapatta_10058" class="text"> by smaller strings (as shown in the above screenshot).</span></p></div></div><div id="wallapatta_10029" class="section"><div class="content"><p id="wallapatta_10030" class="paragraph"><span id="wallapatta_10062" class="text">Then we wrote a copy of the same program, which creates a copy of the substrings before storing them. The following splitting and concatenation creates a actual copy of the string, instead of a reference copy.</span></p><pre id="wallapatta_10031" class="codeBlock"><code class="js">newSmallString = smallString.split(<span class="hljs-string">''</span>).join(<span class="hljs-string">''</span>)</code></pre></div></div><div id="wallapatta_10032" class="section"><div class="content"><p id="wallapatta_10033" class="paragraph"><span id="wallapatta_10063" class="text">Try </span><a id="wallapatta_10064" class="link" href="http://vpj.github.io/bench/string_slice_join.html">http://vpj.github.io/bench/string_slice_join.html</a><span id="wallapatta_10065" class="text">, which will run runs for many more iterations doing the same thing.</span></p></div></div></div></div></div>
     </div>
     <div class="wallapatta-sidebar three columns ">
      <div id="wallapatta_10002" class="sidenote"></div><div id="wallapatta_10006" class="sidenote"><div id="wallapatta_10007" class="section"><div class="content"><p id="wallapatta_10008" class="paragraph"><sup id="wallapatta_10038" class="superScript"><span id="wallapatta_10039" class="text">1</span></sup><span id="wallapatta_10040" class="text"> Same happens in </span><a id="wallapatta_10041" class="link" href="https://nodejs.org/en/">node.js</a><span id="wallapatta_10042" class="text"> since it uses V8.</span></p></div></div></div><div id="wallapatta_10026" class="sidenote"><div id="wallapatta_10027" class="section"><div class="content"><p id="wallapatta_10028" class="paragraph"><sup id="wallapatta_10059" class="superScript"><span id="wallapatta_10060" class="text">2</span></sup><span id="wallapatta_10061" class="text"> This only happens in Chrome, not on Safari. Did not check on Firefox.</span></p></div></div></div>
     </div>
     <div style="display:none;">
      <div class='wallapatta-code'>&lt;!&gt;
 !img/sliced_string.png

In Google Chrome ^^1^^ when you take substrings of a larger string, the larger string is not garbage collected even if it is no longer referenced. The problem seems to be because the substring keeps a reference to the parent string.

&gt;&gt;&gt;
 ^^1^^ Same happens in &lt;&lt;https://nodejs.org/en/(node.js)&gt;&gt; since it uses V8.

## &lt;&lt;&lt;http://vpj.github.io/bench/string_slice.html(Demo)&gt;&gt;

 The demo iteratively,

  - creates a random large string (~10M in length)
  - take a few substrings (each of about 50 characters)
  - push the substrings to a global array (the only thing permanently referenced)
  - remove references to the large string

 You would assume that larger strings will get garbage collected.
 And would expect the program to run without a problem for many many iterations - until the memory taken up by the smaller strings hits the limit.

 Unfortunately in Google Chrome it doesn't work like that. The small substrings keep a reference to the parent and therefore it crashes after a few iterations.
 Try &lt;&lt;http://vpj.github.io/bench/string_slice.html&gt;&gt; in Google Chrome.It crashes before 2000 cycles. ^^2^^
 If you take a heap snapshot on Chrome Inspector, you can see the large strings, referenced as **parent in (sliced string)** by smaller strings (as shown in the above screenshot).

 &gt;&gt;&gt;
  ^^2^^ This only happens in Chrome, not on Safari. Did not check on Firefox.

 Then we wrote a copy of the same program, which creates a copy of the substrings before storing them. The following splitting and concatenation creates a actual copy of the string, instead of a reference copy.

  ```js
   newSmallString = smallString.split('').join('')

 Try &lt;&lt;http://vpj.github.io/bench/string_slice_join.html&gt;&gt;, which will run runs for many more iterations doing the same thing.</div>
     </div>
     <div class="overlay ">
      
     </div>
    </div>
   </div>
   <div class="wallapatta ">
    <h1 class="title ">
     <a href="weya-perf.html">
      jsblocks, React, Angular performance compared with Weya.coffee
     </a>
    </h1>
    <h3 class="date ">
     May 27, 2015
    </h3>
    <div class="post-paginated ">
     <div class="wallapatta-main nine columns ">
      <div id="wallapatta_20000" class="article"><div id="wallapatta_20001" class="section"><div class="content"><p id="wallapatta_20002" class="paragraph"><span id="wallapatta_20048" class="text">I came across </span><a id="wallapatta_20049" class="link" href="http://jsblocks.com/">jsblock</a><span id="wallapatta_20050" class="text"> yesterday on Hacker News. They had a nice performance comparison test case set comparing jsblocks with </span><a id="wallapatta_20051" class="link" href="https://angularjs.org/">Angular</a><span id="wallapatta_20052" class="text"> and </span><a id="wallapatta_20053" class="link" href="https://facebook.github.io/react/">React</a><span id="wallapatta_20054" class="text">. It made me curious to see how the small library we use (</span><a id="wallapatta_20055" class="link" href="https://github.com/vpj/weya">Weya.coffee</a><span id="wallapatta_20056" class="text">) compares in performance with these.</span></p></div></div><div id="wallapatta_20007" class="section"><div class="content"><p id="wallapatta_20008" class="paragraph"><span id="wallapatta_20060" class="text">I ran the tests on Chrome broswer on a Macbook Air (1.6Ghz i5, 2GB). I have not altered test cases provided on </span><a id="wallapatta_20061" class="link" href="http://jsblocks.com/">jsblock</a><span id="wallapatta_20062" class="text">, and have added test cases for Weya for </span><strong id="wallapatta_20063" class="bold"><span id="wallapatta_20064" class="text">Rendering</span></strong><span id="wallapatta_20065" class="text"> and </span><strong id="wallapatta_20066" class="bold"><span id="wallapatta_20067" class="text">Syncing Changes</span></strong><span id="wallapatta_20068" class="text">., The results on Safari are not accurate in </span><em id="wallapatta_20069" class="italics"><span id="wallapatta_20070" class="text">syncing-changes</span></em><span id="wallapatta_20071" class="text"> test case, because jsblock test case use </span><code id="wallapatta_20072" class="code"><span id="wallapatta_20073" class="text">setTimeout(0)</span></code><span id="wallapatta_20074" class="text"> to resync which is called before html is actually rendered while the Weya test case use </span><code id="wallapatta_20075" class="code"><span id="wallapatta_20076" class="text">requestAnimationFrame</span></code><span id="wallapatta_20077" class="text"> which waits till it's rendered.</span></p></div></div><div id="wallapatta_20012" class="section"><h3 class="heading"><span id="wallapatta_20013" class="block"><span id="wallapatta_20080" class="text">Rendering</span></span></h3><div class="content"><table id="wallapatta_20014" class="table"><thead><tr><th colspan="1"><span id="wallapatta_20015" class="block"><span id="wallapatta_20081" class="text">Library</span></span></th><th colspan="1"><span id="wallapatta_20016" class="block"><span id="wallapatta_20082" class="text">Time (ms)</span></span></th><th colspan="1"><span id="wallapatta_20017" class="block"><span id="wallapatta_20083" class="text">Bar (shorter is better)</span></span></th></tr></thead><tbody><tr><td colspan="1"><span id="wallapatta_20018" class="block"><span id="wallapatta_20084" class="text">Weya.coffee</span></span></td><td colspan="1"><span id="wallapatta_20019" class="block"><span id="wallapatta_20085" class="text">404</span></span></td><td colspan="1"><span id="wallapatta_20020" class="block"><span id="wallapatta_20086" class="text">====</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_20021" class="block"><span id="wallapatta_20087" class="text">jsblocks</span></span></td><td colspan="1"><span id="wallapatta_20022" class="block"><span id="wallapatta_20088" class="text">801</span></span></td><td colspan="1"><span id="wallapatta_20023" class="block"><span id="wallapatta_20089" class="text">========</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_20024" class="block"><span id="wallapatta_20090" class="text">React</span></span></td><td colspan="1"><span id="wallapatta_20025" class="block"><span id="wallapatta_20091" class="text">1065</span></span></td><td colspan="1"><span id="wallapatta_20026" class="block"><span id="wallapatta_20092" class="text">==========</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_20027" class="block"><span id="wallapatta_20093" class="text">Angular</span></span></td><td colspan="1"><span id="wallapatta_20028" class="block"><span id="wallapatta_20094" class="text">2432</span></span></td><td colspan="1"><span id="wallapatta_20029" class="block"><span id="wallapatta_20095" class="text">========================</span></span></td></tr></tbody></table></div></div><div id="wallapatta_20030" class="section"><h3 class="heading"><span id="wallapatta_20031" class="block"><span id="wallapatta_20096" class="text">Syncing Changes</span></span></h3><div class="content"><table id="wallapatta_20032" class="table"><thead><tr><th colspan="1"><span id="wallapatta_20033" class="block"><span id="wallapatta_20097" class="text">Library</span></span></th><th colspan="1"><span id="wallapatta_20034" class="block"><span id="wallapatta_20098" class="text">Time (ms)</span></span></th><th colspan="1"><span id="wallapatta_20035" class="block"><span id="wallapatta_20099" class="text">Bar (shorter is better)</span></span></th></tr></thead><tbody><tr><td colspan="1"><span id="wallapatta_20036" class="block"><span id="wallapatta_20100" class="text">Weya.coffee</span></span></td><td colspan="1"><span id="wallapatta_20037" class="block"><span id="wallapatta_20101" class="text">1593</span></span></td><td colspan="1"><span id="wallapatta_20038" class="block"><span id="wallapatta_20102" class="text">========</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_20039" class="block"><span id="wallapatta_20103" class="text">jsblocks</span></span></td><td colspan="1"><span id="wallapatta_20040" class="block"><span id="wallapatta_20104" class="text">2035</span></span></td><td colspan="1"><span id="wallapatta_20041" class="block"><span id="wallapatta_20105" class="text">==========</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_20042" class="block"><span id="wallapatta_20106" class="text">React</span></span></td><td colspan="1"><span id="wallapatta_20043" class="block"><span id="wallapatta_20107" class="text">2781</span></span></td><td colspan="1"><span id="wallapatta_20044" class="block"><span id="wallapatta_20108" class="text">==============</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_20045" class="block"><span id="wallapatta_20109" class="text">Angular</span></span></td><td colspan="1"><span id="wallapatta_20046" class="block"><span id="wallapatta_20110" class="text">8081</span></span></td><td colspan="1"><span id="wallapatta_20047" class="block"><span id="wallapatta_20111" class="text">========================================</span></span></td></tr></tbody></table></div></div></div>
     </div>
     <div class="wallapatta-sidebar three columns ">
      <div id="wallapatta_20003" class="sidenote"><div id="wallapatta_20004" class="section"><div class="content"><p id="wallapatta_20005" class="paragraph"><span id="wallapatta_20057" class="text">Weya.coffee is more of a rendering tool than a a framework. The main difference between Weya and other frameworks is that instead of writing logic inside html, markup is written in coffeescript. Weya comes with a router and a base class inspired by </span><a id="wallapatta_20058" class="link" href="http://backbonejs.org/">backbone.js</a><span id="wallapatta_20059" class="text">.</span></p></div></div><div id="wallapatta_20006" class="html"><iframe src="https://ghbtns.com/github-btn.html?user=vpj&amp;repo=weya&amp;type=star&amp;count=true&amp;size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
</div></div><div id="wallapatta_20009" class="sidenote"><div id="wallapatta_20010" class="section"><div class="content"><p id="wallapatta_20011" class="paragraph"><strong id="wallapatta_20078" class="bold"><a id="wallapatta_20079" class="link" href="http://vpj.github.io/jsblocks-performance.zip">Download the performance test cases</a></strong></p></div></div></div>
     </div>
     <div style="display:none;">
      <div class='wallapatta-code'>I came across &lt;&lt;http://jsblocks.com/(jsblock)&gt;&gt; yesterday on Hacker News. They had a nice performance comparison test case set comparing jsblocks with &lt;&lt;https://angularjs.org/(Angular)&gt;&gt; and &lt;&lt;https://facebook.github.io/react/(React)&gt;&gt;. It made me curious to see how the small library we use (&lt;&lt;https://github.com/vpj/weya(Weya.coffee)&gt;&gt;) compares in performance with these.

&gt;&gt;&gt;
 Weya.coffee is more of a rendering tool than a a framework. The main difference between Weya and other frameworks is that instead of writing logic inside html, markup is written in coffeescript. Weya comes with a router and a base class inspired by &lt;&lt;http://backbonejs.org/(backbone.js)&gt;&gt;.

 &lt;&lt;&lt;
  &lt;iframe src="https://ghbtns.com/github-btn.html?user=vpj&repo=weya&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"&gt;&lt;/iframe&gt;

I ran the tests on Chrome broswer on a Macbook Air (1.6Ghz i5, 2GB). I have not altered test cases provided on &lt;&lt;http://jsblocks.com/(jsblock)&gt;&gt;, and have added test cases for Weya for **Rendering** and **Syncing Changes**., The results on Safari are not accurate in --syncing-changes-- test case, because jsblock test case use ``setTimeout(0)`` to resync which is called before html is actually rendered while the Weya test case use ``requestAnimationFrame`` which waits till it's rendered.

&gt;&gt;&gt;
 **&lt;&lt;http://vpj.github.io/jsblocks-performance.zip(Download the performance test cases)&gt;&gt;


### Rendering

 |||
  Library | Time (ms) |Bar (shorter is better)
  ===
  Weya.coffee | 404 | ====
  jsblocks | 801 | ========
  React | 1065 | ==========
  Angular | 2432 | ========================

### Syncing Changes

 |||
  Library | Time (ms) | Bar (shorter is better)
  ===
  Weya.coffee | 1593 | ========
  jsblocks | 2035 | ==========
  React | 2781 | ==============
  Angular | 8081 | ========================================

</div>
     </div>
     <div class="overlay ">
      
     </div>
    </div>
   </div>
   <div class="wallapatta ">
    <h1 class="title ">
     <a href="cellular-start.html">
      Small data preparation
     </a>
    </h1>
    <h3 class="date ">
     May 24, 2015
    </h3>
    <div class="post-paginated ">
     <div class="wallapatta-main nine columns ">
      <div id="wallapatta_30000" class="article"><div id="wallapatta_30001" class="html"><iframe width="550" height="310" src="https://www.youtube.com/embed/AcSIzSQIDQ8?autoplay=0" frameborder="0" allowfullscreen=""></iframe>
</div><div id="wallapatta_30005" class="section"><div class="content"><p id="wallapatta_30006" class="paragraph"><span id="wallapatta_30020" class="text">One of the biggest </span><strong id="wallapatta_30021" class="bold"><span id="wallapatta_30022" class="text">small data</span></strong><span id="wallapatta_30023" class="text"> problems, is that data is structured in different ways. Some legacy systems give out reports in the formats like below.</span></p></div></div><pre id="wallapatta_30007" class="codeBlock"><code class="nohighlight">SUPPLIER STATEMENT                         38 November 2011

Supplier   B0001   SupplierX Corp
                   51, AAA STREET, BBB
===========================================================
DATE     REF.No.        DESCRIPTION       DEBIT      CREDIT
===========================================================
01/04/10                Balance B/F                1,000.00

01/05/10 AAAA-00001     PAYMENT          500,00
01/06/10 AAAA-00002     PAYMENT          250.00

01/07/10 IIII-00001     INVOICE                    2,000.00
                                      ---------  ----------
                                         750.00    3,000.00

31/03/11                Balance C/F                2,250.00

Contd. ......


SUPPLIER STATEMENT                         38 November 2011

Supplier   B0002   SupplierY Corp
                   51, ACD STREET, BBB
===========================================================
DATE     REF.No.        DESCRIPTION       DEBIT      CREDIT
===========================================================
01/04/10                Balance B/F                1,500.00

01/05/10 AAAA-00003     PAYMENT        1,500,00

01/07/10 IIII-00002     INVOICE                    2,000.00
01/08/10 IIII-00003     INVOICE                    1,000.00
                                      ---------  ----------
                                       1,500.00    4,500.00

31/03/11                Balance C/F                3,500.00

Contd. ......</code></pre><div id="wallapatta_30008" class="section"><div class="content"><p id="wallapatta_30009" class="paragraph"><span id="wallapatta_30024" class="text">Getting this into a spreadsheet or a database table to analyse it is not easy. So I started a project to help transform data in various report formats into simple tables and export as comma-separated files.</span></p></div></div><div id="wallapatta_30010" class="section"><div class="content"><p id="wallapatta_30011" class="paragraph"><span id="wallapatta_30025" class="text">The project is called </span><strong id="wallapatta_30026" class="bold"><a id="wallapatta_30027" class="link" href="http://vpj.github.io/cellular/">cellular</a></strong><span id="wallapatta_30028" class="text">, and it is still in the early stages. I thought of writing about it to get ideas and suggestions. It has a simple user interface with the table on the left side with a sidepane on right side.</span></p></div></div></div>
     </div>
     <div class="wallapatta-sidebar three columns ">
      <div id="wallapatta_30002" class="sidenote"><div id="wallapatta_30003" class="section"><div class="content"><p id="wallapatta_30004" class="paragraph"><span id="wallapatta_30016" class="text">Here's a small screen cast of using </span><strong id="wallapatta_30017" class="bold"><span id="wallapatta_30018" class="text">cellular</span></strong><span id="wallapatta_30019" class="text"> to transform the below report.</span></p></div></div></div><div id="wallapatta_30012" class="sidenote"><div id="wallapatta_30013" class="html"><iframe src="https://ghbtns.com/github-btn.html?user=vpj&amp;repo=cellular&amp;type=star&amp;count=true&amp;size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
</div><div id="wallapatta_30014" class="section"><h3 class="heading"><span id="wallapatta_30015" class="block"><strong id="wallapatta_30029" class="bold"><a id="wallapatta_30030" class="link" href="http://vpj.github.io/cellular/">demo</a></strong></span></h3><div class="content"></div></div></div>
     </div>
     <div style="display:none;">
      <div class='wallapatta-code'>&lt;&lt;&lt;
 &lt;iframe width="550" height="310" src="https://www.youtube.com/embed/AcSIzSQIDQ8?autoplay=0" frameborder="0" allowfullscreen&gt;&lt;/iframe&gt;

&gt;&gt;&gt;
 Here's a small screen cast of using **cellular** to transform the below report.

One of the biggest **small data** problems, is that data is structured in different ways. Some legacy systems give out reports in the formats like below.

```
 SUPPLIER STATEMENT                         38 November 2011

 Supplier   B0001   SupplierX Corp
                    51, AAA STREET, BBB
 ===========================================================
 DATE     REF.No.        DESCRIPTION       DEBIT      CREDIT
 ===========================================================
 01/04/10                Balance B/F                1,000.00

 01/05/10 AAAA-00001     PAYMENT          500,00
 01/06/10 AAAA-00002     PAYMENT          250.00

 01/07/10 IIII-00001     INVOICE                    2,000.00
                                       ---------  ----------
                                          750.00    3,000.00

 31/03/11                Balance C/F                2,250.00

 Contd. ......


 SUPPLIER STATEMENT                         38 November 2011

 Supplier   B0002   SupplierY Corp
                    51, ACD STREET, BBB
 ===========================================================
 DATE     REF.No.        DESCRIPTION       DEBIT      CREDIT
 ===========================================================
 01/04/10                Balance B/F                1,500.00

 01/05/10 AAAA-00003     PAYMENT        1,500,00

 01/07/10 IIII-00002     INVOICE                    2,000.00
 01/08/10 IIII-00003     INVOICE                    1,000.00
                                       ---------  ----------
                                        1,500.00    4,500.00

 31/03/11                Balance C/F                3,500.00

 Contd. ......

///This is what SAP exports look like.


Getting this into a spreadsheet or a database table to analyse it is not easy. So I started a project to help transform data in various report formats into simple tables and export as comma-separated files.

The project is called **&lt;&lt;http://vpj.github.io/cellular/(cellular)&gt;&gt;**, and it is still in the early stages. I thought of writing about it to get ideas and suggestions. It has a simple user interface with the table on the left side with a sidepane on right side.

&gt;&gt;&gt;
 &lt;&lt;&lt;
  &lt;iframe src="https://ghbtns.com/github-btn.html?user=vpj&repo=cellular&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"&gt;&lt;/iframe&gt;

 ###**&lt;&lt;http://vpj.github.io/cellular/(demo)&gt;&gt;**

</div>
     </div>
     <div class="overlay ">
      
     </div>
    </div>
   </div>
   <div class="wallapatta ">
    <h1 class="title ">
     <a href="wallapatta.html">
      Wallapatta Blog
     </a>
    </h1>
    <h3 class="date ">
     May 18, 2015
    </h3>
    <div class="post-paginated ">
     <div class="wallapatta-main nine columns ">
      <div id="wallapatta_40000" class="article"><div id="wallapatta_40001" class="section"><div class="content"><p id="wallapatta_40002" class="paragraph"><span id="wallapatta_40081" class="text">I just started moving my blog from </span><a id="wallapatta_40082" class="link" href="http://svbtle.com">Svbtle</a><span id="wallapatta_40083" class="text"> to a static blog generated that I created. It is based on </span><a id="wallapatta_40084" class="link" href="http://vpj.github.io/wallapatta/introduction.html">Wallapatta</a><span id="wallapatta_40085" class="text">. I wanted to get into svbtle when </span><a id="wallapatta_40086" class="link" href="http://dcurt.is/codename-svbtle">Dustin started it</a><span id="wallapatta_40087" class="text">, and got invite a little before they opened it to the public. And it's sad to part ways.</span></p></div></div><div id="wallapatta_40006" class="section"><div class="content"><p id="wallapatta_40007" class="paragraph"><span id="wallapatta_40093" class="text">Wallapatta is a </span><a id="wallapatta_40094" class="link" href="http://en.wikipedia.org/wiki/Markdown">Markdown</a><span id="wallapatta_40095" class="text"> like syntax that can create documents with layouts inspired by handouts of Edward R. Tufte</span><sup id="wallapatta_40096" class="superScript"><span id="wallapatta_40097" class="text">1</span></sup><span id="wallapatta_40098" class="text">. We created it to use for documents. The two great things about Wallapatta is that it creates documents with </span><strong id="wallapatta_40099" class="bold"><span id="wallapatta_40100" class="text">sidenotes</span></strong><span id="wallapatta_40101" class="text"> and </span><strong id="wallapatta_40102" class="bold"><span id="wallapatta_40103" class="text">create print frindly documents</span></strong><span id="wallapatta_40104" class="text"> - </span><a id="wallapatta_40105" class="link" href="http://vpj.github.io/wallapatta/introduction.html">Wallapatta editor</a><span id="wallapatta_40106" class="text"> creates print layouts with intelligent page breaks by trying not to place breaks at middle of content like most word processing software do.</span></p></div></div><div id="wallapatta_40011" class="section"><div class="content"><p id="wallapatta_40012" class="paragraph"><span id="wallapatta_40111" class="text">I built in a simple blog generator into Wallapatta, for personal use. But it's super easy for anyone who wants to give it a go.</span></p></div></div><div id="wallapatta_40013" class="section"><h3 class="heading"><span id="wallapatta_40014" class="block"><span id="wallapatta_40112" class="text">How to start a Wallapatta blog?</span></span></h3><div class="content"><div id="wallapatta_40017" class="section"><div class="content"><p id="wallapatta_40018" class="paragraph"><span id="wallapatta_40113" class="text">It's pretty easy.</span></p></div></div><ol id="wallapatta_40019" class="list"><li id="wallapatta_40020" class="list-item"><span id="wallapatta_40021" class="block"><strong id="wallapatta_40114" class="bold"><span id="wallapatta_40115" class="text">Install </span><a id="wallapatta_40116" class="link" href="https://nodejs.org/">Node.js</a></strong></span><div id="wallapatta_40022" class="section"><div class="content"><p id="wallapatta_40023" class="paragraph"><span id="wallapatta_40117" class="text">NPM usually comes with Node.js. Visit </span><a id="wallapatta_40118" class="link" href="https://nodejs.org/">https://nodejs.org/</a><span id="wallapatta_40119" class="text"> and see installation instructions. It's usually a download and install, unless you want it installed through a package manager like </span><code id="wallapatta_40120" class="code"><span id="wallapatta_40121" class="text">brew</span></code><span id="wallapatta_40122" class="text">.</span></p></div></div></li><li id="wallapatta_40024" class="list-item"><span id="wallapatta_40025" class="block"><strong id="wallapatta_40123" class="bold"><span id="wallapatta_40124" class="text">Install </span><a id="wallapatta_40125" class="link" href="https://www.npmjs.com/package/wallapatta">Wallapatta node odule</a></strong></span><div id="wallapatta_40026" class="section"><div class="content"><p id="wallapatta_40027" class="paragraph"><span id="wallapatta_40126" class="text">Run the following command in command line.</span></p></div></div><pre id="wallapatta_40028" class="codeBlock"><code class="nohighlight">npm install wallapatta -g</code></pre><div id="wallapatta_40029" class="section"><div class="content"><p id="wallapatta_40030" class="paragraph"><span id="wallapatta_40127" class="text">That's it and you have wallapatta installed.</span></p></div></div></li><li id="wallapatta_40031" class="list-item"><span id="wallapatta_40032" class="block"><strong id="wallapatta_40128" class="bold"><span id="wallapatta_40129" class="text">Fork the </span><a id="wallapatta_40130" class="link" href="https://github.com/vpj/wallapatta-blog-boilerplate">boilerplate</a></strong></span><div id="wallapatta_40033" class="section"><div class="content"><p id="wallapatta_40034" class="paragraph"><span id="wallapatta_40131" class="text">Make a fork of the git repositors on github: </span><a id="wallapatta_40132" class="link" href="https://github.com/vpj/wallapatta-blog-boilerplate">https://github.com/vpj/wallapatta-blog-boilerplate</a></p></div></div><div id="wallapatta_40035" class="section"><div class="content"><p id="wallapatta_40036" class="paragraph"><span id="wallapatta_40133" class="text">This repo contains this blog post, and 3 empty blog posts, a configuration file and templates for blog.</span></p></div></div><div id="wallapatta_40037" class="section"><div class="content"><p id="wallapatta_40038" class="paragraph"><span id="wallapatta_40134" class="text">Edit </span><code id="wallapatta_40135" class="code"><span id="wallapatta_40136" class="text">templates/post.coffee</span></code><span id="wallapatta_40137" class="text"> to change the post template and </span><code id="wallapatta_40138" class="code"><span id="wallapatta_40139" class="text">templates/blog.coffee</span></code><span id="wallapatta_40140" class="text"> to change the blog template. Compile these </span><a id="wallapatta_40141" class="link" href="http://coffeescript.org/">coffeescript</a><span id="wallapatta_40142" class="text"> code to javascript by running </span><code id="wallapatta_40143" class="code"><span id="wallapatta_40144" class="text">coffee -c *</span></code><span id="wallapatta_40145" class="text">.</span></p></div></div><div id="wallapatta_40039" class="section"><div class="content"><p id="wallapatta_40040" class="paragraph"><span id="wallapatta_40146" class="text">You will have to change the name of the blog, which is "Varuna Jayasiri" in the two tamplate files. And also the Google Analytics code.</span></p></div></div><div id="wallapatta_40041" class="section"><div class="content"><p id="wallapatta_40042" class="paragraph"><span id="wallapatta_40147" class="text">Change </span><code id="wallapatta_40148" class="code"><span id="wallapatta_40149" class="text">blog.yaml</span></code><span id="wallapatta_40150" class="text"> to edit blog configurations like the order of posts, post titles, dates, etc.</span></p></div></div></li><li id="wallapatta_40043" class="list-item"><span id="wallapatta_40044" class="block"><strong id="wallapatta_40151" class="bold"><span id="wallapatta_40152" class="text">Generate the blog</span></strong></span><pre id="wallapatta_40045" class="codeBlock"><code class="nohighlight">wallapatta --blog blog.yaml --output [output_directory] --static</code></pre><div id="wallapatta_40046" class="section"><div class="content"><p id="wallapatta_40047" class="paragraph"><span id="wallapatta_40153" class="text">The above command will create the html files on the </span><code id="wallapatta_40154" class="code"><span id="wallapatta_40155" class="text">output_directory</span></code><span id="wallapatta_40156" class="text"> provided. </span><code id="wallapatta_40157" class="code"><span id="wallapatta_40158" class="text">--static</span></code><span id="wallapatta_40159" class="text"> specifies that it should copy Wallapatta rendering tools to the folder. (You can omit this if you change the templates to get these from a CDN).</span></p></div></div><div id="wallapatta_40048" class="section"><div class="content"><p id="wallapatta_40049" class="paragraph"><code id="wallapatta_40160" class="code"><span id="wallapatta_40161" class="text">blog.css</span></code><span id="wallapatta_40162" class="text"> file on the boilerplate repository contains some css. This file is used in default templates. So you need to copy them to the </span><code id="wallapatta_40163" class="code"><span id="wallapatta_40164" class="text">output_directory</span></code><span id="wallapatta_40165" class="text">.</span></p></div></div></li><li id="wallapatta_40050" class="list-item"><span id="wallapatta_40051" class="block"><strong id="wallapatta_40166" class="bold"><span id="wallapatta_40167" class="text">That is it!</span></strong></span></li></ol></div></div><div id="wallapatta_40052" class="section"><h3 class="heading"><span id="wallapatta_40053" class="block"><span id="wallapatta_40168" class="text">What is Wallapatta syntax?</span></span></h3><div class="content"><div id="wallapatta_40054" class="section"><div class="content"><p id="wallapatta_40055" class="paragraph"><span id="wallapatta_40169" class="text">It looks like this.</span></p></div></div><pre id="wallapatta_40056" class="codeBlock"><code class="nohighlight">###Heading 1

 Introduction to **Heading 1**

 * Point one

  Description about point one

 * Point two

 ####Subtopic

  Subtopic content

 This belongs to Heading 1</code></pre><div id="wallapatta_40075" class="section"><div class="content"><p id="wallapatta_40076" class="paragraph"><span id="wallapatta_40180" class="text">It uses indentation to identify what belong where. Indentation is required for specifying content for components like lists, code blocks, special blocks, etc as well. So it's more of a programmer friendly syntax. Indentation helps while working with large documents because you can do stuff like </span><strong id="wallapatta_40181" class="bold"><span id="wallapatta_40182" class="text">code folding</span></strong><span id="wallapatta_40183" class="text">.</span></p></div></div><div id="wallapatta_40077" class="section"><div class="content"><p id="wallapatta_40078" class="paragraph"><span id="wallapatta_40184" class="text">We've changed some of the syntax from Markdown; for instance, </span><code id="wallapatta_40185" class="code"><span id="wallapatta_40186" class="text">&lt;&lt;</span></code><span id="wallapatta_40187" class="text"> and </span><code id="wallapatta_40188" class="code"><span id="wallapatta_40189" class="text">&gt;&gt;</span></code><span id="wallapatta_40190" class="text"> are used for links instead of </span><code id="wallapatta_40191" class="code"><span id="wallapatta_40192" class="text">[]()</span></code><span id="wallapatta_40193" class="text">, because we felt that it's a little more intuitive due to its resemblence with HTML tags.</span></p></div></div><div id="wallapatta_40079" class="section"><div class="content"><p id="wallapatta_40080" class="paragraph"><a id="wallapatta_40194" class="link" href="http://vpj.github.io/wallapatta/reference.html">Read the Wallapatta reference</a><span id="wallapatta_40195" class="text"> for a detailed description on each component, including examples for usage.</span></p></div></div></div></div></div>
     </div>
     <div class="wallapatta-sidebar three columns ">
      <div id="wallapatta_40003" class="sidenote"><div id="wallapatta_40004" class="section"><div class="content"><p id="wallapatta_40005" class="paragraph"><span id="wallapatta_40088" class="text">"Wallapatta" is a </span><a id="wallapatta_40089" class="link" href="http://www.dwc.gov.lk/index.php/en/wildlife-news1/228-walla-patta-gyrinops-walla-the-tree-to-preserv">tree in Sri Lanka</a><span id="wallapatta_40090" class="text">, that contains </span><a id="wallapatta_40091" class="link" href="http://en.wikipedia.org/wiki/Agarwood">Agarwood</a><span id="wallapatta_40092" class="text">.</span></p></div></div></div><div id="wallapatta_40008" class="sidenote"><div id="wallapatta_40009" class="section"><div class="content"><p id="wallapatta_40010" class="paragraph"><sup id="wallapatta_40107" class="superScript"><span id="wallapatta_40108" class="text">1</span></sup><span id="wallapatta_40109" class="text"> </span><a id="wallapatta_40110" class="link" href="http://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=0000hB">Book design: advice and examples - edwardtufte.com</a></p></div></div></div><div id="wallapatta_40015" class="sidenote"><div id="wallapatta_40016" class="html"><iframe src="https://ghbtns.com/github-btn.html?user=vpj&amp;repo=wallapatta&amp;type=star&amp;count=true&amp;size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>

</div></div><div id="wallapatta_40057" class="sidenote"><div id="wallapatta_40058" class="section"><h3 class="heading"><span id="wallapatta_40059" class="block"><span id="wallapatta_40170" class="text">Heading 1</span></span></h3><div class="content"><div id="wallapatta_40060" class="section"><div class="content"><p id="wallapatta_40061" class="paragraph"><span id="wallapatta_40171" class="text">Introduction to </span><strong id="wallapatta_40172" class="bold"><span id="wallapatta_40173" class="text">Heading 1</span></strong></p></div></div><ul id="wallapatta_40062" class="list"><li id="wallapatta_40063" class="list-item"><span id="wallapatta_40064" class="block"><span id="wallapatta_40174" class="text">Point one</span></span><div id="wallapatta_40065" class="section"><div class="content"><p id="wallapatta_40066" class="paragraph"><span id="wallapatta_40175" class="text">Description about point one</span></p></div></div></li><li id="wallapatta_40067" class="list-item"><span id="wallapatta_40068" class="block"><span id="wallapatta_40176" class="text">Point two</span></span></li></ul><div id="wallapatta_40069" class="section"><h4 class="heading"><span id="wallapatta_40070" class="block"><span id="wallapatta_40177" class="text">Subtopic</span></span></h4><div class="content"><div id="wallapatta_40071" class="section"><div class="content"><p id="wallapatta_40072" class="paragraph"><span id="wallapatta_40178" class="text">Subtopic content</span></p></div></div></div></div><div id="wallapatta_40073" class="section"><div class="content"><p id="wallapatta_40074" class="paragraph"><span id="wallapatta_40179" class="text">This belongs to Heading 1</span></p></div></div></div></div></div>
     </div>
     <div style="display:none;">
      <div class='wallapatta-code'>I just started moving my blog from &lt;&lt;http://svbtle.com(Svbtle)&gt;&gt; to a static blog generated that I created. It is based on &lt;&lt;http://vpj.github.io/wallapatta/introduction.html(Wallapatta)&gt;&gt;. I wanted to get into svbtle when &lt;&lt;http://dcurt.is/codename-svbtle(Dustin started it)&gt;&gt;, and got invite a little before they opened it to the public. And it's sad to part ways.

&gt;&gt;&gt;
 "Wallapatta" is a &lt;&lt;http://www.dwc.gov.lk/index.php/en/wildlife-news1/228-walla-patta-gyrinops-walla-the-tree-to-preserv(tree in Sri Lanka)&gt;&gt;, that contains &lt;&lt;http://en.wikipedia.org/wiki/Agarwood(Agarwood)&gt;&gt;.



Wallapatta is a
&lt;&lt;http://en.wikipedia.org/wiki/Markdown(Markdown)&gt;&gt; like syntax that can create documents with layouts
inspired by handouts of Edward R. Tufte^^1^^. We created it to use for documents. The two great things about Wallapatta is that it creates documents with **sidenotes** and **create print frindly documents** - &lt;&lt;http://vpj.github.io/wallapatta/introduction.html(Wallapatta editor)&gt;&gt; creates print layouts with intelligent page breaks by trying not to place breaks at middle of content like most word processing software do.

 &gt;&gt;&gt;
  ^^1^^ &lt;&lt;http://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=0000hB
  (Book design: advice and examples - edwardtufte.com)&gt;&gt;

I built in a simple blog generator into Wallapatta, for personal use. But it's super easy for anyone who wants to give it a go.

###How to start a Wallapatta blog?

 &gt;&gt;&gt;
  &lt;&lt;&lt;
   &lt;iframe src="https://ghbtns.com/github-btn.html?user=vpj&repo=wallapatta&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"&gt;&lt;/iframe&gt;


 It's pretty easy.

 - **Install &lt;&lt;https://nodejs.org/(Node.js&gt;&gt;

  NPM usually comes with Node.js. Visit &lt;&lt;https://nodejs.org/&gt;&gt; and see installation instructions. It's usually a download and install, unless you want it installed through a package manager like ``brew``.

 - **Install &lt;&lt;https://www.npmjs.com/package/wallapatta(Wallapatta node odule&gt;&gt;

  Run the following command in command line.

  ```
   npm install wallapatta -g

  That's it and you have wallapatta installed.

 - **Fork the &lt;&lt;https://github.com/vpj/wallapatta-blog-boilerplate(boilerplate)&gt;&gt;

  Make a fork of the git repositors on github: &lt;&lt;https://github.com/vpj/wallapatta-blog-boilerplate&gt;&gt;

  This repo contains this blog post, and 3 empty blog posts, a configuration file and templates for blog.

  Edit ``templates/post.coffee`` to change the post template and ``templates/blog.coffee`` to change the blog template. Compile these &lt;&lt;http://coffeescript.org/(coffeescript&gt;&gt; code to javascript by running ``coffee -c *``.

  You will have to change the name of the blog, which is "Varuna Jayasiri" in the two tamplate files. And also the Google Analytics code.

  Change ``blog.yaml`` to edit blog configurations like the order of posts, post titles, dates, etc.

 - **Generate the blog

  ```
   wallapatta --blog blog.yaml --output [output_directory] --static

  The above command will create the html files on the ``output_directory`` provided. ``--static`` specifies that it should copy Wallapatta rendering tools to the folder. (You can omit this if you change the templates to get these from a CDN).

  ``blog.css`` file on the boilerplate repository contains some css. This file is used in default templates. So you need to copy them to the ``output_directory``.

 - **That is it!


###What is Wallapatta syntax?

 It looks like this.

 ```
  ###Heading 1

   Introduction to **Heading 1**

   * Point one

    Description about point one

   * Point two

   ####Subtopic

    Subtopic content

   This belongs to Heading 1

 &gt;&gt;&gt;
  ###Heading 1

   Introduction to **Heading 1**

   * Point one

    Description about point one

   * Point two

   ####Subtopic

    Subtopic content

   This belongs to Heading 1

 It uses indentation to identify what belong where. Indentation is required for specifying content for components like lists, code blocks, special blocks, etc as well. So it's more of a programmer friendly syntax. Indentation helps while working with large documents because you can do stuff like **code folding**.

 We've changed some of the syntax from Markdown; for instance, ``&lt;&lt;`` and ``&gt;&gt;`` are used for links instead of ``[]()``, because we felt that it's a little more
 intuitive due to its resemblence with HTML tags.

 &lt;&lt;http://vpj.github.io/wallapatta/reference.html(Read the Wallapatta reference)&gt;&gt; for a detailed description on each component, including examples for usage.
</div>
     </div>
     <div class="overlay ">
      
     </div>
    </div>
   </div>
   <div class="wallapatta ">
    <h1 class="title ">
     <a href="node_shm.html">
      Shared memory with Node.js
     </a>
    </h1>
    <h3 class="date ">
     May 13, 2015
    </h3>
    <div class="post-paginated ">
     <div class="wallapatta-main nine columns ">
      <div id="wallapatta_50000" class="article"><div id="wallapatta_50001" class="section"><div class="content"><p id="wallapatta_50002" class="paragraph"><span id="wallapatta_50092" class="text">This is more like a tutorial on writing a simple node.js add-on to share memory among node.js processes.</span></p></div></div><div id="wallapatta_50003" class="section"><div class="content"><p id="wallapatta_50004" class="paragraph"><span id="wallapatta_50093" class="text">One of the limitations of node.js/io.js is that they are single threaded. Only way to use multiple cores in the processor is to run multiple processes</span><sup id="wallapatta_50094" class="superScript"><span id="wallapatta_50095" class="text">1</span></sup><span id="wallapatta_50096" class="text">. But then you are working on different memory spaces. So it doesn't help if you want multiple processes working on  the same memory block. This is required in memory intensive tasks that cannot be efficiently sharded.</span></p></div></div><div id="wallapatta_50008" class="section"><div class="content"><p id="wallapatta_50009" class="paragraph"><span id="wallapatta_50102" class="text">All the source code is available in </span><a id="wallapatta_50103" class="link" href="https://github.com/vpj/node_shm">Github</a><span id="wallapatta_50104" class="text">.</span></p></div></div><div id="wallapatta_50010" class="section"><h1 class="heading"><span id="wallapatta_50011" class="block"><span id="wallapatta_50105" class="text">Node addon</span></span></h1><div class="content"><div id="wallapatta_50012" class="section"><div class="content"><p id="wallapatta_50013" class="paragraph"><span id="wallapatta_50106" class="text">You need </span><code id="wallapatta_50107" class="code"><span id="wallapatta_50108" class="text">node-gyp</span></code><span id="wallapatta_50109" class="text"> installed to build the node module.</span></p></div></div><pre id="wallapatta_50014" class="codeBlock"><code class="nohighlight">npm install node-gyp -g</code></pre><div id="wallapatta_50015" class="section"><div class="content"><p id="wallapatta_50016" class="paragraph"><span id="wallapatta_50110" class="text">I think the node.js version matters as the addon api has changed. I was working on node </span><em id="wallapatta_50111" class="italics"><span id="wallapatta_50112" class="text">0.12.2</span></em><span id="wallapatta_50113" class="text">, when I tested this out.</span></p></div></div><div id="wallapatta_50017" class="section"><div class="content"><p id="wallapatta_50018" class="paragraph"><code id="wallapatta_50114" class="code"><span id="wallapatta_50115" class="text">binding.gyp</span></code><span id="wallapatta_50116" class="text"> is required by node-gyp to build the addon.</span></p></div></div><div id="wallapatta_50019" class="section"><div class="content"><p id="wallapatta_50020" class="paragraph"><span id="wallapatta_50117" class="text">Then comes </span><code id="wallapatta_50118" class="code"><span id="wallapatta_50119" class="text">shm_addon.cpp</span></code><span id="wallapatta_50120" class="text">. This is a very basic addon that has one export </span><code id="wallapatta_50121" class="code"><span id="wallapatta_50122" class="text">createSHM</span></code><span id="wallapatta_50123" class="text">, which creates a shared memory block of 800,000 bytes (attaches if exists) with read &amp; write permission to all users</span><sup id="wallapatta_50124" class="superScript"><span id="wallapatta_50125" class="text">2</span></sup><span id="wallapatta_50126" class="text">.</span></p></div></div><div id="wallapatta_50024" class="section"><div class="content"><p id="wallapatta_50025" class="paragraph"><span id="wallapatta_50140" class="text">Shared memory is allocated with </span><code id="wallapatta_50141" class="code"><span id="wallapatta_50142" class="text">shmget</span></code><span id="wallapatta_50143" class="text"> and attached to the address space of the process with </span><code id="wallapatta_50144" class="code"><span id="wallapatta_50145" class="text">shmat</span></code><span id="wallapatta_50146" class="text">.</span></p></div></div><pre id="wallapatta_50026" class="codeBlock"><code class="cpp">shmid = shmget( key, MEM, IPC_CREAT | <span class="hljs-number">0666</span> );
data = (<span class="hljs-keyword">char</span> *)shmat( shmid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span> );</code></pre><div id="wallapatta_50027" class="section"><div class="content"><p id="wallapatta_50028" class="paragraph"><span id="wallapatta_50147" class="text">It keeps a pointer to the memory block and returns it if </span><code id="wallapatta_50148" class="code"><span id="wallapatta_50149" class="text">createSHM</span></code><span id="wallapatta_50150" class="text"> is called twice by the same node.js program</span><sup id="wallapatta_50151" class="superScript"><span id="wallapatta_50152" class="text">3</span></sup><span id="wallapatta_50153" class="text">. </span><code id="wallapatta_50154" class="code"><span id="wallapatta_50155" class="text">createSHM</span></code><span id="wallapatta_50156" class="text"> returns an </span><code id="wallapatta_50157" class="code"><span id="wallapatta_50158" class="text">ArrayBuffer</span></code><span id="wallapatta_50159" class="text">, initialized with the pointer to the shared memory.</span></p></div></div><pre id="wallapatta_50032" class="codeBlock"><code class="cpp">Local&lt;ArrayBuffer&gt; buffer = ArrayBuffer::New(isolate, (<span class="hljs-keyword">void</span> *)data, MEM);</code></pre><div id="wallapatta_50033" class="section"><div class="content"><p id="wallapatta_50034" class="paragraph"><span id="wallapatta_50174" class="text">The node module </span><code id="wallapatta_50175" class="code"><span id="wallapatta_50176" class="text">shm_addon</span></code><span id="wallapatta_50177" class="text"> is built with node-gyp with following commands.</span></p></div></div><pre id="wallapatta_50035" class="codeBlock"><code class="nohighlight">node-gyp configure
node-gyp build</code></pre><div id="wallapatta_50036" class="section"><div class="content"><p id="wallapatta_50037" class="paragraph"><span id="wallapatta_50178" class="text">The node addon will be created in </span><code id="wallapatta_50179" class="code"><span id="wallapatta_50180" class="text">build/Release/shm_addon.node</span></code><span id="wallapatta_50181" class="text">.</span></p></div></div></div></div><div id="wallapatta_50038" class="section"><h1 class="heading"><span id="wallapatta_50039" class="block"><span id="wallapatta_50182" class="text">Parent and child programs</span></span></h1><div class="content"><div id="wallapatta_50040" class="section"><div class="content"><p id="wallapatta_50041" class="paragraph"><span id="wallapatta_50183" class="text">This is a simple counting problem to illustrate how shared memory can be used. We will populate the array of 200,000 32-bit integers with the sequence </span><code id="wallapatta_50184" class="code"><span id="wallapatta_50185" class="text">0,1,2,...998,999,0,1,2,..998,999,0,1,2,...</span></code><span id="wallapatta_50186" class="text">. So there are 200 positions with each integer between 0 and 999. Each of the child programs (workers) will count the number of occurrences of each integer between 0 and 999 by inefficiently traversing the array a 1,000 times.</span></p></div></div><div id="wallapatta_50045" class="section"><div class="content"><p id="wallapatta_50046" class="paragraph"><code id="wallapatta_50190" class="code"><span id="wallapatta_50191" class="text">spawn.coffee</span></code><span id="wallapatta_50192" class="text"> is the parent program that starts the child processes. </span><code id="wallapatta_50193" class="code"><span id="wallapatta_50194" class="text">child.coffee</span></code><span id="wallapatta_50195" class="text"> is the child program.</span></p></div></div><div id="wallapatta_50047" class="section"><div class="content"><p id="wallapatta_50048" class="paragraph"><span id="wallapatta_50196" class="text">Shared memory is attached by parent program and child program by calling the node addon.</span></p></div></div><pre id="wallapatta_50049" class="codeBlock"><code class="coffee">shm = <span class="hljs-built_in">require</span> <span class="hljs-string">'./build/Release/shm_addon'</span>
a = <span class="hljs-keyword">new</span> Int32Array shm.createSHM()</code></pre><div id="wallapatta_50050" class="section"><div class="content"><p id="wallapatta_50051" class="paragraph"><span id="wallapatta_50197" class="text">We are calculating the time taken for the child processes to count. Time it takes for processes to get spawn and exit is excluded. Therefore the child processes start counting when they receive something in the </span><em id="wallapatta_50198" class="italics"><span id="wallapatta_50199" class="text">standard input</span></em><span id="wallapatta_50200" class="text">. Number of child processes can be set with </span><code id="wallapatta_50201" class="code"><span id="wallapatta_50202" class="text">CHILDREN</span></code><span id="wallapatta_50203" class="text">.</span></p></div></div><pre id="wallapatta_50052" class="codeBlock"><code class="coffee">process.stdin.<span class="hljs-literal">on</span> <span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-params">(msg)</span> -&gt;</span>
start()</code></pre><div id="wallapatta_50053" class="section"><div class="content"><p id="wallapatta_50054" class="paragraph"><span id="wallapatta_50204" class="text">Running </span><code id="wallapatta_50205" class="code"><span id="wallapatta_50206" class="text">coffee spawn.coffee</span></code><span id="wallapatta_50207" class="text"> will start processes and do the counting and show the time it took to complete.</span></p></div></div><div id="wallapatta_50055" class="section"><div class="content"><p id="wallapatta_50056" class="paragraph"><span id="wallapatta_50208" class="text">You can take a look at shared memory allocated by running command </span><code id="wallapatta_50209" class="code"><span id="wallapatta_50210" class="text">ipcs</span></code><span id="wallapatta_50211" class="text">.</span></p></div></div><pre id="wallapatta_50057" class="codeBlock"><code class="nohighlight">IPC status from &lt;running system&gt; as of Tue Apr 14 13:58:16 IST 2015
T     ID     KEY        MODE       OWNER    GROUP
Shared Memory:
m  65536 0x000019a5 --rw-rw-rw- varunajayasiri    staff
m  65537 0x000019a4 --rw-rw-rw- varunajayasiri    staff
m  65538 0x000019a2 --rw-rw-rw- varunajayasiri    staff</code></pre></div></div><div id="wallapatta_50058" class="section"><h1 class="heading"><span id="wallapatta_50059" class="block"><span id="wallapatta_50212" class="text">Results</span></span></h1><div class="content"><div id="wallapatta_50060" class="section"><div class="content"><p id="wallapatta_50061" class="paragraph"><code id="wallapatta_50213" class="code"><span id="wallapatta_50214" class="text">bench.coffee</span></code><span id="wallapatta_50215" class="text"> was used to find the time a single process takes to count.</span></p></div></div><div id="wallapatta_50062" class="section"><div class="content"><p id="wallapatta_50063" class="paragraph"><a id="wallapatta_50216" class="link" href="https://twitter.com/chethiyaa">@chethiyaa</a><span id="wallapatta_50217" class="text"> did some testing on a </span><strong id="wallapatta_50218" class="bold"><span id="wallapatta_50219" class="text">quad core i7</span></strong><span id="wallapatta_50220" class="text">.</span></p></div></div><table id="wallapatta_50064" class="table"><thead><tr><th colspan="1"><span id="wallapatta_50065" class="block"><span id="wallapatta_50221" class="text"># children</span></span></th><th colspan="1"><span id="wallapatta_50066" class="block"><span id="wallapatta_50222" class="text">single process (ms)</span></span></th><th colspan="2"><span id="wallapatta_50067" class="block"><span id="wallapatta_50223" class="text">multi process (ms)</span></span></th></tr></thead><tbody><tr><td colspan="1"><span id="wallapatta_50068" class="block"><span id="wallapatta_50224" class="text">1</span></span></td><td colspan="1"><span id="wallapatta_50069" class="block"><span id="wallapatta_50225" class="text">398</span></span></td><td colspan="2"><span id="wallapatta_50070" class="block"><span id="wallapatta_50226" class="text">430</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_50071" class="block"><span id="wallapatta_50227" class="text">2</span></span></td><td colspan="1"><span id="wallapatta_50072" class="block"><span id="wallapatta_50228" class="text">782</span></span></td><td colspan="2"><span id="wallapatta_50073" class="block"><span id="wallapatta_50229" class="text">394</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_50074" class="block"><span id="wallapatta_50230" class="text">4</span></span></td><td colspan="1"><span id="wallapatta_50075" class="block"><span id="wallapatta_50231" class="text">1626</span></span></td><td colspan="2"><span id="wallapatta_50076" class="block"><span id="wallapatta_50232" class="text">415</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_50077" class="block"><span id="wallapatta_50233" class="text">8</span></span></td><td colspan="1"><span id="wallapatta_50078" class="block"><span id="wallapatta_50234" class="text">3300</span></span></td><td colspan="2"><span id="wallapatta_50079" class="block"><span id="wallapatta_50235" class="text">799</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_50080" class="block"><span id="wallapatta_50236" class="text">16</span></span></td><td colspan="1"><span id="wallapatta_50081" class="block"><span id="wallapatta_50237" class="text">6285</span></span></td><td colspan="2"><span id="wallapatta_50082" class="block"><span id="wallapatta_50238" class="text">1594</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_50083" class="block"><span id="wallapatta_50239" class="text">32</span></span></td><td colspan="1"><span id="wallapatta_50084" class="block"></span></td><td colspan="2"><span id="wallapatta_50085" class="block"><span id="wallapatta_50240" class="text">3183</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_50086" class="block"><span id="wallapatta_50241" class="text">64</span></span></td><td colspan="1"><span id="wallapatta_50087" class="block"></span></td><td colspan="2"><span id="wallapatta_50088" class="block"><span id="wallapatta_50242" class="text">6372</span></span></td></tr><tr><td colspan="1"><span id="wallapatta_50089" class="block"><span id="wallapatta_50243" class="text">128</span></span></td><td colspan="1"><span id="wallapatta_50090" class="block"></span></td><td colspan="2"><span id="wallapatta_50091" class="block"><span id="wallapatta_50244" class="text">13049</span></span></td></tr></tbody></table></div></div></div>
     </div>
     <div class="wallapatta-sidebar three columns ">
      <div id="wallapatta_50005" class="sidenote"><div id="wallapatta_50006" class="section"><div class="content"><p id="wallapatta_50007" class="paragraph"><sup id="wallapatta_50097" class="superScript"><span id="wallapatta_50098" class="text">1</span></sup><span id="wallapatta_50099" class="text"> Node modules like </span><a id="wallapatta_50100" class="link" href="http://adambom.github.io/parallel.js/">parallel.js</a><span id="wallapatta_50101" class="text"> fork new processes when on node  and use web workers on browser.</span></p></div></div></div><div id="wallapatta_50021" class="sidenote"><div id="wallapatta_50022" class="section"><div class="content"><p id="wallapatta_50023" class="paragraph"><sup id="wallapatta_50127" class="superScript"><span id="wallapatta_50128" class="text">2</span></sup><span id="wallapatta_50129" class="text"> </span><code id="wallapatta_50130" class="code"><span id="wallapatta_50131" class="text">shmget</span></code><span id="wallapatta_50132" class="text"> (</span><a id="wallapatta_50133" class="link" href="http://man7.org/linux/man-pages/man2/shmget.2.html">documentation</a><span id="wallapatta_50134" class="text">) allocates shared memory and </span><code id="wallapatta_50135" class="code"><span id="wallapatta_50136" class="text">shmat</span></code><span id="wallapatta_50137" class="text"> (</span><a id="wallapatta_50138" class="link" href="http://man7.org/linux/man-pages/man2/shmat.2.html">documentation</a><span id="wallapatta_50139" class="text">) attaches the shared memory block.</span></p></div></div></div><div id="wallapatta_50029" class="sidenote"><div id="wallapatta_50030" class="section"><div class="content"><p id="wallapatta_50031" class="paragraph"><sup id="wallapatta_50160" class="superScript"><span id="wallapatta_50161" class="text">3</span></sup><span id="wallapatta_50162" class="text"> Since the </span><code id="wallapatta_50163" class="code"><span id="wallapatta_50164" class="text">ArrayBuffer</span></code><span id="wallapatta_50165" class="text"> is constructed with a memory pointer, it will be </span><code id="wallapatta_50166" class="code"><span id="wallapatta_50167" class="text">external</span></code><span id="wallapatta_50168" class="text">. That is the memory will not be garbage collected and the addon will have to free the memory. Here's the </span><strong id="wallapatta_50169" class="bold"><span id="wallapatta_50170" class="text">v8</span></strong><span id="wallapatta_50171" class="text"> documentation to </span><a id="wallapatta_50172" class="link" href="http://bespin.cz/~ondras/html/classv8_1_1ArrayBuffer.html">ArrayBuffer</a><span id="wallapatta_50173" class="text">.</span></p></div></div></div><div id="wallapatta_50042" class="sidenote"><div id="wallapatta_50043" class="section"><div class="content"><p id="wallapatta_50044" class="paragraph"><span id="wallapatta_50187" class="text">Shared memory limits are quite small by default. So trying to allocate a lot of shared memory will give errors. This </span><a id="wallapatta_50188" class="link" href="http://seriousbirder.com/blogs/linux-understanding-shmmax-and-shmall-settings/">article</a><span id="wallapatta_50189" class="text"> gives details on changing and viewing these settings.</span></p></div></div></div>
     </div>
     <div style="display:none;">
      <div class='wallapatta-code'>
This is more like a tutorial on writing a simple node.js add-on to share memory among node.js processes.

One of the limitations of node.js/io.js is that they are single threaded. Only way to use multiple cores in the processor is to run multiple processes^^1^^. But then you are working on different memory spaces. So it doesn't help if you want multiple processes working on  the same memory block. This is required in memory intensive tasks that cannot be efficiently sharded.

&gt;&gt;&gt;
 ^^1^^ Node modules like &lt;&lt;http://adambom.github.io/parallel.js/(parallel.js)&gt;&gt; fork new processes when on node  and use web workers on browser.

All the source code is available in &lt;&lt;https://github.com/vpj/node_shm(Github)&gt;&gt;.

#Node addon

 You need ``node-gyp`` installed to build the node module.

 ```
  npm install node-gyp -g

 I think the node.js version matters as the addon api has changed. I was working on node --0.12.2--, when I tested this out.

 ``binding.gyp`` is required by node-gyp to build the addon.

 Then comes ``shm_addon.cpp``. This is a very basic addon that has one export ``createSHM``, which creates a shared memory block of 800,000 bytes (attaches if exists) with read & write permission to all users^^2^^.

 &gt;&gt;&gt;
  ^^2^^ ``shmget`` (&lt;&lt;http://man7.org/linux/man-pages/man2/shmget.2.html(documentation)&gt;&gt;) allocates shared memory and ``shmat`` (&lt;&lt;http://man7.org/linux/man-pages/man2/shmat.2.html(documentation)&gt;&gt;) attaches the shared memory block.


 Shared memory is allocated with ``shmget`` and attached to the address space of the process with ``shmat``.

 ```cpp
  shmid = shmget( key, MEM, IPC_CREAT | 0666 );
  data = (char *)shmat( shmid, NULL, 0 );

 It keeps a pointer to the memory block and returns it if ``createSHM`` is called twice by the same node.js program^^3^^. ``createSHM`` returns an ``ArrayBuffer``, initialized with the pointer to the shared memory.

 &gt;&gt;&gt;
  ^^3^^ Since the ``ArrayBuffer`` is constructed with a memory pointer, it will be ``external``. That is the memory will not be garbage collected and the addon will have to free the memory. Here's the **v8** documentation to &lt;&lt;http://bespin.cz/~ondras/html/classv8_1_1ArrayBuffer.html(ArrayBuffer)&gt;&gt;.

 ```cpp
  Local&lt;ArrayBuffer&gt; buffer = ArrayBuffer::New(isolate, (void *)data, MEM);

 The node module ``shm_addon`` is built with node-gyp with following commands.

 ```
  node-gyp configure
  node-gyp build

 The node addon will be created in ``build/Release/shm_addon.node``.

#Parent and child programs

 This is a simple counting problem to illustrate how shared memory can be used. We will populate the array of 200,000 32-bit integers with the sequence
 ``0,1,2,...998,999,0,1,2,..998,999,0,1,2,...``. So there are 200 positions with each integer between 0 and 999. Each of the child programs (workers) will count the number of occurrences of each integer between 0 and 999 by inefficiently traversing the array a 1,000 times.

 &gt;&gt;&gt;
  Shared memory limits are quite small by default. So trying to allocate a lot of shared memory will give errors. This &lt;&lt;http://seriousbirder.com/blogs/linux-understanding-shmmax-and-shmall-settings/(article)&gt;&gt; gives details on changing and viewing these settings.


 ``spawn.coffee`` is the parent program that starts the child processes. ``child.coffee`` is the child program.

 Shared memory is attached by parent program and child program by calling the node addon.

 ```coffee
  shm = require './build/Release/shm_addon'
  a = new Int32Array shm.createSHM()

 We are calculating the time taken for the child processes to count. Time it takes for processes to get spawn and exit is excluded. Therefore the child processes start counting when they receive something in the --standard input--. Number of child processes can be set with ``CHILDREN``.

 ```coffee
  process.stdin.on 'data', (msg) -&gt;
  start()

 Running ``coffee spawn.coffee`` will start processes and do the counting and show the time it took to complete.

 You can take a look at shared memory allocated by running command ``ipcs``.

 ```
  IPC status from &lt;running system&gt; as of Tue Apr 14 13:58:16 IST 2015
  T     ID     KEY        MODE       OWNER    GROUP
  Shared Memory:
  m  65536 0x000019a5 --rw-rw-rw- varunajayasiri    staff
  m  65537 0x000019a4 --rw-rw-rw- varunajayasiri    staff
  m  65538 0x000019a2 --rw-rw-rw- varunajayasiri    staff

#Results

 ``bench.coffee`` was used to find the time a single process takes to count.

 &lt;&lt;https://twitter.com/chethiyaa(@chethiyaa)&gt;&gt; did some testing on a **quad core i7**.


 |||
  | # children | single process (ms) | multi process (ms) |
  ===
  | 1 | 398 | 430 |
  | 2 | 782 | 394 |
  | 4 | 1626 | 415 |
  | 8 | 3300 | 799 |
  | 16 | 6285 | 1594 |
  | 32 | | 3183 |
  | 64 | | 6372 |
  | 128	 | | 13049 |

</div>
     </div>
     <div class="overlay ">
      
     </div>
    </div>
   </div>
   <div class="paginate ">
    <a class="next-page button " href="page2.html">
     next
    </a>
   </div>
  </div>
  <script src="lib/highlightjs/highlight.pack.js">
  </script>
  <script src="lib/weya/weya.js">
  </script>
  <script src="lib/weya/base.js">
  </script>
  <script src="lib/mod/mod.js">
  </script>
  <script src="js/static.js?v=9">
  </script>
  <script src="js/parser.js?v=9">
  </script>
  <script src="js/reader.js?v=9">
  </script>
  <script src="js/nodes.js?v=9">
  </script>
  <script src="js/render.js?v=9">
  </script>
 </body>
</html>
